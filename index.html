<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiGenio - Tu aliado en el aprendizaje</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #3f68a2; /* Azul más suave */
      --secondary-color: #6ed3b3; /* Azul verdoso del logo */
      --accent-color: #f39c12; /* Naranja para énfasis */
      --text-dark: #34495e;
      --text-light: #5e6c7d;
      --bg-light: #f8f9fa;
      --bg-white: #ffffff;
      --shadow-light: rgba(0, 0, 0, 0.08);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --border-radius: 10px;
      --spacing-unit: 20px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-light);
      color: var(--text-light);
      line-height: 1.7;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Asegura que el footer esté al final */
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #345c8c 100%); /* Gradiente azul más profesional */
      color: var(--bg-white);
      padding: calc(2 * var(--spacing-unit)) var(--spacing-unit);
      text-align: center;
      box-shadow: 0 4px 20px var(--shadow-medium);
      position: relative; /* Para el chatbot */
      z-index: 10; /* Para asegurar que esté encima de otros elementos */
    }
    header .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: var(--spacing-unit);
    }
    header .logo-container img {
      height: 90px; /* Tamaño del logo un poco más grande */
      width: auto;
    }
    header h1 {
      font-size: 3.5em; /* Fuente más grande para el título principal */
      margin: 0;
      font-weight: 800; /* Más audaz */
      line-height: 1;
    }
    header p {
      font-size: 1.4em;
      margin-top: 10px;
      font-weight: 300;
    }

    /* Navigation */
    nav {
      background: var(--secondary-color);
      display: flex;
      justify-content: center;
      padding: var(--spacing-unit) 0;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
      flex-wrap: wrap;
      gap: 10px; /* Espaciado entre elementos de navegación */
      position: sticky; /* Sticky navigation */
      top: 0;
      z-index: 100; /* Asegura que la nav esté por encima */
    }
    nav a, nav button {
      color: var(--bg-white);
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1em;
      padding: 8px 18px; /* Padding ajustado para un mejor aspecto */
      border-radius: var(--border-radius); /* Bordes redondeados para los botones */
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      background: none;
      border: none;
      cursor: pointer;
      display: flex; /* Para centrar texto si es necesario */
      align-items: center;
      justify-content: center;
      box-shadow: none; /* Elimina la sombra por defecto de los botones */
    }
    nav a:hover, nav button:hover {
      background: rgba(255, 255, 255, 0.2); /* Fondo sutil al pasar el ratón */
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    nav a.disabled {
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
      border-bottom: none;
      background: none;
      box-shadow: none;
    }

    /* Hero Section */
    .hero {
      padding: calc(4 * var(--spacing-unit)) var(--spacing-unit);
      text-align: center;
      background: linear-gradient(to bottom right, #e0f7fa, #f0f8ff);
      color: var(--text-dark);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
    }
    .hero h1 {
      font-size: 3.8em; /* Más grande y llamativo */
      margin-bottom: var(--spacing-unit);
      font-weight: 800;
      color: var(--primary-color);
      line-height: 1.1;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .hero p {
      font-size: 1.6em;
      color: var(--text-light);
      max-width: 800px;
      margin: var(--spacing-unit) auto 0;
      font-weight: 400;
    }

    /* Sections */
    .section {
      padding: calc(3 * var(--spacing-unit)) var(--spacing-unit);
      max-width: 1100px;
      margin: 0 auto;
      background: var(--bg-white); /* Fondo blanco para las secciones */
      border-radius: var(--border-radius);
      margin-top: calc(2 * var(--spacing-unit)); /* Espaciado entre secciones */
      box-shadow: 0 4px 20px var(--shadow-light);
    }
    .section:first-of-type {
        margin-top: 0; /* La primera sección no tiene margen superior si va justo después del hero */
    }
    .section h2, .section h3 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: calc(1.5 * var(--spacing-unit));
      font-size: 3em; /* Títulos de sección más grandes */
      font-weight: 800;
      position: relative;
    }
    .section h2::after, .section h3::after {
        content: '';
        display: block;
        width: 100px; /* Línea un poco más larga */
        height: 5px; /* Línea más gruesa */
        background: var(--secondary-color);
        margin: var(--spacing-unit) auto 0;
        border-radius: 3px;
    }
    .section p {
        font-size: 1.15em;
        margin-bottom: 1.7em;
        color: var(--text-dark); /* Texto más oscuro para mejor legibilidad */
        text-align: justify; /* Justificado para un aspecto más profesional */
    }
    .section ul {
        list-style: none;
        padding-left: 0;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: var(--spacing-unit);
        margin-top: calc(1.5 * var(--spacing-unit));
    }
    .section ul li {
        background: var(--bg-light); /* Fondo ligeramente diferente para los items de lista */
        padding: var(--spacing-unit) calc(1.5 * var(--spacing-unit));
        border-radius: var(--border-radius);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        font-size: 1.2em;
        color: var(--text-dark);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.3s ease, background 0.3s ease;
    }
    .section ul li:hover {
        transform: translateY(-5px);
        background: #e6f0f8; /* Ligeramente más azul al pasar el ratón */
    }
    .section ul li img { /* For icons in lists */
        height: 35px;
        width: 35px;
    }
    .section img { /* General images within sections */
      display: block;
      margin: var(--spacing-unit) auto calc(1.5 * var(--spacing-unit));
      border-radius: var(--border-radius);
      box-shadow: 0 8px 20px var(--shadow-light);
    }
    .section .text-center {
        text-align: center; /* Para centrar texto en parrafos específicos */
    }

    /* Cards */
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: calc(1.5 * var(--spacing-unit));
      margin-top: calc(1.5 * var(--spacing-unit));
    }
    .card {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px var(--shadow-medium);
      padding: calc(1.5 * var(--spacing-unit));
      width: 320px; /* Ancho ligeramente mayor para contenido */
      text-align: center;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start; /* Alinea contenido al inicio */
      min-height: 280px; /* Altura mínima para consistencia */
    }
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
    }
    .card img {
      width: 90px; /* Iconos más grandes para tarjetas */
      height: 90px;
      margin-bottom: var(--spacing-unit);
      transition: transform 0.3s ease;
    }
    .card:hover img {
        transform: scale(1.1);
    }
    .card h3 {
      font-size: 2em; /* Títulos de tarjeta más grandes */
      color: var(--primary-color);
      margin-bottom: 12px;
      font-weight: 700;
    }
    .card p {
      font-size: 1.05em;
      color: var(--text-light);
      line-height: 1.6;
      flex-grow: 1; /* Permite que el párrafo ocupe el espacio restante */
    }
    .clickable-card {
      cursor: pointer;
    }
    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(63, 104, 162, 0.98); /* Usar --primary-color con más opacidad */
      color: var(--bg-white);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-weight: 600;
      font-size: 1.6em;
      border-radius: var(--border-radius);
      padding: var(--spacing-unit); /* Para que el texto no toque los bordes */
      text-align: center;
    }
    .clickable-card:hover .card-overlay {
      opacity: 1;
    }

    /* Testimonials Section */
    .testimonial-card {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      padding: var(--spacing-unit);
      text-align: center;
      max-width: 350px;
      margin: var(--spacing-unit);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .testimonial-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .testimonial-card img {
      width: 70px;
      height: 70px;
      border-radius: 50%; /* Imágenes de perfil redondas */
      margin-bottom: 15px;
      border: 3px solid var(--secondary-color); /* Borde alrededor de la imagen */
    }
    .testimonial-card h3 {
      color: var(--primary-color);
      font-size: 1.5em;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .testimonial-card p {
      font-style: italic;
      color: var(--text-dark);
      margin-bottom: 15px;
      flex-grow: 1;
    }
    .testimonial-card .rating {
      color: var(--accent-color);
      font-size: 1.2em;
    }
    /* New: Review Section */
    #reviews-section {
        background: linear-gradient(135deg, #f0f8ff, #e0f7fa); /* Fondo suave */
        padding: calc(3 * var(--spacing-unit)) var(--spacing-unit);
        text-align: center;
    }
    #reviews-section h2 {
        color: var(--primary-color);
        font-size: 3em;
        font-weight: 800;
        margin-bottom: calc(1.5 * var(--spacing-unit));
    }
    #reviews-section h2::after {
        background: var(--accent-color); /* Línea naranja para la sección de reseñas */
    }
    #reviews-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: calc(1.5 * var(--spacing-unit));
        max-width: 1200px;
        margin: 0 auto;
        padding-top: var(--spacing-unit);
    }
    .review-card {
        background: var(--bg-white);
        border-radius: var(--border-radius);
        box-shadow: 0 8px 25px var(--shadow-medium); /* Más pronunciada */
        padding: calc(1.5 * var(--spacing-unit)); /* Más padding */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: transform 0.4s ease, box-shadow 0.4s ease; /* Transiciones más suaves */
        min-height: 200px; /* Altura mínima para consistencia */
    }
    .review-card:hover {
        transform: translateY(-10px); /* Más elevación */
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2); /* Sombra más grande */
    }
    .review-card .reviewer-name {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.3em;
        margin-top: 10px;
        margin-bottom: 5px;
    }
    .review-card .review-text {
        font-size: 1.05em;
        color: var(--text-dark); /* Color más oscuro para legibilidad */
        font-style: italic;
        margin-bottom: 15px;
        flex-grow: 1; /* Permite que el texto ocupe espacio */
        line-height: 1.6;
    }
    .review-card .review-rating {
        color: var(--accent-color);
        font-size: 1.2em; /* Estrellas un poco más grandes */
        margin-top: 5px;
    }
    /* Review form styles */
    #submit-review-section .review-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 600px;
      margin: 30px auto;
      padding: calc(2 * var(--spacing-unit)); /* Más padding */
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px var(--shadow-medium); /* Sombra consistente */
    }
    #submit-review-section .review-form label {
        font-weight: 600;
        color: var(--text-dark);
        text-align: left;
        margin-bottom: 5px;
        font-size: 1.1em;
    }
    #submit-review-section .review-form textarea {
        width: calc(100% - 40px);
        padding: 15px 20px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-family: 'Poppins', sans-serif;
        font-size: 1em;
        min-height: 100px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        resize: vertical;
    }
    #submit-review-section .review-form .rating-stars {
        display: flex;
        justify-content: center;
        gap: 8px; /* Más espacio entre estrellas */
        margin-bottom: 20px;
    }
    #submit-review-section .review-form .rating-stars button {
        background: none;
        border: none;
        font-size: 3em; /* Estrellas más grandes en el formulario */
        cursor: pointer;
        color: #d1d1d1; /* Default star color */
        transition: color 0.2s ease, transform 0.1s ease;
    }
    #submit-review-section .review-form .rating-stars button:hover {
        transform: scale(1.1);
    }
    #submit-review-section .review-form .rating-stars button.selected {
        color: var(--accent-color); /* Selected star color */
    }
    #submit-review-section .review-form button[type="submit"] {
      background: var(--primary-color);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.2em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #submit-review-section .review-form button[type="submit"]:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }
    .review-message {
      text-align: center;
      font-size: 1.1em;
      color: var(--text-dark);
      margin-top: 20px;
      padding: 15px;
      background: #eef5fb;
      border-radius: var(--border-radius);
      border-left: 5px solid var(--secondary-color);
    }
    .review-submit-info {
        font-size: 0.95em;
        color: var(--text-light);
        margin-top: 15px;
    }

    /* Topic List specific styles for better spacing */
    .topic-list {
        margin-top: calc(2 * var(--spacing-unit));
    }
    .topic-list h2 {
        font-size: 2.5em; /* Ajuste para que los subtítulos de temario sean más grandes */
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: calc(1.5 * var(--spacing-unit));
        text-align: center;
    }
    .topic-item {
        background: var(--bg-white);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px var(--shadow-light);
        padding: calc(1.2 * var(--spacing-unit)); /* Más padding */
        margin-bottom: var(--spacing-unit); /* Espacio entre temas */
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Alinea contenido a la izquierda */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    .topic-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .topic-item .topic-title {
        font-size: 1.5em; /* Título del tema más grande */
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 8px;
        width: 100%; /* Asegura que ocupe todo el ancho */
        display: flex;
        justify-content: space-between; /* Para alinear el badge y el indicador */
        align-items: center;
    }
    .topic-item .level-badge {
        background: var(--secondary-color);
        color: white;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.8em;
        font-weight: 600;
        margin-left: 15px;
        white-space: nowrap; /* Evita que el texto del badge se rompa */
    }
    .topic-item .progress-indicator {
        font-size: 0.9em;
        color: var(--text-light);
        font-weight: 500;
        margin-left: auto; /* Empuja el indicador a la derecha */
    }
    .topic-item .topic-description {
        font-size: 1.05em;
        color: var(--text-light);
        line-height: 1.5;
        text-align: left;
    }


    /* Contact Form */
    .contact-form {
      text-align: center;
      background: var(--bg-white);
      padding: calc(2 * var(--spacing-unit));
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px var(--shadow-light);
      max-width: 700px;
      margin: var(--spacing-unit) auto;
    }
    .contact-form p {
      font-size: 1.1em;
      margin-bottom: var(--spacing-unit);
      color: var(--text-dark);
    }
    .contact-form input,
    .contact-form textarea {
      width: calc(100% - 40px); /* Ajuste para padding */
      padding: 15px 20px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      color: var(--text-dark);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .contact-form input:focus,
    .contact-form textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(63, 104, 162, 0.2);
      outline: none;
    }
    .contact-form button {
      background: var(--primary-color);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.2em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: var(--spacing-unit);
    }
    .contact-form button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    /* Footer */
    footer {
      background: var(--primary-color);
      color: white;
      text-align: center;
      padding: var(--spacing-unit);
      margin-top: auto; /* Empuja el footer al final de la página */
      font-size: 0.95em;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Quiz Styles */
    #quiz-container {
      background: var(--bg-white);
      max-width: 600px; /* Ancho ligeramente mayor */
      margin: calc(3 * var(--spacing-unit)) auto;
      padding: calc(2 * var(--spacing-unit));
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px var(--shadow-medium);
    }
    #quiz-container h2 {
      color: var(--primary-color);
      margin-bottom: calc(1.5 * var(--spacing-unit));
      text-align: center;
      font-size: 2.5em; /* Título de quiz más grande */
      font-weight: 700;
    }
    .question {
      margin-bottom: var(--spacing-unit);
      font-weight: 600;
      font-size: 1.4em; /* Fuente de pregunta más grande */
      color: var(--text-dark);
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .options button {
      width: 100%;
      padding: 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.1em;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      text-align: left;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .options button:hover {
      background: var(--secondary-color);
      transform: translateY(-3px); /* Efecto de elevación */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    /* Result Styles */
    #result-message {
      font-weight: 700;
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      font-size: 1.6em; /* Mensaje de resultado más grande */
      background: #eef5fb;
      padding: 1.2 * var(--spacing-unit);
      border-radius: var(--border-radius);
      border-left: 6px solid var(--secondary-color); /* Borde más pronunciado */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    /* ADHD Recommendations */
    #tdah-warning {
      margin-top: calc(2.5 * var(--spacing-unit));
      padding: 1.5rem;
      background-color: #ffe0b2; /* Tono naranja suave */
      border-radius: var(--border-radius);
      color: #b35900;
      font-weight: 600;
      max-width: 750px;
      margin-left: auto;
      margin-right: auto;
      border-left: 6px solid var(--accent-color); /* Borde más pronunciado */
      font-size: 1.15em;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    #study-advice {
      max-width: 750px;
      margin: 0 auto calc(2 * var(--spacing-unit)) auto;
      font-weight: 600;
      color: var(--text-dark);
      padding: 1.5rem;
      background: var(--bg-white);
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-left: 6px solid var(--primary-color); /* Borde más pronunciado */
      font-size: 1.15em;
    }

    /* Progress Bar Styles */
    .progress-bar-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: calc(1.2 * var(--spacing-unit));
      height: 35px; /* Barra más alta */
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary-color); /* Green color for progress */
      width: 0%; /* Will be updated by JS */
      border-radius: var(--border-radius) 0 0 var(--border-radius);
      transition: width 0.5s ease-in-out;
    }
    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 35px;
      color: var(--text-dark);
      font-weight: 600;
      font-size: 1.05em;
    }

    /* Lesson Content Display */
    #lesson-content-display {
        background: var(--bg-white);
        max-width: 900px;
        margin: calc(3 * var(--spacing-unit)) auto;
        padding: calc(2 * var(--spacing-unit));
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px var(--shadow-medium);
        min-height: 500px;
    }
    #lesson-material h3 {
        color: var(--primary-color);
        font-size: 1.8em;
        margin-top: calc(1.5 * var(--spacing-unit));
        margin-bottom: var(--spacing-unit);
        font-weight: 700;
    }
    #lesson-material p {
        font-size: 1.1em;
        margin-bottom: 1.5em;
        color: var(--text-dark);
        text-align: justify;
    }
    #lesson-material video,
    #lesson-material audio,
    #lesson-material img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: var(--spacing-unit) auto;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    #lesson-material textarea {
        width: calc(100% - 40px);
        padding: 15px 20px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-family: 'Poppins', sans-serif;
        font-size: 1em;
        min-height: 120px;
        margin-top: 15px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        resize: vertical; /* Allow vertical resizing */
    }
    #lesson-material .interactive-game-placeholder {
        background-color: #eef5fb;
        border: 2px dashed var(--secondary-color);
        padding: calc(3 * var(--spacing-unit));
        text-align: center;
        font-style: italic;
        color: var(--text-light);
        border-radius: var(--border-radius);
        margin: calc(1.5 * var(--spacing-unit)) 0;
        font-size: 1.25em;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    #lesson-material button {
        background: var(--accent-color);
        color: white;
        padding: 14px 30px; /* Botón más grande */
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1.15em;
        font-weight: 600;
        transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        margin-top: calc(1.5 * var(--spacing-unit));
        box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3); /* Sombra para botones de acción */
    }
    #lesson-material button:hover {
        background: #e67e22;
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(243, 156, 18, 0.4);
    }

    /* Custom Message Box */
    #custom-message {
        position: fixed;
        top: var(--spacing-unit);
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        padding: 15px 30px;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        font-weight: 600;
    }
    #custom-message.show {
        opacity: 1;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Fondo más oscuro */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
    }
    .modal-overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    /* Authentication Form Styles (within modal) */
    #auth-container {
      background: var(--bg-white);
      max-width: 480px; /* Ancho un poco mayor para el modal */
      padding: calc(2 * var(--spacing-unit));
      border-radius: var(--border-radius);
      box-shadow: 0 10px 30px var(--shadow-medium);
      text-align: center;
      position: relative;
    }
    #auth-container h2 {
      color: var(--primary-color);
      margin-bottom: calc(1.5 * var(--spacing-unit));
      font-size: 2.4em;
      font-weight: 700;
    }
    #auth-container form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #auth-container input[type="email"],
    #auth-container input[type="password"] {
      width: calc(100% - 40px);
      padding: 16px 20px; /* Padding más grande */
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1.15em; /* Fuente más grande */
      color: var(--text-dark);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #auth-container input[type="email"]:focus,
    #auth-container input[type="password"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(63, 104, 162, 0.25); /* Sombra de foco más suave */
      outline: none;
    }
    #auth-container button {
      background: var(--primary-color);
      color: white;
      padding: 16px 25px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.25em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      margin-top: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #auth-container button:hover {
      background: var(--secondary-color);
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }
    #auth-container .toggle-form-link {
        font-size: 1em;
        margin-top: var(--spacing-unit);
        color: var(--text-light);
        cursor: pointer;
        text-decoration: underline;
    }
    #auth-container .toggle-form-link:hover {
        color: var(--primary-color);
    }
    .close-modal-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 2em; /* Icono más grande */
        color: var(--text-light);
        cursor: pointer;
        transition: color 0.3s ease, transform 0.2s ease;
    }
    .close-modal-button:hover {
        color: var(--primary-color);
        transform: rotate(90deg); /* Pequeña animación al cerrar */
    }


    /* Responsive adjustments */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2.5em;
      }
      header .logo-container img {
        height: 70px;
      }
      .hero h1 {
        font-size: 2.8em;
      }
      .hero p {
        font-size: 1.2em;
      }
      nav {
        flex-direction: column;
        align-items: center;
        padding: 10px;
      }
      nav a, nav button {
        margin: 5px 0;
        font-size: 1em;
        padding: 8px 15px;
      }
      .section h2, .section h3 {
        font-size: 2.2em;
      }
      .section p {
          text-align: left; /* Justificado puede ser demasiado en móvil */
      }
      .cards, .testimonials-grid {
        flex-direction: column;
        align-items: center;
      }
      .card, .testimonial-card {
        width: 95%;
        max-width: 400px; /* Un poco más ancho en móviles */
      }
      .contact-form input,
      .contact-form textarea {
        width: calc(100% - 20px);
        padding: 12px 10px;
      }
      #quiz-container, #lesson-content-display, #auth-container {
        margin: var(--spacing-unit) auto;
        padding: calc(1.5 * var(--spacing-unit));
      }
      #quiz-container h2 {
          font-size: 2em;
      }
      .question {
        font-size: 1.2em;
      }
      .review-card {
        margin: 10px auto; /* Centrar y añadir margen */
      }
    }
    @media (max-width: 480px) {
        header h1 {
            font-size: 2em;
        }
        .hero h1 {
            font-size: 2.2em;
        }
        .hero p {
            font-size: 1em;
        }
        .section h2, .section h3 {
            font-size: 1.8em;
        }
        .card {
            padding: var(--spacing-unit);
        }
        .card h3 {
            font-size: 1.5em;
        }
        .options button {
            font-size: 0.95em;
            padding: 12px;
        }
    }
  </style>
</head>
<body>

  <!-- Custom Message Box -->
  <div id="custom-message"></div>

  <!-- Authentication Modal -->
  <div id="auth-modal-overlay" class="modal-overlay">
    <div id="auth-container">
      <button class="close-modal-button" aria-label="Cerrar modal" onclick="window.hideAuthModal()">&times;</button>
      <div id="login-form">
        <h2>Iniciar Sesión</h2>
        <form id="login-email-form" aria-labelledby="login-heading">
          <input type="email" id="login-email" placeholder="Correo Electrónico" required autocomplete="email" aria-label="Correo electrónico" />
          <input type="password" id="login-password" placeholder="Contraseña" required autocomplete="current-password" aria-label="Contraseña" />
          <button type="submit">Iniciar Sesión</button>
        </form>
        <p class="toggle-form-link" role="button" tabindex="0" onclick="window.toggleAuthForm('register')" onkeypress="if(event.key === 'Enter') window.toggleAuthForm('register')">¿No tienes cuenta? Regístrate</p>
      </div>

      <div id="register-form" style="display: none;">
        <h2>Registrarse</h2>
        <form id="register-email-form" aria-labelledby="register-heading">
          <input type="email" id="register-email" placeholder="Correo Electrónico" required autocomplete="email" aria-label="Correo electrónico" />
          <input type="password" id="register-password" placeholder="Contraseña" required autocomplete="new-password" aria-label="Contraseña" />
          <button type="submit">Registrarse</button>
        </form>
        <p class="toggle-form-link" role="button" tabindex="0" onclick="window.toggleAuthForm('login')" onkeypress="if(event.key === 'Enter') window.toggleAuthForm('login')">¿Ya tienes cuenta? Inicia Sesión</p>
      </div>
    </div>
  </div>


  <div id="quiz-container" style="display: none;" role="main" aria-labelledby="quiz-heading">
    <h2 id="quiz-heading">Cuestionario de Estilo de Aprendizaje</h2>
    <div id="question-text" class="question"></div>
    <div id="options" class="options"></div>
  </div>

  <div id="main-content" role="main">
    <header>
      <div class="logo-container">
        <img src="https://placehold.co/90x90/6ed3b3/ffffff?text=MG" alt="Logo de MultiGenio, iniciales MG" />
        <h1>MultiGenio</h1>
      </div>
      <p>Tu aliado en el aprendizaje</p>
      <div id="user-id-display" style="display: none;" aria-live="polite"></div>
    </header>

    <nav aria-label="Navegación principal">
      <a href="#que-es">¿Qué es?</a>
      <a href="#materias">Materias</a>
      <a href="#beneficios">Beneficios</a>
      <a href="#testimonios">Testimonios</a>
      <a href="#contacto">Contacto</a>
      <a href="#" id="auth-nav-link" onclick="window.showAuthModal()">Iniciar Sesión / Registrarse</a>
      <button id="guest-mode-button" aria-label="Entrar en modo invitado">Modo Invitado</button>
      <a href="#" id="quiz-nav-link" onclick="window.showQuestion()">Cuestionario</a>
      <button id="logout-button" aria-label="Cerrar sesión">Cerrar Sesión</button>
    </nav>

    <section class="hero" aria-label="Sección principal de bienvenida">
      <h1>Tu tutor virtual inteligente para Matemáticas, Inglés y Lengua</h1>
      <p>Un método de aprendizaje dinámico, adaptado a tu ritmo y estilo, diseñado para potenciar tu concentración y comprensión.</p>
    </section>

    <div id="result-message" role="status" aria-live="polite" style="display: none;"></div>
    <div id="study-advice" role="note" style="display: none;"></div>
    <div id="tdah-warning" role="alert" style="display: none;">
      ⚠️ Si presentas indicios de TDAH, MultiGenio te ofrecerá recursos y estrategias especiales para ayudarte a mantener la concentración y aprovechar tu estilo de aprendizaje de la forma más efectiva.
    </div>

    <section class="section" id="que-es" aria-labelledby="que-es-heading">
      <h2 id="que-es-heading">¿Qué es MultiGenio?</h2>
      <img src="https://placehold.co/100x100/eef5fb/34495e?text=IA" alt="Icono de inteligencia artificial" />
      <p>
        <strong>MultiGenio</strong> es una innovadora plataforma educativa diseñada para transformar la experiencia de aprendizaje. Nos especializamos en ofrecer un **tutor virtual inteligente** que se adapta de manera dinámica a las necesidades individuales de cada estudiante, maximizando su potencial en materias clave como **Matemáticas, Inglés y Lengua Española**. Nuestra misión es hacer el aprendizaje accesible, efectivo y estimulante para todos, incluyendo aquellos con **TDAH** o dificultades de atención, proporcionando herramientas y estrategias personalizadas que fomentan la concentración y la comprensión profunda.
      </p>

      <h3>🧠 La Inteligencia Artificial en Acción: Un Enfoque Adaptativo y Personalizado</h3>
      <img src="https://placehold.co/100x100/eef5fb/34495e?text=Adaptación" alt="Icono de adaptación" />
      <p>
        En el corazón de MultiGenio reside una **Inteligencia Artificial avanzada** que va más allá de los métodos tradicionales. Nuestra IA analiza un conjunto de datos clave: desde tus respuestas en el cuestionario inicial, el progreso en los juegos interactivos, el tiempo que dedicas a cada tema, hasta tus preferencias de material didáctico (visual, auditivo, de lectura/escritura, kinestésico). Con esta información, el sistema es capaz de **ajustar dinámicamente la dificultad de los ejercicios, priorizar tipos de contenido específicos y sugerir rutas de aprendizaje alternativas** que se alinean perfectamente con tu estilo.
      </p>
      <p>
        Por ejemplo, si la IA detecta que un estudiante visual tiene dificultades con un concepto particular, podría ofrecer un **video explicativo animado**, un **mapa mental interactivo** o diagramas claros antes de proponer ejercicios de texto. Para alumnos con TDAH, la plataforma puede fragmentar lecciones extensas en **módulos más cortos y manejables**, incorporar **micro-descansos activos** con ejercicios de concentración, o activar **alertas visuales/auditivas sutiles** para ayudar a mantener el enfoque. Este enfoque garantiza una experiencia educativa que se siente hecha a la medida, minimizando las distracciones y potenciando al máximo la concentración y el disfrute del aprendizaje.
      </p>

      <h2>📋 Cuestionario Inicial: Tu Huella de Aprendizaje para una Personalización Óptima</h2>
      <img src="https://placehold.co/100x100/eef5fb/34495e?text=Quiz" alt="Icono de cuestionario" />
      <p>
        Antes de iniciar tu viaje con MultiGenio, te invitamos a completar un **cuestionario interactivo y estratégico de 5 preguntas**. Este no es un simple test de conocimientos; es una herramienta fundamental para que nuestra IA comprenda tu perfil de aprendizaje único. Las preguntas están meticulosamente diseñadas para identificar tu estilo de aprendizaje predominante entre las siguientes categorías:
      </p>
      <ul>
        <li><img src="https://img.icons8.com/color/48/eye.png" alt="Icono de ojo, estilo visual"/> <strong>Visual:</strong> Si procesas la información mejor a través de imágenes, gráficos, diagramas, videos y representaciones visuales.</li>
        <li><img src="https://img.icons8.com/color/48/ear.png" alt="Icono de oreja, estilo auditivo"/> <strong>Auditivo:</strong> Si retienes la información de forma más efectiva al escuchar explicaciones, debates, grabaciones o podcasts.</li>
        <li><img src="https://img.icons8.com/color/48/writing.png" alt="Icono de escritura, estilo lectura/escritura"/> <strong>Lectura/Escritura:</strong> Si tu fortaleza radica en la lectura de textos, la toma de notas detalladas, la escritura de resúmenes o la creación de listas.</li>
        <li><img src="https://img.icons8.com/color/48/running.png" alt="Icono de persona corriendo, estilo kinestésico"/> <strong>Kinestésico:</strong> Si necesitas "hacer" para aprender, prefiriendo actividades prácticas, experimentos, maquetas o el movimiento físico durante el estudio.</li>
      </ul>
      <p>
        Además, una pregunta específica en el cuestionario está formulada para detectar posibles indicios compatibles con el **Trastorno por Déficit de Atención e Hiperactividad (TDAH)**. Si estas señales son identificadas, la plataforma activará un conjunto de estrategias pedagógicas y recursos especiales, como temporizadores de enfoque para gestionar el tiempo de estudio, desafíos de atención para mantener el interés, y formatos de contenido adaptados para minimizar distracciones. Este perfil inicial es la base sobre la cual nuestra IA construye y personaliza cada faceta de tu trayectoria de aprendizaje en MultiGenio, garantizando una experiencia óptima y libre de frustraciones.
      </p>
    </section>
   
    <section class="section" id="materias" aria-labelledby="materias-heading">
      <h2 id="materias-heading">Explora Nuestras Materias</h2>
      <p class="text-center">En MultiGenio, ofrecemos un currículo completo y adaptado para que domines las asignaturas más importantes.</p>
      <div class="cards">
        <div class="card clickable-card" role="button" tabindex="0" onclick="window.showSubject('matematicas')" onkeypress="if(event.key === 'Enter') window.showSubject('matematicas')">
          <img src="https://placehold.co/90x90/eef5fb/3f68a2?text=MATH" alt="Icono de calculadora para Matemáticas" />
          <h3>Matemáticas</h3>
          <p>Desde los fundamentos de aritmética hasta el álgebra avanzada para secundaria. Aprende con juegos mentales, visualizaciones interactivas y lógica adaptada a tu ritmo de aprendizaje.</p>
          <div class="card-overlay">
            <span>¡Acceder!</span>
          </div>
        </div>
        <div class="card clickable-card" role="button" tabindex="0" onclick="window.showSubject('lengua')" onkeypress="if(event.key === 'Enter') window.showSubject('lengua')">
          <img src="https://placehold.co/90x90/eef5fb/3f68a2?text=LENG" alt="Icono de libro para Lengua" />
          <h3>Lengua</h3>
          <p>Domina la morfología, sintaxis, ortografía y redacción con ejemplos prácticos, ejercicios creativos y explicaciones que facilitan la memorización y comprensión profunda.</p>
          <div class="card-overlay">
            <span>¡Acceder!</span>
          </div>
        </div>
        <div class="card clickable-card" role="button" tabindex="0" onclick="window.showSubject('ingles')" onkeypress="if(event.key === 'Enter') window.showSubject('ingles')">
          <img src="https://placehold.co/90x90/eef5fb/3f68a2?text=ENG" alt="Icono de bandera de Reino Unido para Inglés" />
          <h3>Inglés</h3>
          <p>Desde el nivel básico A1 hasta el intermedio B1: expande tu vocabulario, perfecciona tu gramática, mejora tu comprensión auditiva y fluidez oral con contenido visual y audios interactivos.</p>
          <div class="card-overlay">
            <span>¡Acceder!</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="beneficios" aria-labelledby="beneficios-heading">
      <h2 id="beneficios-heading">¿Por qué elegir MultiGenio?</h2>
      <p class="text-center">Descubre las ventajas que te ofrece nuestra plataforma para un aprendizaje verdaderamente efectivo y motivador.</p>
      <ul>
        <li><img src="https://img.icons8.com/color/48/star--v1.png" alt="Icono de estrella"/> Explicaciones adaptadas a estudiantes con TDA/TDAH y dificultades de atención.</li>
        <li><img src="https://img.icons8.com/color/48/video-camera.png" alt="Icono de cámara de video"/> Contenido multimedia enriquecido: videos, ejemplos claros y material creativo.</li>
        <li><img src="https://img.icons8.com/color/48/brain.png" alt="Icono de cerebro"/> Aprendizaje 100% personalizado, a tu propio ritmo y sin presiones.</li>
        <li><img src="https://img.icons8.com/color/48/graduation-cap.png" alt="Icono de gorro de graduación"/> Una herramienta ideal para el apoyo educativo en casa, para padres, docentes y alumnos.</li>
      </ul>
    </section>

    <section class="section" id="testimonios" aria-labelledby="testimonios-heading">
      <h2 id="testimonios-heading">Lo que dicen nuestros alumnos y familias</h2>
      <p class="text-center">Las experiencias reales de quienes ya están transformando su aprendizaje con MultiGenio.</p>
      <div class="cards testimonials-grid">
        <div class="card testimonial-card">
          <img src="https://placehold.co/70x70/6ed3b3/ffffff?text=LG" alt="Foto de perfil de Laura G." />
          <h3>Laura G.</h3>
          <p>"¡MultiGenio cambió por completo mi forma de ver las matemáticas! Siempre me frustraba, pero con sus explicaciones visuales y los juegos interactivos, ahora entiendo los conceptos más complejos de una forma mucho más sencilla y divertida. ¡Lo recomiendo a todos mis compañeros!"</p>
          <div class="rating">⭐⭐⭐⭐⭐</div>
        </div>
        <div class="card testimonial-card">
          <img src="https://placehold.co/70x70/6ed3b3/ffffff?text=PR" alt="Foto de perfil de Pablo R." />
          <h3>Pablo R. (Padre)</h3>
          <p>"Como padre de un niño con TDAH, encontrar MultiGenio ha sido una verdadera bendición. La paciencia, el enfoque adaptado y las herramientas específicas que ofrece la plataforma son increíbles. Mi hijo está más motivado que nunca y aprendiendo sin el estrés de antes. ¡Estamos encantados!"</p>
          <div class="rating">⭐⭐⭐⭐⭐</div>
        </div>
        <div class="card testimonial-card">
          <img src="https://placehold.co/70x70/6ed3b3/ffffff?text=SM" alt="Foto de perfil de Sofía M." />
          <h3>Sofía M. (Profesora)</h3>
          <p>"He tenido la oportunidad de probar muchas herramientas educativas, pero MultiGenio es única por su profunda capacidad de adaptación. La Inteligencia Artificial es una maravilla para detectar y apoyar a cada alumno según su estilo de aprendizaje y necesidades. La recomiendo sin dudarlo a todos mis colegas y sus estudiantes."</p>
          <div class="rating">⭐⭐⭐⭐⭐</div>
        </div>
      </div>
    </section>

    <section id="reviews-section" class="section" aria-labelledby="reviews-heading">
        <h2 id="reviews-heading">Opiniones de Nuestros Usuarios</h2>
        <div id="reviews-container">
            <!-- Las reseñas se cargarán aquí dinámicamente desde Firestore -->
        </div>
        <div id="review-submit-area">
            <h3 style="color: var(--primary-color); margin-top: 40px; font-size: 2em; font-weight: 700;">Deja tu Reseña</h3>
            <p class="review-submit-info" id="review-auth-message">Inicia sesión para poder dejar una reseña.</p>
            <form id="review-form" class="review-form" style="display: none;" aria-labelledby="review-form-heading">
                <label for="review-text">Tu Experiencia:</label>
                <textarea id="review-text" placeholder="Comparte tu opinión sobre MultiGenio..." rows="5" required aria-label="Tu reseña"></textarea>
                
                <label for="review-rating">Tu Calificación:</label>
                <div id="review-rating-stars" class="rating-stars" aria-label="Calificación de 1 a 5 estrellas">
                    <button type="button" data-rating="1" aria-label="1 estrella">⭐</button>
                    <button type="button" data-rating="2" aria-label="2 estrellas">⭐</button>
                    <button type="button" data-rating="3" aria-label="3 estrellas">⭐</button>
                    <button type="button" data-rating="4" aria-label="4 estrellas">⭐</button>
                    <button type="button" data-rating="5" aria-label="5 estrellas">⭐</button>
                </div>
                <input type="hidden" id="selected-rating" value="0" />
                
                <button type="submit">Enviar Reseña</button>
            </form>
        </div>
    </section>


    <section class="section" id="contacto" aria-labelledby="contacto-heading">
      <h2 id="contacto-heading">Contacta con Nosotros</h2>
      <div class="contact-form">
        <p>¿Quieres probar MultiGenio o tienes dudas? Envíanos un mensaje y te responderemos a la brevedad posible.</p>
        <form>
          <input type="text" placeholder="Tu nombre" required aria-label="Tu nombre" /><br />
          <input type="email" placeholder="Tu correo electrónico" required aria-label="Tu correo electrónico" /><br />
          <textarea placeholder="Tu mensaje..." rows="5" required aria-label="Tu mensaje"></textarea><br />
          <button type="submit">Enviar mensaje</button>
        </form>
      </div>
    </section>

    <script>
      // Configuración para el chatbot de Chatbase
      window.chatbaseConfig = {
        chatbotId: "frw3UKvg6MK3c9Zw-bZAu"
      };
    </script>
    <script src="https://www.chatbase.co/embed.min.js" defer></script>

    <footer>
      <p>&copy; 2025 MultiGenio. Todos los derechos reservados.</p>
    </footer>
  </div>

  <div id="matematicas-page" class="subject-page section" style="display: none;" role="main" aria-labelledby="matematicas-heading">
    <button class="back-button" onclick="window.showMainContent()" aria-label="Volver al inicio">← Volver al inicio</button>
    <h1 id="matematicas-heading" style="text-align: center; color: var(--primary-color);">📊 Matemáticas</h1>
    <div id="math-personalized-intro" aria-live="polite"></div>

    <div class="progress-bar-container" id="matematicas-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso en Matemáticas">
      <div class="progress-bar-fill" id="matematicas-progress-fill" style="width: 0%;"></div>
      <span class="progress-text" id="matematicas-progress-text">0% completado</span>
    </div>
    
    <div class="topic-list" aria-label="Temario de Matemáticas">
      <h2>Temario por niveles</h2>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('matematicas', 'operaciones-basicas')" onkeypress="if(event.key === 'Enter') window.showLessonContent('matematicas', 'operaciones-basicas')">
        <div class="topic-title">Operaciones Básicas <span class="level-badge">Primaria</span>
          <span class="progress-indicator" id="progress-matematicas-operaciones-basicas"></span>
        </div>
        <div class="topic-description">Suma, resta, multiplicación y división. Problemas prácticos del día a día.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('matematicas', 'fracciones')" onkeypress="if(event.key === 'Enter') window.showLessonContent('matematicas', 'fracciones')">
        <div class="topic-title">Fracciones y Decimales <span class="level-badge">6º Primaria</span>
          <span class="progress-indicator" id="progress-matematicas-fracciones"></span>
        </div>
        <div class="topic-description">Conceptos, operaciones y equivalencias. Con ejemplos visuales.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('matematicas', 'porcentajes')" onkeypress="if(event.key === 'Enter') window.showLessonContent('matematicas', 'porcentajes')">
        <div class="topic-title">Porcentajes <span class="level-badge">1º ESO</span>
          <span class="progress-indicator" id="progress-matematicas-porcentajes"></span>
        </div>
        <div class="topic-description">Cálculo de porcentajes, aumentos y descuentos.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('matematicas', 'ecuaciones')" onkeypress="if(event.key === 'Enter') window.showLessonContent('matematicas', 'ecuaciones')">
        <div class="topic-title">Ecuaciones de Primer Grado <span class="level-badge">2º ESO</span>
          <span class="progress-indicator" id="progress-matematicas-ecuaciones"></span>
        </div>
        <div class="topic-description">Resolución paso a paso con métodos visuales.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('matematicas', 'sistemas')" onkeypress="if(event.key === 'Enter') window.showLessonContent('matematicas', 'sistemas')">
        <div class="topic-title">Sistemas de Ecuaciones <span class="level-badge">3º ESO</span>
          <span class="progress-indicator" id="progress-matematicas-sistemas"></span>
        </div>
        <div class="topic-description">Métodos de sustitución, igualación y reducción.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('matematicas', 'geometria')" onkeypress="if(event.key === 'Enter') window.showLessonContent('matematicas', 'geometria')">
        <div class="topic-title">Geometría Básica <span class="level-badge">1º-2º ESO</span>
          <span class="progress-indicator" id="progress-matematicas-geometria"></span>
        </div>
        <div class="topic-description">Áreas, perímetros y volúmenes de figuras básicas.</div>
      </div>
    </div>
  </div>

  <div id="lengua-page" class="subject-page section" style="display: none;" role="main" aria-labelledby="lengua-heading">
    <button class="back-button" onclick="window.showMainContent()" aria-label="Volver al inicio">← Volver al inicio</button>
    <h1 id="lengua-heading" style="text-align: center; color: var(--primary-color);">📚 Lengua Española</h1>
    <div id="lengua-personalized-intro" aria-live="polite"></div>

    <div class="progress-bar-container" id="lengua-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso en Lengua Española">
      <div class="progress-bar-fill" id="lengua-progress-fill" style="width: 0%;"></div>
      <span class="progress-text" id="lengua-progress-text">0% completado</span>
    </div>
    
    <div class="topic-list" aria-label="Temario de Lengua Española">
      <h2>Temario por niveles</h2>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('lengua', 'ortografia-basica')" onkeypress="if(event.key === 'Enter') window.showLessonContent('lengua', 'ortografia-basica')">
        <div class="topic-title">Ortografía Básica <span class="level-badge">Primaria</span>
          <span class="progress-indicator" id="progress-lengua-ortografia-basica"></span>
        </div>
        <div class="topic-description">Acentuación, uso de b/v, g/j, h. Con ejercicios prácticos.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('lengua', 'morfologia')" onkeypress="if(event.key === 'Enter') window.showLessonContent('lengua', 'morfologia')">
        <div class="topic-title">Morfología <span class="level-badge">1º ESO</span>
          <span class="progress-indicator" id="progress-lengua-morfologia"></span>
        </div>
        <div class="topic-description">Categorías gramaticales: sustantivos, adjetivos, verbos, etc.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('lengua', 'sintaxis-simple')" onkeypress="if(event.key === 'Enter') window.showLessonContent('lengua', 'sintaxis-simple')">
        <div class="topic-title">Sintaxis - Oración Simple <span class="level-badge">2º ESO</span>
          <span class="progress-indicator" id="progress-lengua-sintaxis-simple"></span>
        </div>
        <div class="topic-description">Sujeto, predicado y complementos básicos.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('lengua', 'sintaxis-compuesta')" onkeypress="if(event.key === 'Enter') window.showLessonContent('lengua', 'sintaxis-compuesta')">
        <div class="topic-title">Sintaxis - Oración Compuesta <span class="level-badge">3º ESO</span>
          <span class="progress-indicator" id="progress-lengua-sintaxis-compuesta"></span>
        </div>
        <div class="topic-description">Oraciones coordinadas y subordinadas.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('lengua', 'literatura')" onkeypress="if(event.key === 'Enter') window.showLessonContent('lengua', 'literatura')">
        <div class="topic-title">Literatura Española <span class="level-badge">2º-3º ESO</span>
          <span class="progress-indicator" id="progress-lengua-literatura"></span>
        </div>
        <div class="topic-description">Géneros literarios, métrica y autores principales.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('lengua', 'expresion-escrita')" onkeypress="if(event.key === 'Enter') window.showLessonContent('lengua', 'expresion-escrita')">
        <div class="topic-title">Expresión Escrita <span class="level-badge">Todos</span>
          <span class="progress-indicator" id="progress-lengua-expresion-escrita"></span>
        </div>
        <div class="topic-description">Técnicas de redacción, tipos de texto y coherencia.</div>
      </div>
    </div>
  </div>

  <div id="ingles-page" class="subject-page section" style="display: none;" role="main" aria-labelledby="ingles-heading">
    <button class="back-button" onclick="window.showMainContent()" aria-label="Volver al inicio">← Volver al inicio</button>
    <h1 id="ingles-heading" style="text-align: center; color: var(--primary-color);">🇬🇧 English</h1>
    <div id="ingles-personalized-intro" aria-live="polite"></div>

    <div class="progress-bar-container" id="ingles-progress-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Progreso en Inglés">
      <div class="progress-bar-fill" id="ingles-progress-fill" style="width: 0%;"></div>
      <span class="progress-text" id="ingles-progress-text">0% completado</span>
    </div>
    
    <div class="topic-list" aria-label="Temario de Inglés">
      <h2>Temario por niveles</h2>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('ingles', 'basic-vocabulary')" onkeypress="if(event.key === 'Enter') window.showLessonContent('ingles', 'basic-vocabulary')">
        <div class="topic-title">Basic Vocabulary <span class="level-badge">A1</span>
          <span class="progress-indicator" id="progress-ingles-basic-vocabulary"></span>
        </div>
        <div class="topic-description">Numbers, colors, family, daily routines. Con apoyo visual.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('ingles', 'present-tenses')" onkeypress="if(event.key === 'Enter') window.showLessonContent('ingles', 'present-tenses')">
        <div class="topic-title">Present Simple & Continuous <span class="level-badge">A1-A2</span>
          <span class="progress-indicator" id="progress-ingles-present-tenses"></span>
        </div>
        <div class="topic-description">Tiempos verbales básicos con ejemplos prácticos.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('ingles', 'past-tenses')" onkeypress="if(event.key === 'Enter') window.showLessonContent('ingles', 'past-tenses')">
        <div class="topic-title">Past Simple & Past Continuous <span class="level-badge">A2</span>
          <span class="progress-indicator" id="progress-ingles-past-tenses"></span>
        </div>
        <div class="topic-description">Narración en pasado, verbos regulares e irregulares.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('ingles', 'future-tenses')" onkeypress="if(event.key === 'Enter') window.showLessonContent('ingles', 'future-tenses')">
        <div class="topic-title">Future Tenses <span class="level-badge">A2-B1</span>
          <span class="progress-indicator" id="progress-ingles-future-tenses"></span>
        </div>
        <div class="topic-description">Will, going to, present continuous for future.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('ingles', 'conditionals')" onkeypress="if(event.key === 'Enter') window.showLessonContent('ingles', 'conditionals')">
        <div class="topic-title">Conditionals <span class="level-badge">B1</span>
          <span class="progress-indicator" id="progress-ingles-conditionals"></span>
        </div>
        <div class="topic-description">First, second and third conditional sentences.</div>
      </div>
      
      <div class="topic-item" role="button" tabindex="0" onclick="window.showLessonContent('ingles', 'listening-speaking')" onkeypress="if(event.key === 'Enter') window.showLessonContent('ingles', 'listening-speaking')">
        <div class="topic-title">Listening & Speaking <span class="level-badge">A1-B1</span>
          <span class="progress-indicator" id="progress-ingles-listening-speaking"></span>
        </div>
        <div class="topic-description">Ejercicios de comprensión auditiva y pronunciación.</div>
      </div>
    </div>
  </div>

  <div id="lesson-content-display" class="section" style="display: none;" role="main" aria-labelledby="lesson-title">
    <button class="back-button" onclick="window.hideLessonContent()" aria-label="Volver al temario">← Volver al temario</button>
    <h2 id="lesson-title"></h2>
    <div id="lesson-material"></div>
  </diV>


  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDklyhhZOV3c2KbbrvAZOpoUitPBWgRBOQ",
      authDomain: "multigenio-39890.firebaseapp.com",
      projectId: "multigenio-39890",
      storageBucket: "multigenio-39890.firebasestorage.app",
      messagingSenderId: "881137429405",
      appId: "1:881137429405:web:9f061138bdf43b00dd5d74",
      measurementId: "G-9SQX18GVH6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app); // Initialize Firebase Auth service
    const db = getFirestore(app); // Initialize Firestore

    // DOM elements
    const authModalOverlay = document.getElementById('auth-modal-overlay');
    const authContainer = document.getElementById('auth-container');
    const loginFormDiv = document.getElementById('login-form');
    const registerFormDiv = document.getElementById('register-form');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const registerEmailInput = document.getElementById('register-email');
    const registerPasswordInput = document.getElementById('register-password');
    const logoutButton = document.getElementById('logout-button');
    const quizNavLink = document.getElementById('quiz-nav-link');
    const authNavLink = document.getElementById('auth-nav-link');
    const guestModeButton = document.getElementById('guest-mode-button'); // New element for guest mode button

    const quizContainer = document.getElementById('quiz-container');
    const mainContent = document.getElementById('main-content');
    const questionText = document.getElementById('question-text');
    const optionsDiv = document.getElementById('options');
    const resultMessage = document.getElementById('result-message');
    const tdahWarning = document.getElementById('tdah-warning');
    const studyAdvice = document.getElementById('study-advice');
    const lessonContentDisplay = document.getElementById('lesson-content-display');
    const customMessage = document.getElementById('custom-message');
    const userIdDisplay = document.getElementById('user-id-display'); // New element for User ID

    // Review system elements
    const reviewsContainer = document.getElementById('reviews-container');
    const reviewForm = document.getElementById('review-form');
    const reviewTextarea = document.getElementById('review-text');
    const reviewRatingStars = document.getElementById('review-rating-stars');
    const selectedRatingInput = document.getElementById('selected-rating');
    const reviewAuthMessage = document.getElementById('review-auth-message');

    let isAuthenticated = false; // Flag to track authentication status
    let currentUserId = null; // Store the current user ID
    let currentUserName = null; // Store the current user's display name or email prefix
    let isGuestMode = false; // Flag for guest mode
    let userLearningStyle = 'visual'; // Default learning style, updated by quiz or Firestore
    let userTDAHStatus = 'no'; // Default TDAH status, updated by quiz or Firestore
    let userQuizCompleted = false; // Track if quiz is completed

    // Gemini API Configuration
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=";
    // !! IMPORTANTE !! Si estás ejecutando esta aplicación fuera del entorno de Google Canvas,
    // DEBES reemplazar "TU_API_KEY_DE_GEMINI_AQUI" con tu propia clave API de Gemini.
    // Puedes obtener una clave API en Google AI Studio: https://makersuite.google.com/
    const GEMINI_API_KEY = "AIzaSyBGKJQINcUZKVxCw8NI43bVmPsDqGVBsB0"; // Reemplazada con la clave proporcionada

    // --- Utility Functions ---
    function showMessage(message, duration = 3000) {
        customMessage.textContent = message;
        customMessage.style.display = 'block';
        customMessage.classList.add('show');
        setTimeout(() => {
            customMessage.classList.remove('show');
            customMessage.style.display = 'none';
        }, duration);
    }

    function showElement(element) {
        element.style.display = 'block';
    }

    function hideElement(element) {
        element.style.display = 'none';
    }
    
    // Override for modal overlay to use flex for centering
    function showModalOverlay(element) {
        element.style.display = 'flex';
        element.classList.add('active');
    }

    function hideModalOverlay(element) {
        element.classList.remove('active');
        // Give time for transition before setting display to none
        setTimeout(() => {
            element.style.display = 'none';
        }, 300); // Match CSS transition duration
    }

    // --- Authentication Functions ---
    window.toggleAuthForm = function(formToShow) {
      if (formToShow === 'login') {
        showElement(loginFormDiv);
        hideElement(registerFormDiv);
      } else {
        hideElement(loginFormDiv);
        showElement(registerFormDiv);
      }
    }

    window.showAuthModal = function() {
        showModalOverlay(authModalOverlay); // Use new modal show function
        hideElement(mainContent);
        hideElement(quizContainer);
        hideElement(lessonContentDisplay);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
        window.toggleAuthForm('login');
    }

    window.hideAuthModal = function() {
        hideModalOverlay(authModalOverlay); // Use new modal hide function
        if (isAuthenticated || isGuestMode) { // Show main content for authenticated or guest users
            showElement(mainContent);
        }
    }

    // Register user with email and password
    document.getElementById('register-email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = registerEmailInput.value;
      const password = registerPasswordInput.value;

      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showMessage('¡Registro exitoso! Has iniciado sesión.');
        isGuestMode = false; // Exit guest mode if user registers
      } catch (error) {
        let errorMessage = 'Error al registrar: ';
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage += 'El correo electrónico ya está en uso.';
                break;
            case 'auth/invalid-email':
                errorMessage += 'El formato del correo electrónico no es válido.';
                break;
            case 'auth/weak-password':
                errorMessage += 'La contraseña debe tener al menos 6 caracteres.';
                break;
            default:
                errorMessage += error.message;
        }
        showMessage(errorMessage, 5000);
        console.error("Error al registrar:", error);
      }
    });

    // Sign in user with email and password
    document.getElementById('login-email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginEmailInput.value;
      const password = loginPasswordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('¡Inicio de sesión exitoso!');
        isGuestMode = false; // Exit guest mode if user logs in
      } catch (error) {
        let errorMessage = 'Error al iniciar sesión: ';
        switch (error.code) {
            case 'auth/invalid-credential':
                errorMessage += 'Credenciales inválidas. Por favor, verifica tu correo y contraseña.';
                break;
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                errorMessage += 'Correo o contraseña incorrectos.';
                break;
            case 'auth/invalid-email':
                errorMessage += 'El formato del correo electrónico no es válido.';
                break;
            default:
                errorMessage += error.message;
        }
        showMessage(errorMessage, 5000);
        console.error("Error al iniciar sesión:", error);
      }
    });

    // Guest mode button event listener
    guestModeButton.addEventListener('click', () => {
        isGuestMode = true;
        isAuthenticated = false; // Ensure not authenticated if guest
        currentUserId = null; // No specific user ID for guest mode
        currentUserName = "Invitado";
        window.hideAuthModal();
        showElement(mainContent);
        showMessage('Modo invitado activado. Algunas funciones de personalización y guardado no están disponibles.', 5000);
        updateNavigationVisibility();
        window.updateQuizResultDisplay(); // Clear quiz result display
        updateReviewFormVisibility(); // Update review form for guests
    });

    // Logout button event listener
    logoutButton.addEventListener('click', async () => {
      try {
        await signOut(auth);
        isGuestMode = false; // Exit guest mode on logout
        showMessage('Has cerrado sesión.');
      } catch (error) {
        showMessage('Error al cerrar sesión: ' + error.message, 5000);
        console.error("Error al cerrar sesión:", error);
      }
    });

    function updateNavigationVisibility() {
        if (isAuthenticated) {
            showElement(quizNavLink);
            showElement(logoutButton);
            hideElement(authNavLink);
            hideElement(guestModeButton); // Hide guest button when logged in
            
            // Show/hide quiz nav link based on quiz completion status
            if (userQuizCompleted) {
                hideElement(quizNavLink);
            } else {
                showElement(quizNavLink);
            }

            hideElement(userIdDisplay); // Still keep user ID hidden

        } else if (isGuestMode) {
            hideElement(quizNavLink); // Guests cannot take quiz or save progress
            hideElement(logoutButton);
            hideElement(authNavLink); // Hide auth link if already in guest mode
            showElement(guestModeButton); // Keep guest button visible if it's the current mode
            hideElement(userIdDisplay);
            // Reset to default learning style for guest mode
            userLearningStyle = 'visual';
            userTDAHStatus = 'no';
            resultMessage.textContent = '';
            studyAdvice.textContent = '';
            hideElement(tdahWarning);
        } else { // Not authenticated, not guest mode (initial state or after logout)
            hideElement(quizNavLink);
            hideElement(logoutButton);
            showElement(authNavLink);
            showElement(guestModeButton); // Show guest button
            hideElement(userIdDisplay);
        }
        updateReviewFormVisibility(); // Ensure review form visibility is updated on auth state change
    }

    // Listen for authentication state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        isAuthenticated = true;
        currentUserId = user.uid;
        currentUserName = user.email ? user.email.split('@')[0] : "Usuario"; // Set username from email prefix
        isGuestMode = false; // Ensure not in guest mode if authenticated
        window.hideAuthModal(); // Hide modal, show main content
        
        // Load user preferences BEFORE updating nav visibility
        await window.loadUserPreferences(user.uid); 
        updateNavigationVisibility(); // Update visibility based on auth status and loaded preferences
        showMessage('Bienvenido de nuevo.');

        window.loadProgressAndDisplay(); // Refresh UI based on loaded progress
        window.updateAllProgressBars(); // Recalculate and update all progress bars
      } else {
        isAuthenticated = false;
        currentUserId = null;
        currentUserName = null; // Clear username on logout
        // Do not force show mainContent here, let specific functions handle it
        // based on guest mode or initial state.
        updateNavigationVisibility(); // Update visibility based on auth status (not authenticated)
        // Reset user preferences to default only if not in guest mode.
        if (!isGuestMode) {
            userLearningStyle = 'visual';
            userTDAHStatus = 'no';
            userQuizCompleted = false; // Reset quiz status
            resultMessage.textContent = '';
            studyAdvice.textContent = '';
            hideElement(tdahWarning);
        }
        showMessage('Inicia sesión o regístrate para acceder a todas las funciones.', 5000);
      }
    });

    // --- Firestore Functions for User Preferences and Progress ---
    async function saveUserPreferences() {
        if (!isAuthenticated) {
            console.error("No user ID to save preferences. User is not authenticated.");
            showMessage("Por favor, inicia sesión para guardar tus preferencias.", 3000);
            return;
        }
        const userRef = doc(db, "users", currentUserId);
        try {
            await setDoc(userRef, {
                learningStyle: userLearningStyle,
                tdahStatus: userTDAHStatus,
                quizCompleted: true // Mark quiz as completed
            }, { merge: true });
            userQuizCompleted = true; // Update local state
            console.log("User preferences saved to Firestore.");
        } catch (e) {
            console.error("Error saving user preferences: ", e);
            showMessage("Error al guardar tus preferencias.", 3000);
        }
    }

    window.loadUserPreferences = async function(uid) { // Made global
        if (!isAuthenticated) {
            console.warn("Cannot load user preferences: User is not authenticated.");
            return;
        }
        const userRef = doc(db, "users", uid);
        try {
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                userLearningStyle = data.learningStyle || 'visual';
                userTDAHStatus = data.tdahStatus || 'no';
                userQuizCompleted = data.quizCompleted || false; // Load quiz completion status
                console.log("User preferences loaded from Firestore:", data);
                
                // Update UI based on loaded preferences
                window.updateQuizResultDisplay(); // Call global version
            } else {
                console.log("No user preferences found in Firestore. User is new or quiz not completed.");
                // For new users, or users without preferences saved, the default 'visual' and 'no' will be used.
                userQuizCompleted = false; // Ensure it's false if no preferences found
            }
        } catch (e) {
            console.error("Error loading user preferences: ", e);
            showMessage("Error al cargar tus preferencias.", 3000);
        }
    }

    window.saveProgress = async function(subject, topicId, status) { // Made global
        if (!isAuthenticated) {
            console.error("No user ID to save progress. User is not authenticated.");
            showMessage("Por favor, inicia sesión para guardar tu progreso.", 3000);
            return;
        }
        const progressRef = doc(db, `users/${currentUserId}/progress`, `${subject}-${topicId}`);
        try {
            await setDoc(progressRef, { status: status, timestamp: new Date() }, { merge: true });
            console.log(`Progress for ${subject}-${topicId} saved.`);
            window.loadProgressAndDisplay(); // Call global version
            window.updateAllProgressBars(); // Call global version
        } catch (e) {
            console.error("Error saving progress: ", e);
            showMessage("Error al guardar tu progreso.", 3000);
        }
    }

    window.loadProgressAndDisplay = async function() { // Made global
        if (!isAuthenticated) {
            console.warn("No user ID to load progress. Displaying default progress.");
            // If not authenticated, ensure progress indicators are cleared.
            [
              ...mathTopics.map(t => ({ subject: 'matematicas', topic: t })),
              ...lenguaTopics.map(t => ({ subject: 'lengua', topic: t })),
              ...inglesTopics.map(t => ({ subject: 'ingles', topic: t }))
            ].forEach(({ subject, topic }) => {
              const indicator = document.getElementById(`progress-${subject}-${topic.id}`);
              if (indicator) {
                indicator.innerHTML = '';
              }
            });
            return;
        }

        try {
            const progressCollectionRef = collection(db, `users/${currentUserId}/progress`);
            const querySnapshot = await getDocs(progressCollectionRef);
            const userProgress = {};
            querySnapshot.forEach((doc) => {
                userProgress[doc.id] = doc.data().status;
            });

            // Make userProgress globally accessible for window.updateSubjectProgress
            window.userProgress = userProgress; 

            // Update individual topic indicators
            [
                ...mathTopics.map(t => ({ subject: 'matematicas', topic: t })),
                ...lenguaTopics.map(t => ({ subject: 'lengua', topic: t })),
                ...inglesTopics.map(t => ({ subject: 'ingles', topic: t }))
            ].forEach(({ subject, topic }) => {
                const docId = `${subject}-${topic.id}`;
                const status = userProgress[docId];
                const indicator = document.getElementById(`progress-${subject}-${topic.id}`);
                if (indicator) {
                    if (status === 'completed') {
                        indicator.innerHTML = '<span style="color: green; font-weight: bold; margin-left: 10px;">✅ Completado</span>';
                    } else {
                        indicator.innerHTML = ''; // Limpiar si no está completado
                    }
                }
            });
            window.updateAllProgressBars(); // Call global version after loading all individual progress
        } catch (e) {
            console.error("Error loading progress: ", e);
            showMessage("Error al cargar tu progreso.", 3000);
        }
    }

    window.updateSubjectProgress = function(subject, topicsArray, progressFillId, progressTextId, progressContainerId) { // Added progressContainerId parameter
      let completedCount = 0;
      topicsArray.forEach(topic => {
          const progressKey = `${subject}-${topic.id}`; // This matches doc ID in Firestore
          if (window.userProgress && window.userProgress[progressKey] === 'completed') {
              completedCount++;
          }
      });

      const totalTopics = topicsArray.length;
      const percentage = totalTopics > 0 ? (completedCount / totalTopics) * 100 : 0;

      const progressBarFill = document.getElementById(progressFillId);
      const progressBarText = document.getElementById(progressTextId);
      const progressBarContainer = document.getElementById(progressContainerId); // Get the container element

      if (progressBarFill && progressBarText && progressBarContainer) { // Check if container exists
        progressBarFill.style.width = `${percentage}%`;
        progressBarText.textContent = `${Math.round(percentage)}% completado`;
        progressBarContainer.setAttribute('aria-valuenow', Math.round(percentage)); // Update ARIA attribute
      }
    }

    window.updateAllProgressBars = function() { // Made global
      window.updateSubjectProgress('matematicas', mathTopics, 'matematicas-progress-fill', 'matematicas-progress-text', 'matematicas-progress-container'); // Pass container ID
      window.updateSubjectProgress('lengua', lenguaTopics, 'lengua-progress-fill', 'lengua-progress-text', 'lengua-progress-container'); // Pass container ID
      window.updateSubjectProgress('ingles', inglesTopics, 'ingles-progress-fill', 'ingles-progress-text', 'ingles-progress-container'); // Pass container ID
    }

    window.updateQuizResultDisplay = function() { // Made global
        const styleNames = {
            visual: "Visual",
            auditivo: "Auditivo",
            'lectura-escritura': "Lectura/Escritura",
            kinestesico: "Kinestésico"
        };

        if (isAuthenticated) { // Only show personalized message if authenticated
            if (userLearningStyle) {
                resultMessage.textContent = `🎯 Tu estilo de aprendizaje detectado: ${styleNames[userLearningStyle]}`;
                const adviceByStyle = {
                    visual: "Recomendamos usar esquemas, mapas conceptuales, videos y colores para organizar tus ideas. Aprovecha imágenes y gráficos para estudiar.",
                    auditivo: "Aprende mejor con grabaciones, podcasts, explicaciones en voz alta y repitiendo la información oralmente.",
                    'lectura-escritura': "Prefiere leer textos, tomar apuntes, escribir resúmenes y usar listas para organizar la información.",
                    kinestesico: "Es ideal aprender haciendo, usando actividades prácticas, movimientos o ejercicios mientras estudias."
                };
                studyAdvice.textContent = adviceByStyle[userLearningStyle] || "";
                showElement(resultMessage);
                showElement(studyAdvice);
            } else { // No personalized style found for authenticated user, hide
                hideElement(resultMessage);
                hideElement(studyAdvice);
            }

            if (userTDAHStatus === 'tdah') {
                showElement(tdahWarning);
            } else {
                hideElement(tdahWarning);
            }
        } else { // Hide for guests or logged out users
            hideElement(resultMessage);
            hideElement(studyAdvice);
            hideElement(tdahWarning);
        }
    }

    // --- LLM Integration for Content Generation ---
    async function generateLessonContent(subject, topicId, learningStyle) {
        if (!GEMINI_API_KEY) {
            showMessage("Error: La clave API de Gemini no está configurada. Por favor, añádela para generar contenido con IA.", 10000);
            return "<p>Contenido no disponible. Por favor, configura tu clave API de Gemini.</p>";
        }

        showMessage("Generando contenido de lección con IA...", 5000);
        let effectiveLearningStyle = learningStyle;
        if (isGuestMode) {
             effectiveLearningStyle = 'general'; // Use a general style for guests
        }
        const prompt = `Genera un contenido de lección interactivo y conciso sobre "${topicId.replace(/-/g, ' ')}" dentro del tema de "${subject}" para un estudiante con estilo de aprendizaje "${effectiveLearningStyle}".
Incluye los siguientes elementos de forma relevante para el estilo de aprendizaje:
- **Imágenes y esquemas visuales**: Usa etiquetas <img> con URLs de placehold.co (por ejemplo, https://placehold.co/600x400/eef5fb/34495e?text=Esquema+del+Tema). Para cada imagen, incluye un atributo alt que describa la imagen en español.
- **Videos explicativos**: Usa etiquetas <video> con URLs de videos de ejemplo (por ejemplo, https://www.w3schools.com/html/mov_bbb.mp4). Asegúrate de incluir los atributos controls and poster (una imagen de placeholder para el poster).
- **Audios o podcasts**: Usa etiquetas <audio> con URLs de audio de ejemplo (por ejemplo, https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3). Incluye el atributo controls.
- **Ejercicios interactivos**: Incluye áreas de texto (<textarea>) para respuestas o pequeños problemas, y descripciones claras de cómo el usuario puede interactuar.
- **Un placeholder para un juego interactivo**: Usa una div con la clase 'interactive-game-placeholder' para describir el juego (ej: <div class='interactive-game-placeholder'><p>Aquí iría un juego de arrastrar y soltar.</p></div>).
- **Contenido textual didáctico**: Usa etiquetas <h3>, <p> para explicaciones claras y concisas.

Asegúrate de que el HTML generado sea válido, limpio y atractivo. El contenido debe ser didáctico y atractivo, adaptado al estilo de aprendizaje especificado. Al final de la lección, incluye un botón para simular la finalización de la lección con el texto 'Completar lección' o 'Simular Completar Juego'.`;

        try {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            const apiUrl = `${GEMINI_API_URL}${GEMINI_API_KEY}`;
            console.log("Calling Gemini API with prompt:", prompt); // Log the prompt for debugging
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Gemini API network response was not ok:", response.status, errorText);
                showMessage(`Error al generar contenido (código: ${response.status}). Inténtalo de nuevo.`, 5000);
                return "<p>Error al cargar el contenido de la lección debido a un problema de red.</p>";
            }

            const result = await response.json();
            console.log("Gemini API response:", result); // Log the full response

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const htmlContent = result.candidates[0].content.parts[0].text;
                // Clean markdown backticks if LLM adds them
                return htmlContent.replace(/```html\n?|\n?```/g, '');
            } else {
                console.error("Unexpected LLM response structure or missing content:", result);
                showMessage("No se pudo generar el contenido de la lección (estructura inesperada).", 5000);
                return "<p>Error: No se pudo generar el contenido. La IA no proporcionó una respuesta válida.</p>";
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            showMessage("Error de conexión con la IA. Verifica tu clave API y conexión a internet.", 7000);
            return "<p>Error de conexión al generar el contenido. Por favor, verifica tu clave API y conexión a internet.</p>";
        }
    }


    // --- Quiz Functions ---
    const quizQuestions = [
      {
        question: "¿Cómo prefieres aprender?",
        options: [
          { text: "Viendo imágenes, gráficos o videos", value: "visual" },
          { text: "Escuchando explicaciones o audios", value: "auditivo" },
          { text: "Leyendo o escribiendo textos", value: "lectura-escritura" },
          { text: "Haciendo actividades prácticas o manipulativas", value: "kinestesico" }
        ]
      },
      {
        question: "¿Sueles tener dificultades para mantener la atención o concentración?",
        options: [
          { text: "Sí, frecuentemente", value: "tdah" },
          { text: "A veces", value: "a-veces" },
          { text: "No, casi nunca", value: "no" }
        ]
      },
      {
        question: "Cuando estudias, ¿qué te ayuda más a entender y recordar?",
        options: [
          { text: "Ver esquemas o mapas conceptuales", value: "visual" },
          { text: "Escuchar grabaciones o explicaciones en voz alta", value: "auditivo" },
          { text: "Tomar notas o leer textos varias veces", value: "lectura-escritura" },
          { text: "Hacer ejercicios prácticos o moverme mientras estudio", value: "kinestesico" }
        ]
      },
      {
        question: "¿Qué actividad prefieres para aprender algo nuevo?",
        options: [
          { text: "Observar demostraciones visuales", value: "visual" },
          { text: "Participar en discusiones o escuchar explicaciones", value: "auditivo" },
          { text: "Leer libros o escribir resúmenes", value: "lectura-escritura" },
          { text: "Experimentar y practicar directamente", value: "kinestesico" }
        ]
      },
      {
        question: "¿Cómo recuerdas mejor la información?",
        options: [
          { text: "Recordando imágenes y colores", value: "visual" },
          { text: "Recordando sonidos o palabras", value: "auditivo" },
          { text: "Recordando textos o frases escritas", value: "lectura-escritura" },
          { text: "Recordando sensaciones y movimientos", value: "kinestesico" }
        ]
      }
    ];

    let currentQuestionIndex = 0;
    let selectedAnswers = {};

    window.showQuestion = function() {
      if (!isAuthenticated) {
        showMessage('Por favor, inicia sesión para acceder al cuestionario y guardar tus preferencias.', 4000);
        window.showAuthModal();
        return;
      }
      if (userQuizCompleted) {
          showMessage('Ya has completado el cuestionario de estilo de aprendizaje. Puedes continuar explorando las materias.', 4000);
          window.showMainContent(); // Return to main content if quiz already done
          return;
      }
      console.log('--- showQuestion called ---');
      console.log('Current index:', currentQuestionIndex);

      // Hide all other content explicitly
      hideElement(mainContent);
      document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
      hideElement(lessonContentDisplay);
      hideModalOverlay(authModalOverlay); // Ensure modal is not active

      // Show quiz container
      showElement(quizContainer);
      console.log('Quiz container display set to block.');

      if (currentQuestionIndex >= quizQuestions.length) {
        console.log('Quiz finished. Calling finishQuiz().');
        finishQuiz();
        return;
      }

      const currentQ = quizQuestions[currentQuestionIndex];
      questionText.textContent = currentQ.question;
      optionsDiv.innerHTML = '';
      console.log('Displaying question:', currentQ.question);
      
      currentQ.options.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.textContent = option.text;
        btn.onclick = () => {
          selectedAnswers[currentQuestionIndex] = option.value;
          currentQuestionIndex++;
          console.log('Option selected. Next question index:', currentQuestionIndex);
          window.showQuestion();
        };
        btn.setAttribute('aria-label', option.text); // Accessibility
        optionsDiv.appendChild(btn);
        console.log('Added option button:', option.text);
      });
    }

    async function finishQuiz() {
      console.log('--- finishQuiz called ---');
      hideElement(quizContainer);
      showElement(mainContent); // Ensure main content is shown

      const styleCounts = {
        visual: 0,
        auditivo: 0,
        'lectura-escritura': 0,
        kinestesico: 0
      };

      for(let i = 0; i < quizQuestions.length; i++){
        if(i === 1) continue; // Skip TDAH question (index 1)
        const ans = selectedAnswers[i];
        if(styleCounts.hasOwnProperty(ans)){
          styleCounts[ans]++;
        }
      }

      let maxStyle = 'visual';
      let maxCount = 0;
      for(const style in styleCounts){
        if(styleCounts[style] > maxCount){
          maxCount = styleCounts[style];
          maxStyle = style;
        }
      }
      userLearningStyle = maxStyle; // Update global variable

      userTDAHStatus = selectedAnswers[1] || 'no'; // Update global variable for TDAH status

      window.updateQuizResultDisplay(); // Update UI based on final style and TDAH status
      await saveUserPreferences(); // Save preferences to Firestore
      updateNavigationVisibility(); // Update navigation after quiz completion

      window.loadProgressAndDisplay(); // Use global version
      window.updateAllProgressBars(); // Use global version
    }

    // --- Data de Temas para Cálculo de Progreso ---
    const mathTopics = [
      { id: 'operaciones-basicas', text: 'Operaciones Básicas' },
      { id: 'fracciones', text: 'Fracciones y Decimales' },
      { id: 'porcentajes', text: 'Porcentajes' },
      { id: 'ecuaciones', text: 'Ecuaciones de Primer Grado' },
      { id: 'sistemas', text: 'Sistemas de Ecuaciones' },
      { id: 'geometria', text: 'Geometría Básica' }
    ];

    const lenguaTopics = [
      { id: 'ortografia-basica', text: 'Ortografía Básica' },
      { id: 'morfologia', text: 'Morfología' },
      { id: 'sintaxis-simple', text: 'Sintaxis - Oración Simple' },
      { id: 'sintaxis-compuesta', text: 'Sintaxis - Oración Compuesta' },
      { id: 'literatura', text: 'Literatura Española' },
      { id: 'expresion-escrita', text: 'Expresión Escrita' }
    ];

    const inglesTopics = [
      { id: 'basic-vocabulary', text: 'Basic Vocabulary' },
      { id: 'present-tenses', text: 'Present Simple & Continuous' },
      { id: 'past-tenses', text: 'Past Simple & Past Continuous' },
      { id: 'future-tenses', text: 'Future Tenses' },
      { id: 'conditionals', text: 'Conditionals' },
      { id: 'listening-speaking', text: 'Listening & Speaking' }
    ];


    // --- Funciones de Navegación y Contenido ---
    window.showSubject = function(subject) {
      // Allow guests to see subjects, but warn about personalization
      if (!isAuthenticated && !isGuestMode) {
        showMessage('Por favor, inicia sesión o usa el modo invitado para acceder a las materias.', 4000);
        window.showAuthModal();
        return;
      }
      console.log('--- showSubject called ---');
      hideElement(mainContent);
      hideElement(quizContainer);
      document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
      hideElement(lessonContentDisplay);
      hideModalOverlay(authModalOverlay); // Ensure modal is not active

      const subjectPage = document.getElementById(subject + '-page');
      if (subjectPage) {
        showElement(subjectPage);
      }
      
      personalizeSubjectIntro(subject);
      // Only load and update progress if authenticated, otherwise it's just topic list
      if (isAuthenticated) {
          window.loadProgressAndDisplay(); // Call global version to load and display individual topic progress checks
          window.updateAllProgressBars(); // Call global version to update overall subject progress bars
      } else {
          // Clear progress indicators for guest mode
          [
              ...mathTopics.map(t => ({ subject: 'matematicas', topic: t })),
              ...lenguaTopics.map(t => ({ subject: 'lengua', topic: t })),
              ...inglesTopics.map(t => ({ subject: 'ingles', topic: t }))
            ].forEach(({ subject: sub, topic: tpc }) => {
              const indicator = document.getElementById(`progress-${sub}-${tpc.id}`);
              if (indicator) {
                indicator.innerHTML = '';
              }
            });
            const allProgressBars = document.querySelectorAll('.progress-bar-fill');
            allProgressBars.forEach(bar => bar.style.width = '0%');
            const allProgressTexts = document.querySelectorAll('.progress-text');
            allProgressTexts.forEach(text => text.textContent = '0% completado');
      }
    }

    window.showMainContent = function() {
      console.log('--- showMainContent called ---');
      document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
      hideElement(quizContainer);
      hideElement(lessonContentDisplay);
      hideModalOverlay(authModalOverlay); // Ensure modal is not active
      
      showElement(mainContent);
    }

    function personalizeSubjectIntro(subject) {
      const introElement = document.getElementById(subject + '-personalized-intro');
      if (!introElement) return;

      let introText = "";
      if (isAuthenticated && userLearningStyle) {
          const personalizedIntros = {
            matematicas: {
              visual: "🎨 Como eres una persona con estilo **visual**, hemos preparado esquemas, gráficos y representaciones visuales para cada tema de matemáticas. ¡Verás las matemáticas de una forma completamente nueva!",
              auditivo: "🔊 Perfecto para tu estilo **auditivo**: cada lección incluye explicaciones paso a paso, podcasts matemáticos y ejercicios que puedes resolver 'hablando' contigo mismo.",
              'lectura-escritura': "📝 Ideal para tu estilo de **lectura/escritura**: encontrarás resúmenes detallados, ejercicios escritos y la posibilidad de tomar notas estructuradas en cada tema.",
              kinestesico: "🏃 ¡Matemáticas en movimiento! Hemos diseñado actividades prácticas, manipulativas y ejercicios que puedes resolver moviéndote o usando objetos físicos."
            },
            lengua: {
              visual: "🎨 Tu aprendizaje **visual** te ayudará con mapas mentales, esquemas de sintaxis y representaciones gráficas de las reglas gramaticales.",
              auditivo: "🔊 Perfecto para tu estilo: lecturas en voz alta, ejercicios de dictado, y técnicas de memorización con ritmo y sonidos.",
              'lectura-escritura': "📝 En tu elemento: análisis de textos, ejercicios de escritura creativa y técnicas de estudio basadas en la lectura comprensiva.",
              kinestesico: "🏃 Lengua activa: dramatizaciones, juegos de roles y ejercicios donde puedas moverte mientras aprendes gramática y literatura."
            },
            ingles: {
              visual: "🎨 **Visual English**: flashcards, mind maps, videos y material gráfico para aprender vocabulario y gramática de forma visual.",
              auditivo: "🔊 Perfect for you: **listening exercises**, pronunciation practice, songs and audio materials to improve your English naturally.",
              'lectura-escritura': "📝 **Reading & Writing** focus: textos graduados, ejercicios de escritura y técnicas de estudio basadas en la lectura en inglés.",
              kinestesico: "🏃 **Active English**: role-plays, interactive games y actividades prácticas para aprender inglés moviéndote y experimentando."
            }
          };
          introText = personalizedIntros[subject] && personalizedIntros[subject][userLearningStyle];
          if (introText) {
            introText = `<strong>Personalizado para ti:</strong><br>${introText}`;
          } else {
            introText = "¡Bienvenido a la sección de " + subject.charAt(0).toUpperCase() + subject.slice(1) + "! Explora nuestros temas.";
          }
      } else {
          introText = "¡Bienvenido a la sección de " + subject.charAt(0).toUpperCase() + subject.slice(1) + "! Para una experiencia de aprendizaje personalizada, inicia sesión o regístrate.";
      }
      
      introElement.innerHTML = `<div style="background: #eef5fb; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; border-left: 5px solid var(--secondary-color); font-size: 1.1em; line-height: 1.6; color: var(--text-dark);">${introText}</div>`;
    }

    // --- Lesson Content Display (uses LLM for content) ---
    window.showLessonContent = async function(subject, topicId) {
        if (!isAuthenticated && !isGuestMode) {
            showMessage('Por favor, inicia sesión o usa el modo invitado para acceder al contenido de las lecciones.', 4000);
            window.showAuthModal();
            return;
        }
        console.log('--- showLessonContent called ---');
        hideElement(mainContent);
        hideElement(quizContainer);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
        hideModalOverlay(authModalOverlay); // Ensure modal is not active

        showElement(lessonContentDisplay);

        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonMaterialElement = document.getElementById('lesson-material');

        const topicName = topicId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        const subjectName = subject.charAt(0).toUpperCase() + subject.slice(1);
        lessonTitleElement.textContent = `Lección: ${topicName} de ${subjectName}`;
        lessonMaterialElement.innerHTML = '<p>Cargando contenido de la lección...</p>'; // Loading indicator

        // Generate content using LLM
        const generatedContent = await generateLessonContent(subject, topicId, userLearningStyle);
        lessonMaterialElement.innerHTML = generatedContent;

        // Add event listener to the "Completar lección" button within the generated content
        // This assumes the generated content will include a button with this specific text and purpose.
        const completeLessonButton = lessonMaterialElement.querySelector('button');
        if (completeLessonButton && (completeLessonButton.textContent.includes('Completar lección') || completeLessonButton.textContent.includes('Simular Completar Juego'))) {
            // Only allow completion if authenticated
            if (isAuthenticated) {
                completeLessonButton.onclick = () => window.simulateGameCompletion(subject, topicId);
            } else {
                completeLessonButton.style.display = 'none'; // Hide button for guests
                const completeMessage = document.createElement('p');
                completeMessage.textContent = 'Inicia sesión para guardar tu progreso de esta lección.';
                completeMessage.style.color = 'var(--accent-color)';
                completeMessage.style.fontWeight = 'bold';
                lessonMaterialElement.appendChild(completeMessage);
            }
        }
    }

    window.hideLessonContent = function() {
        console.log('--- hideLessonContent called ---');
        hideElement(lessonContentDisplay);

        let previouslyActiveSubjectId = null;
        document.querySelectorAll('.subject-page').forEach(page => {
            if (page.style.display === 'block') { // Check for active display
                previouslyActiveSubjectId = page.id.replace('-page', '');
                // No se remueve la clase 'active' aquí, ya que `showSubject` la gestionará.
                // Simplemente marcamos que existía una página activa.
            }
        });
        
        // Si había una página de asignatura activa, mostrarla de nuevo.
        // Si no, volver al contenido principal.
        if (previouslyActiveSubjectId) {
            window.showSubject(previouslyActiveSubjectId); // Re-activa la página de asignatura específica
        } else {
            window.showMainContent(); // Vuelve a la página principal
        }
    }

    window.simulateGameCompletion = function(subject, topicId) {
        if (!isAuthenticated) {
            showMessage("Necesitas iniciar sesión para guardar el progreso.", 3000);
            return;
        }
        showMessage('¡Felicidades! Has completado el juego interactivo. Tu progreso ha sido guardado.', 4000);
        window.saveProgress(subject, topicId, 'completed'); // Call global version
        window.hideLessonContent();
    }

    // --- Review System Functions ---
    let currentRating = 0; // To store the selected rating for a new review

    reviewRatingStars.querySelectorAll('button').forEach(starButton => {
        starButton.addEventListener('click', () => {
            currentRating = parseInt(starButton.dataset.rating);
            selectedRatingInput.value = currentRating;
            updateStarDisplay();
        });
    });

    function updateStarDisplay() {
        reviewRatingStars.querySelectorAll('button').forEach(starButton => {
            const rating = parseInt(starButton.dataset.rating);
            if (rating <= currentRating) {
                starButton.classList.add('selected');
            } else {
                starButton.classList.remove('selected');
            }
        });
    }

    reviewForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthenticated) {
            showMessage("Debes iniciar sesión para enviar una reseña.", 3000);
            return;
        }
        if (currentRating === 0) {
            showMessage("Por favor, selecciona una calificación en estrellas.", 3000);
            return;
        }

        const reviewText = reviewTextarea.value.trim();
        if (!reviewText) {
            showMessage("Por favor, escribe tu reseña antes de enviarla.", 3000);
            return;
        }

        try {
            const reviewsCollectionRef = collection(db, "reviews");
            await addDoc(reviewsCollectionRef, {
                userId: currentUserId,
                userName: currentUserName, // Use the stored user name
                text: reviewText,
                rating: currentRating,
                timestamp: serverTimestamp()
            });
            showMessage("¡Gracias! Tu reseña ha sido enviada.", 4000);
            reviewTextarea.value = ''; // Clear form
            currentRating = 0;
            selectedRatingInput.value = 0;
            updateStarDisplay();
        } catch (error) {
            console.error("Error submitting review:", error);
            showMessage("Error al enviar la reseña: " + error.message, 5000);
        }
    });

    function renderReviews(reviews) {
        reviewsContainer.innerHTML = ''; // Clear previous reviews
        if (reviews.length === 0) {
            reviewsContainer.innerHTML = '<p style="text-align: center; color: var(--text-light);">Aún no hay reseñas. ¡Sé el primero en dejar una!</p>';
            return;
        }
        reviews.forEach(review => {
            const reviewCard = document.createElement('div');
            reviewCard.classList.add('review-card');
            reviewCard.innerHTML = `
                <p class="review-text">"${review.text}"</p>
                <div class="review-rating">${'⭐'.repeat(review.rating)}</div>
                <p class="reviewer-name">${review.userName || 'Anónimo'}</p>
            `;
            reviewsContainer.appendChild(reviewCard);
        });
    }

    function updateReviewFormVisibility() {
        if (isAuthenticated) {
            showElement(reviewForm);
            hideElement(reviewAuthMessage);
        } else {
            hideElement(reviewForm);
            showElement(reviewAuthMessage);
        }
    }

    // --- Initial setup on page load ---
    document.addEventListener('DOMContentLoaded', async function() {
        // Explicitly hide all content areas that are not the main content by default
        hideElement(quizContainer);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
        hideElement(lessonContentDisplay);
        hideElement(customMessage); // Ensure custom message is hidden
        hideModalOverlay(authModalOverlay); // Ensure modal is hidden using its CSS class

        // Try to sign in anonymously for a seamless guest experience or if no auth token is available (e.g., GitHub)
        try {
            await signInAnonymously(auth);
            // onAuthStateChanged will handle setting isAuthenticated/isGuestMode and visibility
        } catch (error) {
            console.warn("Failed to sign in anonymously:", error);
            isAuthenticated = false;
            currentUserId = null;
            isGuestMode = false;
            updateNavigationVisibility(); // Ensure correct nav state if anonymous fails
            showElement(mainContent); // Show main content if no auth possible
        }

        // Display the main content initially until Firebase auth state determines otherwise.
        showElement(mainContent);
        
        // Load reviews initially and listen for real-time updates
        const reviewsCollectionRef = collection(db, "reviews");
        onSnapshot(query(reviewsCollectionRef, orderBy("timestamp", "desc")), (snapshot) => {
            const reviews = [];
            snapshot.forEach(doc => {
                reviews.push(doc.data());
            });
            renderReviews(reviews);
        }, (error) => {
            console.error("Error fetching real-time reviews: ", error);
            showMessage("Error al cargar las reseñas.", 3000);
        });

        updateStarDisplay(); // Initialize star display
    });
  
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiGenio - Tu aliado en el aprendizaje</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #3f68a2; /* Azul m√°s suave */
      --secondary-color: #6ed3b3; /* Azul verdoso del logo */
      --accent-color: #f39c12; /* Naranja para √©nfasis */
      --text-dark: #34495e;
      --text-light: #5e6c7d;
      --bg-light: #f8f9fa;
      --bg-white: #ffffff;
      --shadow-light: rgba(0, 0, 0, 0.08);
      --border-radius: 10px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-light);
      color: var(--text-light);
      line-height: 1.7;
    }

    /* Header */
    header {
      background: var(--primary-color);
      color: var(--bg-white);
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 2px 10px var(--shadow-light);
    }
    header .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px; /* Espacio entre logo y texto */
      margin-bottom: 10px;
    }
    header .logo-container img {
      height: 80px; /* Tama√±o del logo */
      width: auto;
    }
    header h1 {
      font-size: 3em;
      margin: 0;
      font-weight: 700;
      line-height: 1;
    }
    header p {
      font-size: 1.3em;
      margin-top: 5px;
      font-weight: 300;
    }

    /* Navigation */
    nav {
      background: var(--secondary-color);
      display: flex;
      justify-content: center;
      padding: 15px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap; /* Allow navigation items to wrap on smaller screens */
    }
    nav a, nav button {
      color: var(--bg-white);
      margin: 0 20px;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1em;
      padding: 5px 0;
      transition: color 0.3s ease, border-bottom 0.3s ease;
      border-bottom: 2px solid transparent;
      background: none;
      border: none;
      cursor: pointer;
    }
    nav a:hover, nav button:hover {
      color: var(--accent-color);
      border-bottom: 2px solid var(--accent-color);
    }
    nav a.disabled {
      color: rgba(255, 255, 255, 0.5);
      cursor: not-allowed;
      border-bottom: 2px solid transparent;
    }

    /* Hero Section */
    .hero {
      padding: 80px 20px;
      text-align: center;
      background: linear-gradient(to bottom right, #e0f7fa, #f0f8ff);
      color: var(--text-dark);
    }
    .hero h1 {
      font-size: 3.2em;
      margin-bottom: 20px;
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1.2;
    }
    .hero p {
      font-size: 1.4em;
      color: var(--text-light);
      max-width: 700px;
      margin: 0 auto;
      font-weight: 400;
    }

    /* Sections */
    .section {
      padding: 60px 20px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .section h2, .section h3 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.5em;
      font-weight: 700;
      position: relative;
    }
    .section h2::after, .section h3::after {
        content: '';
        display: block;
        width: 80px;
        height: 4px;
        background: var(--secondary-color);
        margin: 15px auto 0;
        border-radius: 2px;
    }
    .section p {
        font-size: 1.1em;
        margin-bottom: 1.5em;
        color: var(--text-light);
    }
    .section ul {
        list-style: none;
        padding-left: 0;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }
    .section ul li {
        background: var(--bg-white);
        padding: 15px 25px;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px var(--shadow-light);
        font-size: 1.15em;
        color: var(--text-dark);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.3s ease;
    }
    .section ul li:hover {
        transform: translateY(-5px);
    }
    .section ul li img { /* For icons in lists */
        height: 30px;
        width: 30px;
    }
    .section img { /* General images within sections */
      display: block;
      margin: 0 auto 30px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px var(--shadow-light);
    }

    /* Cards */
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      margin-top: 30px;
    }
    .card {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      box-shadow: 0 6px 20px var(--shadow-light);
      padding: 30px;
      width: 300px;
      text-align: center;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    .card img {
      width: 80px; /* Bigger icons for cards */
      height: 80px;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    .card:hover img {
        transform: scale(1.1);
    }
    .card h3 {
      font-size: 1.8em;
      color: var(--primary-color);
      margin-bottom: 15px;
      font-weight: 700;
    }
    .card p {
      font-size: 1em;
      color: var(--text-light);
      line-height: 1.6;
    }
    .clickable-card {
      cursor: pointer;
    }
    .card-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(63, 104, 162, 0.95); /* Usar --primary-color con opacidad */
      color: var(--bg-white);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-weight: 600;
      font-size: 1.5em;
      border-radius: var(--border-radius);
    }
    .clickable-card:hover .card-overlay {
      opacity: 1;
    }

    /* Subject Pages */
    .subject-page {
      padding: 40px 20px;
    }
    .back-button {
      background: var(--secondary-color);
      color: var(--bg-white);
      border: none;
      padding: 12px 25px;
      border-radius: var(--border-radius);
      cursor: pointer;
      margin-bottom: 30px;
      font-size: 1.1em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      display: inline-block; /* Para que margin-bottom funcione mejor */
    }
    .back-button:hover {
      background: var(--primary-color);
      transform: translateY(-2px);
    }
    .subject-page h1 {
      text-align: center;
      color: var(--primary-color);
      font-size: 3em;
      margin-bottom: 40px;
      font-weight: 700;
    }
    .subject-page .topic-list {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 4px 15px var(--shadow-light);
    }
    .subject-page .topic-list h2 {
      text-align: center;
      color: var(--text-dark);
      margin-bottom: 25px;
      font-size: 2em;
      font-weight: 600;
    }
    .topic-item {
      background: #fdfdfd; /* Blanco m√°s claro */
      margin: 15px 0;
      padding: 20px;
      border-radius: var(--border-radius);
      border-left: 5px solid var(--secondary-color);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
    }
    .topic-item:hover {
      background: #eef5fb; /* Ligeramente azulado al hover */
      transform: translateX(8px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .topic-title {
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
      font-size: 1.25em;
      display: flex;
      align-items: center;
      justify-content: space-between; /* Para alinear el badge y el indicador de progreso */
    }
    .topic-description {
      color: var(--text-light);
      font-size: 0.95em;
    }
    .level-badge {
      display: inline-block;
      background: var(--accent-color);
      color: var(--bg-white);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      margin-left: 15px;
      font-weight: 600;
    }
    .progress-indicator {
      font-size: 0.9em;
      font-weight: 600;
      color: green;
      margin-left: auto; /* Empuja el indicador a la derecha */
    }

    /* Contact Form */
    .contact-form {
      text-align: center;
      background: var(--bg-white);
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px var(--shadow-light);
      max-width: 700px;
      margin: 0 auto;
    }
    .contact-form p {
      font-size: 1.1em;
      margin-bottom: 25px;
      color: var(--text-dark);
    }
    .contact-form input,
    .contact-form textarea {
      width: calc(100% - 40px); /* Ajuste para padding */
      padding: 15px 20px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      color: var(--text-dark);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .contact-form input:focus,
    .contact-form textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(63, 104, 162, 0.2);
      outline: none;
    }
    .contact-form button {
      background: var(--primary-color);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.2em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: 20px;
    }
    .contact-form button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    /* Footer */
    footer {
      background: var(--primary-color);
      color: white;
      text-align: center;
      padding: 25px;
      margin-top: 50px;
      font-size: 0.95em;
    }

    /* Quiz Styles */
    #quiz-container {
      background: var(--bg-white);
      max-width: 550px;
      margin: 60px auto;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px var(--shadow-light);
    }
    #quiz-container h2 {
      color: var(--primary-color);
      margin-bottom: 30px;
      text-align: center;
      font-size: 2.2em;
      font-weight: 700;
    }
    .question {
      margin-bottom: 25px;
      font-weight: 600;
      font-size: 1.3em;
      color: var(--text-dark);
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .options button {
      width: 100%;
      padding: 15px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.1em;
      transition: background 0.3s ease, transform 0.2s ease;
      text-align: left;
    }
    .options button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }
    /* Result Styles */
    #result-message {
      font-weight: 700;
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
      font-size: 1.5em;
      background: #eef5fb;
      padding: 15px;
      border-radius: var(--border-radius);
      border-left: 5px solid var(--secondary-color);
    }
    /* ADHD Recommendations */
    #tdah-warning {
      margin-top: 2.5rem;
      padding: 1.5rem;
      background-color: #ffe0b2; /* Tono naranja suave */
      border-radius: var(--border-radius);
      color: #b35900;
      font-weight: 600;
      max-width: 750px;
      margin-left: auto;
      margin-right: auto;
      border-left: 5px solid var(--accent-color);
      font-size: 1.1em;
    }
    #study-advice {
      max-width: 750px;
      margin: 0 auto 2rem auto;
      font-weight: 600;
      color: var(--text-dark);
      padding: 1.5rem;
      background: var(--bg-white);
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-left: 5px solid var(--primary-color);
      font-size: 1.1em;
    }

    /* Progress Bar Styles */
    .progress-bar-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: var(--border-radius);
      overflow: hidden;
      margin-bottom: 25px;
      height: 30px;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary-color); /* Green color for progress */
      width: 0%; /* Will be updated by JS */
      border-radius: var(--border-radius) 0 0 var(--border-radius);
      transition: width 0.5s ease-in-out;
    }
    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 30px;
      color: var(--text-dark);
      font-weight: 600;
      font-size: 1em;
    }

    /* Lesson Content Display */
    #lesson-content-display {
        background: var(--bg-white);
        max-width: 900px;
        margin: 60px auto;
        padding: 40px;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 25px var(--shadow-light);
        min-height: 500px; /* Para que no se vea vac√≠o */
    }
    #lesson-material p {
        font-size: 1.1em;
        margin-bottom: 1.5em;
        color: var(--text-light);
    }
    #lesson-material video,
    #lesson-material audio,
    #lesson-material img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 25px auto;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #lesson-material textarea {
        width: calc(100% - 40px);
        padding: 15px 20px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-family: 'Poppins', sans-serif;
        font-size: 1em;
        min-height: 120px;
        margin-top: 15px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    #lesson-material .interactive-game-placeholder {
        background-color: #eef5fb; /* Tono azul claro */
        border: 2px dashed var(--secondary-color);
        padding: 60px;
        text-align: center;
        font-style: italic;
        color: var(--text-light);
        border-radius: var(--border-radius);
        margin: 30px 0;
        font-size: 1.2em;
    }
    #lesson-material button {
        background: var(--accent-color);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1.1em;
        font-weight: 600;
        transition: background 0.3s ease, transform 0.2s ease;
        margin-top: 20px;
    }
    #lesson-material button:hover {
        background: #e67e22; /* Tono m√°s oscuro de naranja */
        transform: translateY(-2px);
    }

    /* Custom Message Box */
    #custom-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: white;
        padding: 15px 30px;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        font-weight: 600;
    }
    #custom-message.show {
        opacity: 1;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex; /* Always flex, visibility handled by opacity and pointer-events */
      align-items: center;
      justify-content: center;
      z-index: 999;
      opacity: 0;
      pointer-events: none; /* Prevent interaction when hidden */
      transition: opacity 0.3s ease-in-out;
    }
    .modal-overlay.active {
        opacity: 1;
        pointer-events: all; /* Enable interaction when active */
    }

    /* Authentication Form Styles (within modal) */
    #auth-container {
      background: var(--bg-white);
      max-width: 450px;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px var(--shadow-light);
      text-align: center;
      position: relative; /* Needed for close button positioning */
    }
    #auth-container h2 {
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.2em;
      font-weight: 700;
    }
    #auth-container form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #auth-container input[type="email"],
    #auth-container input[type="password"] {
      width: calc(100% - 40px);
      padding: 15px 20px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      color: var(--text-dark);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #auth-container input[type="email"]:focus,
    #auth-container input[type="password"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(63, 104, 162, 0.2);
      outline: none;
    }
    #auth-container button {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1.2em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: 10px;
    }
    #auth-container button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }
    #auth-container .toggle-form-link {
        font-size: 0.95em;
        margin-top: 20px;
        color: var(--text-light);
        cursor: pointer;
        text-decoration: underline;
    }
    #auth-container .toggle-form-link:hover {
        color: var(--primary-color);
    }
    .close-modal-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.8em;
        color: var(--text-light);
        cursor: pointer;
        transition: color 0.3s ease;
    }
    .close-modal-button:hover {
        color: var(--primary-color);
    }


    /* Responsive adjustments */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2.2em;
      }
      header .logo-container img {
        height: 60px;
      }
      .hero h1 {
        font-size: 2.5em;
      }
      .hero p {
        font-size: 1em;
      }
      nav {
        flex-direction: column;
        align-items: center;
        padding: 10px;
      }
      nav a, nav button {
        margin: 5px 0;
        font-size: 1em;
      }
      .section h2, .section h3 {
        font-size: 2em;
      }
      .cards, .testimonials-grid {
        flex-direction: column;
        align-items: center;
      }
      .card, .testimonial-card {
        width: 90%;
        max-width: 350px;
      }
      .contact-form input,
      .contact-form textarea {
        width: calc(100% - 20px);
        padding: 12px 10px;
      }
      #quiz-container, #lesson-content-display, #auth-container {
        margin: 30px auto;
        padding: 25px;
      }
      .question {
        font-size: 1.1em;
      }
    }
  </style>
</head>
<body>

  <!-- Custom Message Box -->
  <div id="custom-message"></div>

  <!-- Authentication Modal -->
  <div id="auth-modal-overlay" class="modal-overlay">
    <div id="auth-container">
      <button class="close-modal-button" onclick="window.hideAuthModal()">&times;</button>
      <div id="login-form">
        <h2>Iniciar Sesi√≥n</h2>
        <form id="login-email-form">
          <input type="email" id="login-email" placeholder="Correo Electr√≥nico" required />
          <input type="password" id="login-password" placeholder="Contrase√±a" required />
          <button type="submit">Iniciar Sesi√≥n</button>
        </form>
        <p class="toggle-form-link" onclick="window.toggleAuthForm('register')">¬øNo tienes cuenta? Reg√≠strate</p>
      </div>

      <div id="register-form">
        <h2>Registrarse</h2>
        <form id="register-email-form">
          <input type="email" id="register-email" placeholder="Correo Electr√≥nico" required />
          <input type="password" id="register-password" placeholder="Contrase√±a" required />
          <button type="submit">Registrarse</button>
        </form>
        <p class="toggle-form-link" onclick="window.toggleAuthForm('login')">¬øYa tienes cuenta? Inicia Sesi√≥n</p>
      </div>
    </div>
  </div>


  <div id="quiz-container">
    <h2>Cuestionario de Estilo de Aprendizaje</h2>
    <div id="question-text" class="question"></div>
    <div id="options" class="options"></div>
  </div>

  <div id="main-content">
    <header>
      <div class="logo-container">
        <img src="https://placehold.co/80x80/6ed3b3/ffffff?text=LOGO" alt="MultiGenio Logo" />
        <h1>MultiGenio</h1>
      </div>
      <p>Tu aliado en el aprendizaje</p>
    </header>

    <nav>
      <a href="#que-es">¬øQu√© es?</a>
      <a href="#materias">Materias</a>
      <a href="#beneficios">Beneficios</a>
      <a href="#testimonios">Testimonios</a>
      <a href="#contacto">Contacto</a>
      <a href="#" id="auth-nav-link" onclick="window.showAuthModal()">Iniciar Sesi√≥n / Registrarse</a>
      <a href="#" id="quiz-nav-link" onclick="window.showQuestion()">Cuestionario</a>
      <button id="logout-button">Cerrar Sesi√≥n</button>
    </nav>

    <section class="hero">
      <h1>Tu tutor virtual inteligente para Matem√°ticas, Ingl√©s y Lengua</h1>
      <p>Un m√©todo de aprendizaje din√°mico, adaptado a tu ritmo y estilo, dise√±ado para potenciar tu concentraci√≥n y comprensi√≥n.</p>
    </section>

    <div id="result-message"></div>
    <div id="study-advice"></div>
    <div id="tdah-warning">
      ‚ö†Ô∏è Si presentas indicios de TDAH, MultiGenio te ofrecer√° recursos y estrategias especiales para ayudarte a mantener la concentraci√≥n y aprovechar tu estilo de aprendizaje de la forma m√°s efectiva.
    </div>

    <section class="section" id="que-es">
      <h2>¬øQu√© es MultiGenio?</h2>
      <img src="https://img.icons8.com/color/96/online-support.png" alt="Estudio interactivo" style="width: 100px; height: 100px;"/>
      <p>
        <strong>MultiGenio</strong> es una plataforma educativa innovadora que revoluciona el aprendizaje, especialmente dise√±ada para estudiantes con **TDAH**, dificultades de atenci√≥n o aquellos que buscan un m√©todo de estudio verdaderamente personalizado. A trav√©s de la integraci√≥n de **Inteligencia Artificial Avanzada**, MultiGenio no solo se adapta al ritmo del alumno, sino que moldea activamente la experiencia educativa para maximizar la absorci√≥n del conocimiento y el mantenimiento del inter√©s.
      </p>

      <h3>üß† La Inteligencia Artificial en Acci√≥n: Un Enfoque Adaptativo</h3>
      <img src="https://img.icons8.com/color/96/artificial-intelligence.png" alt="Inteligencia Artificial" style="width: 100px; height: 100px;"/>
      <p>
        Nuestra IA propietaria va m√°s all√° de un simple algoritmo. Analiza patrones de respuesta en el cuestionario inicial, el progreso en los juegos interactivos, el tiempo dedicado a cada tema y las preferencias de material (visual, auditivo, etc.). Con estos datos, el sistema ajusta din√°micamente la dificultad de los ejercicios, prioriza ciertos tipos de contenido y sugiere rutas de aprendizaje alternativas. Por ejemplo, si un estudiante visual tiene dificultades con un concepto, la IA podr√≠a recomendar un video explicativo animado o un mapa mental interactivo antes de ofrecer otro tipo de ejercicio. Para alumnos con TDAH, la IA puede fragmentar lecciones extensas en m√≥dulos m√°s cortos, incorporar micro-descansos activos o activar alertas visuales/auditivas sutiles para refocus.
      </p>
      <p>
        El objetivo es crear un "tutor virtual" que comprende las fortalezas y desaf√≠os individuales, proporcionando una experiencia educativa que se siente hecha a la medida, minimizando las distracciones y potenciando la concentraci√≥n.
      </p>

      <h2>üìã Cuestionario Inicial: Tu Huella de Aprendizaje</h2>
      <img src="https://img.icons8.com/color/96/quiz.png" alt="Cuestionario" style="width: 100px; height: 100px;"/>
      <p>
        Antes de sumergirte en el aprendizaje, MultiGenio te invita a un **cuestionario interactivo y estrat√©gico de 5 preguntas**. Este no es un simple test; es una herramienta clave para nuestra IA. Las preguntas est√°n cuidadosamente dise√±adas para identificar tu estilo de aprendizaje predominante entre:
      </p>
      <ul>
        <li><img src="https://img.icons8.com/color/48/eye.png" alt="Visual icon"/> <strong>Visual:</strong> Aprendes mejor viendo im√°genes, gr√°ficos, diagramas y videos.</li>
        <li><img src="https://img.icons8.com/color/48/ear.png" alt="Auditivo icon"/> <strong>Auditivo:</strong> Retienes informaci√≥n escuchando explicaciones, debates o audios.</li>
        <li><img src="https://img.icons8.com/color/48/writing.png" alt="Lectura/Escritura icon"/> <strong>Lectura/Escritura:</strong> Tu fuerza est√° en leer textos, tomar notas y escribir res√∫menes.</li>
        <li><img src="https://img.icons8.com/color/48/running.png" alt="Kinest√©sico icon"/> <strong>Kinest√©sico:</strong> Necesitas "hacer" para aprender; prefieres actividades pr√°cticas y movimiento.</li>
      </ul>
      <p>
        Adem√°s, una de las preguntas est√° formulada para detectar indicios que podr√≠an ser compatibles con TDAH. Si se identifican estas se√±ales, la plataforma activar√° un conjunto de estrategias pedag√≥gicas y recursos especiales, como temporizadores de foco, desaf√≠os de atenci√≥n y formatos de contenido adaptados, para asegurar una experiencia de aprendizaje √≥ptima y libre de frustraciones. Este perfil inicial es la base sobre la cual la IA personaliza cada aspecto de tu trayectoria en MultiGenio.
      </p>
    </section>
   
    <section class="section" id="materias">
      <h2>Materias que puedes aprender</h2>
      <div class="cards">
        <div class="card clickable-card" onclick="window.showSubject('matematicas')">
          <img src="https://img.icons8.com/color/96/calculator.png" alt="Matem√°ticas" />
          <h3>Matem√°ticas</h3>
          <p>Desde sumas y divisiones hasta √°lgebra de 3¬∫ de ESO. Todo con juegos mentales, visuales y l√≥gica adaptada a ti.</p>
          <div class="card-overlay">
            <span>¬°Haz clic para empezar!</span>
          </div>
        </div>
        <div class="card clickable-card" onclick="window.showSubject('lengua')">
          <img src="https://img.icons8.com/color/96/book.png" alt="Lengua" />
          <h3>Lengua</h3>
          <p>Domina la morfolog√≠a, sintaxis y reglas ortogr√°ficas con ejemplos creativos y pr√°cticas f√°ciles de recordar.</p>
          <div class="card-overlay">
            <span>¬°Haz clic para empezar!</span>
          </div>
        </div>
        <div class="card clickable-card" onclick="window.showSubject('ingles')">
          <img src="https://img.icons8.com/color/96/usa.png" alt="Ingl√©s" />
          <h3>Ingl√©s</h3>
          <p>Aprende desde A1 hasta B1: vocabulario, gram√°tica, listening y speaking. Con apoyo visual y audios.</p>
          <div class="card-overlay">
            <span>¬°Haz clic para empezar!</span>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="beneficios">
      <h2>¬øPor qu√© elegir MultiGenio?</h2>
      <ul>
        <li><img src="https://img.icons8.com/color/48/star--v1.png" alt="Star icon"/> Explicaciones adaptadas a estudiantes con TDA/TDAH</li>
        <li><img src="https://img.icons8.com/color/48/video-camera.png" alt="Video icon"/> Videos, ejemplos y contenido creativo</li>
        <li><img src="https://img.icons8.com/color/48/brain.png" alt="Brain icon"/> Aprende a tu propio ritmo, sin presi√≥n</li>
        <li><img src="https://img.icons8.com/color/48/graduation-cap.png" alt="Graduation cap icon"/> Ideal para padres, docentes y alumnos</li>
      </ul>
    </section>

    <section class="section" id="testimonios">
      <h2>Lo que dicen nuestros alumnos</h2>
      <div class="cards testimonials-grid">
        <div class="card testimonial-card">
          <img src="https://img.icons8.com/color/96/student-male.png" alt="Estudiante 1" />
          <h3>Laura G.</h3>
          <p>"¬°MultiGenio cambi√≥ mi forma de ver las matem√°ticas! Siempre me frustraba, pero con sus explicaciones visuales y los juegos interactivos, ahora entiendo todo mucho mejor. ¬°Recomendad√≠simo!"</p>
          <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
        <div class="card testimonial-card">
          <img src="https://img.icons8.com/color/96/student-female.png" alt="Estudiante 2" />
          <h3>Pablo R.</h3>
          <p>"Como padre de un ni√±o con TDAH, encontrar MultiGenio ha sido una bendici√≥n. La paciencia y el enfoque adaptado de la plataforma son incre√≠bles. Mi hijo est√° motivado y aprendiendo sin estr√©s."</p>
          <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
        <div class="card testimonial-card">
          <img src="https://img.icons8.com/color/96/teacher.png" alt="Estudiante 3" />
          <h3>Sof√≠a M. (Profesora)</h3>
          <p>"He probado muchas herramientas, pero MultiGenio es √∫nica por su capacidad de adaptaci√≥n. La IA es una maravilla para detectar y apoyar a cada alumno seg√∫n su estilo. La recomiendo a todos mis colegas."</p>
          <div class="rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
        </div>
      </div>
    </section>

    <section class="section" id="contacto">
      <h2>Contacto</h2>
      <div class="contact-form">
        <p>¬øQuieres probar MultiGenio o tienes dudas? Env√≠anos un mensaje:</p>
        <form>
          <input type="text" placeholder="Tu nombre" required /><br />
          <input type="email" placeholder="Tu correo electr√≥nico" required /><br />
          <textarea placeholder="Tu mensaje..." rows="5" required></textarea><br />
          <button type="submit">Enviar mensaje</button>
        </form>
      </div>
    </section>

    <script>
      window.chatbaseConfig = {
        chatbotId: "frw3UKvg6MK3c9Zw-bZAu"
      };
    </script>
    <script src="https://www.chatbase.co/embed.min.js" defer></script>

    <footer>
      <p>&copy; 2025 MultiGenio. Todos los derechos reservados.</p>
    </footer>
  </div>

  <div id="matematicas-page" class="subject-page">
    <div class="section">
      <button class="back-button" onclick="window.showMainContent()">‚Üê Volver al inicio</button>
      <h1 style="text-align: center; color: var(--primary-color);">üìä Matem√°ticas</h1>
      <div id="math-personalized-intro"></div>

      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="matematicas-progress-fill" style="width: 0%;"></div>
        <span class="progress-text" id="matematicas-progress-text">0% completado</span>
      </div>
      
      <div class="topic-list">
        <h2>Temario por niveles</h2>
        
        <div class="topic-item" onclick="window.showLessonContent('matematicas', 'operaciones-basicas')">
          <div class="topic-title">Operaciones B√°sicas <span class="level-badge">Primaria</span>
            <span class="progress-indicator" id="progress-matematicas-operaciones-basicas"></span>
          </div>
          <div class="topic-description">Suma, resta, multiplicaci√≥n y divisi√≥n. Problemas pr√°cticos del d√≠a a d√≠a.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('matematicas', 'fracciones')">
          <div class="topic-title">Fracciones y Decimales <span class="level-badge">6¬∫ Primaria</span>
            <span class="progress-indicator" id="progress-matematicas-fracciones"></span>
          </div>
          <div class="topic-description">Conceptos, operaciones y equivalencias. Con ejemplos visuales.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('matematicas', 'porcentajes')">
          <div class="topic-title">Porcentajes <span class="level-badge">1¬∫ ESO</span>
            <span class="progress-indicator" id="progress-matematicas-porcentajes"></span>
          </div>
          <div class="topic-description">C√°lculo de porcentajes, aumentos y descuentos.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('matematicas', 'ecuaciones')">
          <div class="topic-title">Ecuaciones de Primer Grado <span class="level-badge">2¬∫ ESO</span>
            <span class="progress-indicator" id="progress-matematicas-ecuaciones"></span>
          </div>
          <div class="topic-description">Resoluci√≥n paso a paso con m√©todos visuales.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('matematicas', 'sistemas')">
          <div class="topic-title">Sistemas de Ecuaciones <span class="level-badge">3¬∫ ESO</span>
            <span class="progress-indicator" id="progress-matematicas-sistemas"></span>
          </div>
          <div class="topic-description">M√©todos de sustituci√≥n, igualaci√≥n y reducci√≥n.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('matematicas', 'geometria')">
          <div class="topic-title">Geometr√≠a B√°sica <span class="level-badge">1¬∫-2¬∫ ESO</span>
            <span class="progress-indicator" id="progress-matematicas-geometria"></span>
          </div>
          <div class="topic-description">√Åreas, per√≠metros y vol√∫menes de figuras b√°sicas.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="lengua-page" class="subject-page">
    <div class="section">
      <button class="back-button" onclick="window.showMainContent()">‚Üê Volver al inicio</button>
      <h1 style="text-align: center; color: var(--primary-color);">üìö Lengua Espa√±ola</h1>
      <div id="lengua-personalized-intro"></div>

      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="lengua-progress-fill" style="width: 0%;"></div>
        <span class="progress-text" id="lengua-progress-text">0% completado</span>
      </div>
      
      <div class="topic-list">
        <h2>Temario por niveles</h2>
        
        <div class="topic-item" onclick="window.showLessonContent('lengua', 'ortografia-basica')">
          <div class="topic-title">Ortograf√≠a B√°sica <span class="level-badge">Primaria</span>
            <span class="progress-indicator" id="progress-lengua-ortografia-basica"></span>
          </div>
          <div class="topic-description">Acentuaci√≥n, uso de b/v, g/j, h. Con ejercicios pr√°cticos.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('lengua', 'morfologia')">
          <div class="topic-title">Morfolog√≠a <span class="level-badge">1¬∫ ESO</span>
            <span class="progress-indicator" id="progress-lengua-morfologia"></span>
          </div>
          <div class="topic-description">Categor√≠as gramaticales: sustantivos, adjetivos, verbos, etc.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('lengua', 'sintaxis-simple')">
          <div class="topic-title">Sintaxis - Oraci√≥n Simple <span class="level-badge">2¬∫ ESO</span>
            <span class="progress-indicator" id="progress-lengua-sintaxis-simple"></span>
          </div>
          <div class="topic-description">Sujeto, predicado y complementos b√°sicos.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('lengua', 'sintaxis-compuesta')">
          <div class="topic-title">Sintaxis - Oraci√≥n Compuesta <span class="level-badge">3¬∫ ESO</span>
            <span class="progress-indicator" id="progress-lengua-sintaxis-compuesta"></span>
          </div>
          <div class="topic-description">Oraciones coordinadas y subordinadas.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('lengua', 'literatura')">
          <div class="topic-title">Literatura Espa√±ola <span class="level-badge">2¬∫-3¬∫ ESO</span>
            <span class="progress-indicator" id="progress-lengua-literatura"></span>
          </div>
          <div class="topic-description">G√©neros literarios, m√©trica y autores principales.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('lengua', 'expresion-escrita')">
          <div class="topic-title">Expresi√≥n Escrita <span class="level-badge">Todos</span>
            <span class="progress-indicator" id="progress-lengua-expresion-escrita"></span>
          </div>
          <div class="topic-description">T√©cnicas de redacci√≥n, tipos de texto y coherencia.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="ingles-page" class="subject-page">
    <div class="section">
      <button class="back-button" onclick="window.showMainContent()">‚Üê Volver al inicio</button>
      <h1 style="text-align: center; color: var(--primary-color);">üá¨üáß English</h1>
      <div id="ingles-personalized-intro"></div>

      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="ingles-progress-fill" style="width: 0%;"></div>
        <span class="progress-text" id="ingles-progress-text">0% completado</span>
      </div>
      
      <div class="topic-list">
        <h2>Temario por niveles</h2>
        
        <div class="topic-item" onclick="window.showLessonContent('ingles', 'basic-vocabulary')">
          <div class="topic-title">Basic Vocabulary <span class="level-badge">A1</span>
            <span class="progress-indicator" id="progress-ingles-basic-vocabulary"></span>
          </div>
          <div class="topic-description">Numbers, colors, family, daily routines. Con apoyo visual.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('ingles', 'present-tenses')">
          <div class="topic-title">Present Simple & Continuous <span class="level-badge">A1-A2</span>
            <span class="progress-indicator" id="progress-ingles-present-tenses"></span>
          </div>
          <div class="topic-description">Tiempos verbales b√°sicos con ejemplos pr√°cticos.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('ingles', 'past-tenses')">
          <div class="topic-title">Past Simple & Past Continuous <span class="level-badge">A2</span>
            <span class="progress-indicator" id="progress-ingles-past-tenses"></span>
          </div>
          <div class="topic-description">Narraci√≥n en pasado, verbos regulares e irregulares.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('ingles', 'future-tenses')">
          <div class="topic-title">Future Tenses <span class="level-badge">A2-B1</span>
            <span class="progress-indicator" id="progress-ingles-future-tenses"></span>
          </div>
          <div class="topic-description">Will, going to, present continuous for future.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('ingles', 'conditionals')">
          <div class="topic-title">Conditionals <span class="level-badge">B1</span>
            <span class="progress-indicator" id="progress-ingles-conditionals"></span>
          </div>
          <div class="topic-description">First, second and third conditional sentences.</div>
        </div>
        
        <div class="topic-item" onclick="window.showLessonContent('ingles', 'listening-speaking')">
          <div class="topic-title">Listening & Speaking <span class="level-badge">A1-B1</span>
            <span class="progress-indicator" id="progress-ingles-listening-speaking"></span>
          </div>
          <div class="topic-description">Ejercicios de comprensi√≥n auditiva y pronunciaci√≥n.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="lesson-content-display">
    <button class="back-button" onclick="window.hideLessonContent()">‚Üê Volver al temario</button>
    <h2 id="lesson-title"></h2>
    <div id="lesson-material"></div>
  </div>


  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDklyhhZOV3c2KbbrvAZOpoUitPBWgRBOQ",
      authDomain: "multigenio-39890.firebaseapp.com",
      projectId: "multigenio-39890",
      storageBucket: "multigenio-39890.firebasestorage.app",
      messagingSenderId: "881137429405",
      appId: "1:881137429405:web:9f061138bdf43b00dd5d74",
      measurementId: "G-9SQX18GVH6"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app); // Initialize Firebase Auth service
    const db = getFirestore(app); // Initialize Firestore

    // DOM elements
    const authModalOverlay = document.getElementById('auth-modal-overlay');
    const authContainer = document.getElementById('auth-container');
    const loginFormDiv = document.getElementById('login-form');
    const registerFormDiv = document.getElementById('register-form');
    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const registerEmailInput = document.getElementById('register-email');
    const registerPasswordInput = document.getElementById('register-password');
    const logoutButton = document.getElementById('logout-button');
    const quizNavLink = document.getElementById('quiz-nav-link');
    const authNavLink = document.getElementById('auth-nav-link');

    const quizContainer = document.getElementById('quiz-container');
    const mainContent = document.getElementById('main-content');
    const questionText = document.getElementById('question-text');
    const optionsDiv = document.getElementById('options');
    const resultMessage = document.getElementById('result-message');
    const tdahWarning = document.getElementById('tdah-warning');
    const studyAdvice = document.getElementById('study-advice');
    const lessonContentDisplay = document.getElementById('lesson-content-display');
    const customMessage = document.getElementById('custom-message');

    let isAuthenticated = false; // Flag to track authentication status
    let currentUserId = null; // Store the current user ID
    let userLearningStyle = 'visual'; // Default learning style, updated by quiz or Firestore
    let userTDAHStatus = 'no'; // Default TDAH status, updated by quiz or Firestore

    // Gemini API Configuration
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=";
    const GEMINI_API_KEY = ""; // Leave as empty string, Canvas will provide it at runtime

    // --- Utility Functions ---
    function showMessage(message, duration = 3000) {
        customMessage.textContent = message;
        customMessage.style.display = 'block';
        customMessage.classList.add('show');
        setTimeout(() => {
            customMessage.classList.remove('show');
            customMessage.style.display = 'none';
        }, duration);
    }

    function showElement(element) {
        element.style.display = 'block';
    }

    function hideElement(element) {
        element.style.display = 'none';
    }

    // --- Authentication Functions ---
    window.toggleAuthForm = function(formToShow) {
      if (formToShow === 'login') {
        showElement(loginFormDiv);
        hideElement(registerFormDiv);
      } else {
        hideElement(loginFormDiv);
        showElement(registerFormDiv);
      }
    }

    window.showAuthModal = function() {
        authModalOverlay.classList.add('active'); // CSS handles opacity and pointer-events
        hideElement(mainContent);
        hideElement(quizContainer);
        hideElement(lessonContentDisplay);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
        window.toggleAuthForm('login');
    }

    window.hideAuthModal = function() {
        authModalOverlay.classList.remove('active');
        if (isAuthenticated) {
            showElement(mainContent);
        }
    }

    // Register user with email and password
    document.getElementById('register-email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = registerEmailInput.value;
      const password = registerPasswordInput.value;

      try {
        await createUserWithEmailAndPassword(auth, email, password);
        showMessage('¬°Registro exitoso! Has iniciado sesi√≥n.');
      } catch (error) {
        let errorMessage = 'Error al registrar: ';
        switch (error.code) {
            case 'auth/email-already-in-use':
                errorMessage += 'El correo electr√≥nico ya est√° en uso.';
                break;
            case 'auth/invalid-email':
                errorMessage += 'El formato del correo electr√≥nico no es v√°lido.';
                break;
            case 'auth/weak-password':
                errorMessage += 'La contrase√±a debe tener al menos 6 caracteres.';
                break;
            default:
                errorMessage += error.message;
        }
        showMessage(errorMessage, 5000);
        console.error("Error al registrar:", error);
      }
    });

    // Sign in user with email and password
    document.getElementById('login-email-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = loginEmailInput.value;
      const password = loginPasswordInput.value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('¬°Inicio de sesi√≥n exitoso!');
      } catch (error) {
        let errorMessage = 'Error al iniciar sesi√≥n: ';
        switch (error.code) {
            case 'auth/invalid-credential':
                errorMessage += 'Credenciales inv√°lidas. Por favor, verifica tu correo y contrase√±a.';
                break;
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                errorMessage += 'Correo o contrase√±a incorrectos.';
                break;
            case 'auth/invalid-email':
                errorMessage += 'El formato del correo electr√≥nico no es v√°lido.';
                break;
            default:
                errorMessage += error.message;
        }
        showMessage(errorMessage, 5000);
        console.error("Error al iniciar sesi√≥n:", error);
      }
    });

    // Logout button event listener
    logoutButton.addEventListener('click', async () => {
      try {
        await signOut(auth);
        showMessage('Has cerrado sesi√≥n.');
      } catch (error) {
        showMessage('Error al cerrar sesi√≥n: ' + error.message, 5000);
        console.error("Error al cerrar sesi√≥n:", error);
      }
    });

    // Listen for authentication state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        isAuthenticated = true;
        currentUserId = user.uid;
        window.hideAuthModal(); // Hide modal, show main content
        showElement(quizNavLink);
        showElement(logoutButton);
        hideElement(authNavLink);
        showMessage('Bienvenido de nuevo.');

        // Load user preferences and progress from Firestore
        await loadUserPreferences(user.uid);
        loadProgressAndDisplay(); // Refresh UI based on loaded progress
        updateAllProgressBars(); // Recalculate and update all progress bars
      } else {
        isAuthenticated = false;
        currentUserId = null;
        showElement(mainContent); // Ensure main content is visible on logout
        hideElement(quizContainer);
        hideElement(lessonContentDisplay);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));

        hideElement(quizNavLink);
        hideElement(logoutButton);
        showElement(authNavLink);
        showMessage('Inicia sesi√≥n o reg√≠strate para acceder a todas las funciones.', 5000);

        // Reset user preferences to default
        userLearningStyle = 'visual';
        userTDAHStatus = 'no';
        resultMessage.textContent = '';
        studyAdvice.textContent = '';
        hideElement(tdahWarning);
      }
    });

    // --- Firestore Functions for User Preferences and Progress ---
    async function saveUserPreferences() {
        if (!currentUserId) {
            console.error("No user ID to save preferences.");
            return;
        }
        const userRef = doc(db, "users", currentUserId);
        try {
            await setDoc(userRef, {
                learningStyle: userLearningStyle,
                tdahStatus: userTDAHStatus,
                quizCompleted: true // Mark quiz as completed
            }, { merge: true });
            console.log("User preferences saved to Firestore.");
        } catch (e) {
            console.error("Error saving user preferences: ", e);
            showMessage("Error al guardar tus preferencias.", 3000);
        }
    }

    async function loadUserPreferences(uid) {
        const userRef = doc(db, "users", uid);
        try {
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                userLearningStyle = data.learningStyle || 'visual';
                userTDAHStatus = data.tdahStatus || 'no';
                console.log("User preferences loaded from Firestore:", data);
                
                // Update UI based on loaded preferences
                updateQuizResultDisplay();
            } else {
                console.log("No user preferences found in Firestore. User is new or quiz not completed.");
                // For new users, or users without preferences saved, the default 'visual' and 'no' will be used.
            }
        } catch (e) {
            console.error("Error loading user preferences: ", e);
            showMessage("Error al cargar tus preferencias.", 3000);
        }
    }

    async function saveProgress(subject, topicId, status) {
        if (!currentUserId) {
            console.error("No user ID to save progress.");
            showMessage("Por favor, inicia sesi√≥n para guardar tu progreso.", 3000);
            return;
        }
        const progressRef = doc(db, `users/${currentUserId}/progress`, `${subject}-${topicId}`);
        try {
            await setDoc(progressRef, { status: status, timestamp: new Date() }, { merge: true });
            console.log(`Progress for ${subject}-${topicId} saved.`);
            loadProgressAndDisplay();
            updateAllProgressBars();
        } catch (e) {
            console.error("Error saving progress: ", e);
            showMessage("Error al guardar tu progreso.", 3000);
        }
    }

    async function loadProgressAndDisplay() {
        if (!currentUserId) {
            console.warn("No user ID to load progress. Displaying default progress.");
            // If not authenticated, ensure progress indicators are cleared.
            [
              ...mathTopics.map(t => ({ subject: 'matematicas', topic: t })),
              ...lenguaTopics.map(t => ({ subject: 'lengua', topic: t })),
              ...inglesTopics.map(t => ({ subject: 'ingles', topic: t }))
            ].forEach(({ subject, topic }) => {
              const indicator = document.getElementById(`progress-${subject}-${topic.id}`);
              if (indicator) {
                indicator.innerHTML = '';
              }
            });
            return;
        }

        try {
            const progressCollectionRef = collection(db, `users/${currentUserId}/progress`);
            const querySnapshot = await getDocs(progressCollectionRef);
            const userProgress = {};
            querySnapshot.forEach((doc) => {
                userProgress[doc.id] = doc.data().status;
            });

            // Update individual topic indicators
            [
                ...mathTopics.map(t => ({ subject: 'matematicas', topic: t })),
                ...lenguaTopics.map(t => ({ subject: 'lengua', topic: t })),
                ...inglesTopics.map(t => ({ subject: 'ingles', topic: t }))
            ].forEach(({ subject, topic }) => {
                const docId = `${subject}-${topic.id}`;
                const status = userProgress[docId];
                const indicator = document.getElementById(`progress-${subject}-${topic.id}`);
                if (indicator) {
                    if (status === 'completed') {
                        indicator.innerHTML = '<span style="color: green; font-weight: bold; margin-left: 10px;">‚úÖ Completado</span>';
                    } else {
                        indicator.innerHTML = ''; // Limpiar si no est√° completado
                    }
                }
            });
            updateAllProgressBars(); // Call after loading all individual progress
        } catch (e) {
            console.error("Error loading progress: ", e);
            showMessage("Error al cargar tu progreso.", 3000);
        }
    }

    function updateQuizResultDisplay() {
        const styleNames = {
            visual: "Visual",
            auditivo: "Auditivo",
            'lectura-escritura': "Lectura/Escritura",
            kinestesico: "Kinest√©sico"
        };
        if (userLearningStyle) {
            resultMessage.textContent = `üéØ Tu estilo de aprendizaje detectado: ${styleNames[userLearningStyle]}`;
            const adviceByStyle = {
                visual: "Recomendamos usar esquemas, mapas conceptuales, videos y colores para organizar tus ideas. Aprovecha im√°genes y gr√°ficos para estudiar.",
                auditivo: "Aprende mejor con grabaciones, podcasts, explicaciones en voz alta y repitiendo la informaci√≥n oralmente.",
                'lectura-escritura': "Prefiere leer textos, tomar apuntes, escribir res√∫menes y usar listas para organizar la informaci√≥n.",
                kinestesico: "Es ideal aprender haciendo, usando actividades pr√°cticas, movimientos o ejercicios mientras estudias."
            };
            studyAdvice.textContent = adviceByStyle[userLearningStyle] || "";
            showElement(resultMessage);
            showElement(studyAdvice);
        } else {
            hideElement(resultMessage);
            hideElement(studyAdvice);
        }

        if (userTDAHStatus === 'tdah') {
            showElement(tdahWarning);
        } else {
            hideElement(tdahWarning);
        }
    }

    // --- LLM Integration for Content Generation ---
    async function generateLessonContent(subject, topicId, learningStyle) {
        showMessage("Generando contenido de lecci√≥n con IA...", 5000);
        const prompt = `Genera un contenido de lecci√≥n interactivo y conciso sobre "${topicId.replace(/-/g, ' ')}" dentro del tema de "${subject}" para un estudiante con estilo de aprendizaje "${learningStyle}". Incluye elementos visuales, auditivos, de lectura/escritura o kinest√©sicos relevantes para ese estilo. Proporciona el contenido en formato HTML, con etiquetas como <h3>, <p>, <img>, <audio>, <video>, <textarea> para ejercicios, y un placeholder para juegos interactivos. Aseg√∫rate de que el HTML sea v√°lido y limpio. El contenido debe ser did√°ctico y atractivo.`;

        try {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };
            const apiUrl = `${GEMINI_API_URL}${GEMINI_API_KEY}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const htmlContent = result.candidates[0].content.parts[0].text;
                // Clean markdown backticks if LLM adds them
                return htmlContent.replace(/```html\n?|\n?```/g, '');
            } else {
                console.error("Unexpected LLM response structure:", result);
                showMessage("No se pudo generar el contenido de la lecci√≥n. Int√©ntalo de nuevo.", 5000);
                return "<p>Error: No se pudo generar el contenido. Por favor, int√©ntalo de nuevo.</p>";
            }
        } catch (error) {
            console.error("Error calling Gemini API:", error);
            showMessage("Error de conexi√≥n con la IA. Aseg√∫rate de que tu API Key sea v√°lida.", 5000);
            return "<p>Error de conexi√≥n al generar el contenido. Por favor, verifica tu conexi√≥n o int√©ntalo m√°s tarde.</p>";
        }
    }


    // --- Quiz Functions ---
    const quizQuestions = [
      {
        question: "¬øC√≥mo prefieres aprender?",
        options: [
          { text: "Viendo im√°genes, gr√°ficos o videos", value: "visual" },
          { text: "Escuchando explicaciones o audios", value: "auditivo" },
          { text: "Leyendo o escribiendo textos", value: "lectura-escritura" },
          { text: "Haciendo actividades pr√°cticas o manipulativas", value: "kinestesico" }
        ]
      },
      {
        question: "¬øSueles tener dificultades para mantener la atenci√≥n o concentraci√≥n?",
        options: [
          { text: "S√≠, frecuentemente", value: "tdah" },
          { text: "A veces", value: "a-veces" },
          { text: "No, casi nunca", value: "no" }
        ]
      },
      {
        question: "Cuando estudias, ¬øqu√© te ayuda m√°s a entender y recordar?",
        options: [
          { text: "Ver esquemas o mapas conceptuales", value: "visual" },
          { text: "Escuchar grabaciones o explicaciones en voz alta", value: "auditivo" },
          { text: "Tomar notas o leer textos varias veces", value: "lectura-escritura" },
          { text: "Hacer ejercicios pr√°cticos o moverme mientras estudio", value: "kinestesico" }
        ]
      },
      {
        question: "¬øQu√© actividad prefieres para aprender algo nuevo?",
        options: [
          { text: "Observar demostraciones visuales", value: "visual" },
          { text: "Participar en discusiones o escuchar explicaciones", value: "auditivo" },
          { text: "Leer libros o escribir res√∫menes", value: "lectura-escritura" },
          { text: "Experimentar y practicar directamente", value: "kinestesico" }
        ]
      },
      {
        question: "¬øC√≥mo recuerdas mejor la informaci√≥n?",
        options: [
          { text: "Recordando im√°genes y colores", value: "visual" },
          { text: "Recordando sonidos o palabras", value: "auditivo" },
          { text: "Recordando textos o frases escritas", value: "lectura-escritura" },
          { text: "Recordando sensaciones y movimientos", value: "kinestesico" }
        ]
      }
    ];

    let currentQuestionIndex = 0;
    let selectedAnswers = {};

    window.showQuestion = function() {
      if (!isAuthenticated) {
        showMessage('Por favor, inicia sesi√≥n para acceder al cuestionario.');
        window.showAuthModal();
        return;
      }
      console.log('--- showQuestion called ---');
      console.log('Current index:', currentQuestionIndex);

      // Hide all other content explicitly
      hideElement(mainContent);
      document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
      hideElement(lessonContentDisplay);
      authModalOverlay.classList.remove('active'); // Ensure modal is not active

      // Show quiz container
      showElement(quizContainer);
      console.log('Quiz container display set to block.');

      if (currentQuestionIndex >= quizQuestions.length) {
        console.log('Quiz finished. Calling finishQuiz().');
        finishQuiz();
        return;
      }

      const currentQ = quizQuestions[currentQuestionIndex];
      questionText.textContent = currentQ.question;
      optionsDiv.innerHTML = '';
      console.log('Displaying question:', currentQ.question);
      
      currentQ.options.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.textContent = option.text;
        btn.onclick = () => {
          selectedAnswers[currentQuestionIndex] = option.value;
          currentQuestionIndex++;
          console.log('Option selected. Next question index:', currentQuestionIndex);
          window.showQuestion();
        };
        optionsDiv.appendChild(btn);
        console.log('Added option button:', option.text);
      });
    }

    async function finishQuiz() {
      console.log('--- finishQuiz called ---');
      hideElement(quizContainer);
      showElement(mainContent); // Ensure main content is shown

      const styleCounts = {
        visual: 0,
        auditivo: 0,
        'lectura-escritura': 0,
        kinestesico: 0
      };

      for(let i = 0; i < quizQuestions.length; i++){
        if(i === 1) continue; // Skip TDAH question (index 1)
        const ans = selectedAnswers[i];
        if(styleCounts.hasOwnProperty(ans)){
          styleCounts[ans]++;
        }
      }

      let maxStyle = 'visual';
      let maxCount = 0;
      for(const style in styleCounts){
        if(styleCounts[style] > maxCount){
          maxCount = styleCounts[style];
          maxStyle = style;
        }
      }
      userLearningStyle = maxStyle; // Update global variable

      userTDAHStatus = selectedAnswers[1] || 'no'; // Update global variable for TDAH status

      updateQuizResultDisplay(); // Update UI based on final style and TDAH status
      await saveUserPreferences(); // Save preferences to Firestore

      loadProgressAndDisplay();
      updateAllProgressBars();
    }

    // --- Data de Temas para C√°lculo de Progreso ---
    const mathTopics = [
      { id: 'operaciones-basicas', text: 'Operaciones B√°sicas' },
      { id: 'fracciones', text: 'Fracciones y Decimales' },
      { id: 'porcentajes', text: 'Porcentajes' },
      { id: 'ecuaciones', text: 'Ecuaciones de Primer Grado' },
      { id: 'sistemas', text: 'Sistemas de Ecuaciones' },
      { id: 'geometria', text: 'Geometr√≠a B√°sica' }
    ];

    const lenguaTopics = [
      { id: 'ortografia-basica', text: 'Ortograf√≠a B√°sica' },
      { id: 'morfologia', text: 'Morfolog√≠a' },
      { id: 'sintaxis-simple', text: 'Sintaxis - Oraci√≥n Simple' },
      { id: 'sintaxis-compuesta', text: 'Sintaxis - Oraci√≥n Compuesta' },
      { id: 'literatura', text: 'Literatura Espa√±ola' },
      { id: 'expresion-escrita', text: 'Expresi√≥n Escrita' }
    ];

    const inglesTopics = [
      { id: 'basic-vocabulary', text: 'Basic Vocabulary' },
      { id: 'present-tenses', text: 'Present Simple & Continuous' },
      { id: 'past-tenses', text: 'Past Simple & Past Continuous' },
      { id: 'future-tenses', text: 'Future Tenses' },
      { id: 'conditionals', text: 'Conditionals' },
      { id: 'listening-speaking', text: 'Listening & Speaking' }
    ];


    function updateSubjectProgress(subject, topicsArray, progressFillId, progressTextId) {
      let completedCount = 0;
      topicsArray.forEach(topic => {
          const progressKey = `${subject}-${topic.id}`; // This matches doc ID in Firestore
          // We need access to the `userProgress` map loaded from Firestore for accurate calculation
          // For now, we'll assume `userProgress` is available or load it if necessary.
          // For this specific function's purpose (updating bars), we assume individual progress is loaded.
          // A more robust implementation might pass userProgress as an argument or ensure it's globally available.
          // For now, let's just make sure we are correctly retrieving from the global `userProgress` map
          // which is populated by `loadProgressAndDisplay`.
          if (window.userProgress && window.userProgress[progressKey] === 'completed') {
              completedCount++;
          }
      });

      const totalTopics = topicsArray.length;
      const percentage = totalTopics > 0 ? (completedCount / totalTopics) * 100 : 0;

      const progressBarFill = document.getElementById(progressFillId);
      const progressBarText = document.getElementById(progressTextId);

      if (progressBarFill && progressBarText) {
        progressBarFill.style.width = `${percentage}%`;
        progressBarText.textContent = `${Math.round(percentage)}% completado`;
      }
    }

    function updateAllProgressBars() {
      updateSubjectProgress('matematicas', mathTopics, 'matematicas-progress-fill', 'matematicas-progress-text');
      updateSubjectProgress('lengua', lenguaTopics, 'lengua-progress-fill', 'lengua-progress-text');
      updateSubjectProgress('ingles', inglesTopics, 'ingles-progress-fill', 'ingles-progress-text');
    }

    // --- Funciones de Navegaci√≥n y Contenido ---
    window.showSubject = function(subject) {
      if (!isAuthenticated) {
        showMessage('Por favor, inicia sesi√≥n para acceder a las materias.');
        window.showAuthModal();
        return;
      }
      console.log('--- showSubject called ---');
      hideElement(mainContent);
      hideElement(quizContainer);
      document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
      hideElement(lessonContentDisplay);
      authModalOverlay.classList.remove('active');

      const subjectPage = document.getElementById(subject + '-page');
      if (subjectPage) {
        showElement(subjectPage);
      }
      
      personalizeSubjectIntro(subject);
      loadProgressAndDisplay(); // Load and display individual topic progress checks
      updateAllProgressBars(); // Update overall subject progress bars
    }

    window.showMainContent = function() {
      console.log('--- showMainContent called ---');
      document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
      hideElement(quizContainer);
      hideElement(lessonContentDisplay);
      authModalOverlay.classList.remove('active');
      
      showElement(mainContent);
    }

    function personalizeSubjectIntro(subject) {
      const introElement = document.getElementById(subject + '-personalized-intro');
      if (!introElement) return;

      const personalizedIntros = {
        matematicas: {
          visual: "üé® Como eres una persona con estilo **visual**, hemos preparado esquemas, gr√°ficos y representaciones visuales para cada tema de matem√°ticas. ¬°Ver√°s las matem√°ticas de una forma completamente nueva!",
          auditivo: "üîä Perfecto para tu estilo **auditivo**: cada lecci√≥n incluye explicaciones paso a paso, podcasts matem√°ticos y ejercicios que puedes resolver 'hablando' contigo mismo.",
          'lectura-escritura': "üìù Ideal para tu estilo de **lectura/escritura**: encontrar√°s res√∫menes detallados, ejercicios escritos y la posibilidad de tomar notas estructuradas en cada tema.",
          kinestesico: "üèÉ ¬°Matem√°ticas en movimiento! Hemos dise√±ado actividades pr√°cticas, manipulativas y ejercicios que puedes resolver movi√©ndote o usando objetos f√≠sicos."
        },
        lengua: {
          visual: "üé® Tu aprendizaje **visual** te ayudar√° con mapas mentales, esquemas de sintaxis y representaciones gr√°ficas de las reglas gramaticales.",
          auditivo: "üîä Perfecto para tu estilo: lecturas en voz alta, ejercicios de dictado, y t√©cnicas de memorizaci√≥n con ritmo y sonidos.",
          'lectura-escritura': "üìù En tu elemento: an√°lisis de textos, ejercicios de escritura creativa y t√©cnicas de estudio basadas en la lectura comprensiva.",
          kinestesico: "üèÉ Lengua activa: dramatizaciones, juegos de roles y ejercicios donde puedas moverte mientras aprendes gram√°tica y literatura."
        },
        ingles: {
          visual: "üé® **Visual English**: flashcards, mind maps, videos y material gr√°fico para aprender vocabulario y gram√°tica de forma visual.",
          auditivo: "üîä Perfect for you: **listening exercises**, pronunciation practice, songs and audio materials to improve your English naturally.",
          'lectura-escritura': "üìù **Reading & Writing** focus: textos graduados, ejercicios de escritura y t√©cnicas de estudio basadas en la lectura en ingl√©s.",
          kinestesico: "üèÉ **Active English**: role-plays, interactive games y actividades pr√°cticas para aprender ingl√©s movi√©ndote y experimentando."
        }
      };

      const intro = personalizedIntros[subject] && personalizedIntros[subject][userLearningStyle];
      if (intro) {
        introElement.innerHTML = `<div style="background: #eef5fb; padding: 25px; border-radius: var(--border-radius); margin-bottom: 30px; border-left: 5px solid var(--secondary-color); font-size: 1.1em; line-height: 1.6; color: var(--text-dark);"><strong>Personalizado para ti:</strong><br>${intro}</div>`;
      }
    }

    // --- Lesson Content Display (uses LLM for content) ---
    // Remove predefined topicContents as they will be generated by LLM
    // const topicContents = { ... };

    window.showLessonContent = async function(subject, topicId) {
        if (!isAuthenticated) {
            showMessage('Por favor, inicia sesi√≥n para acceder al contenido de las lecciones.');
            window.showAuthModal();
            return;
        }
        console.log('--- showLessonContent called ---');
        hideElement(mainContent);
        hideElement(quizContainer);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
        authModalOverlay.classList.remove('active');

        showElement(lessonContentDisplay);

        const lessonTitleElement = document.getElementById('lesson-title');
        const lessonMaterialElement = document.getElementById('lesson-material');

        const topicName = topicId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        const subjectName = subject.charAt(0).toUpperCase() + subject.slice(1);
        lessonTitleElement.textContent = `Lecci√≥n: ${topicName} de ${subjectName}`;
        lessonMaterialElement.innerHTML = '<p>Cargando contenido de la lecci√≥n...</p>'; // Loading indicator

        // Generate content using LLM
        const generatedContent = await generateLessonContent(subject, topicId, userLearningStyle);
        lessonMaterialElement.innerHTML = generatedContent;

        // Add event listener to the "Completar lecci√≥n" button within the generated content
        // This assumes the generated content will include a button with this specific text and purpose.
        const completeLessonButton = lessonMaterialElement.querySelector('button');
        if (completeLessonButton && completeLessonButton.textContent.includes('Completar lecci√≥n')) {
            completeLessonButton.onclick = () => window.simulateGameCompletion(subject, topicId);
        } else if (completeLessonButton && completeLessonButton.textContent.includes('Simular Completar Juego')) {
            completeLessonButton.onclick = () => window.simulateGameCompletion(subject, topicId);
        }
    }

    window.hideLessonContent = function() {
        console.log('--- hideLessonContent called ---');
        hideElement(lessonContentDisplay);

        let previouslyActiveSubjectId = null;
        document.querySelectorAll('.subject-page').forEach(page => {
            if (page.style.display === 'block') { // Check for active display
                previouslyActiveSubjectId = page.id.replace('-page', '');
                hideElement(page); // Hide the previously active subject page
            }
        });
        
        if (previouslyActiveSubjectId) {
            window.showSubject(previouslyActiveSubjectId);
        } else {
            window.showMainContent();
        }
    }

    window.simulateGameCompletion = function(subject, topicId) {
        showMessage('¬°Felicidades! Has completado el juego interactivo. Tu progreso ha sido guardado.', 4000);
        saveProgress(subject, topicId, 'completed');
        window.hideLessonContent();
    }


    // Initial setup on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial display states for all main content elements
        // All elements are initially hidden by default, except mainContent
        hideElement(quizContainer);
        document.querySelectorAll('.subject-page').forEach(page => hideElement(page));
        hideElement(lessonContentDisplay);
        hideElement(customMessage); // Ensure custom message is hidden
        authModalOverlay.classList.remove('active'); // Ensure modal is hidden with CSS class

        // Auth and nav links visibility will be handled by onAuthStateChanged
        hideElement(quizNavLink);
        hideElement(logoutButton);
        showElement(authNavLink); // Default to showing auth link

        // Main content is shown by default until login status is determined
        showElement(mainContent);

        // Load progress for all subjects on initial page load (will run after auth state is determined)
        // loadProgressAndDisplay(); // This is now called within onAuthStateChanged
        // updateAllProgressBars(); // This is now called within onAuthStateChanged
    });
  
  </script>
</body>
</html>

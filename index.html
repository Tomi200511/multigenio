
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MultiGenio - Tu aliado en el aprendizaje</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlalH6s38fG/c4Jz4fV1t1p9r0nC1Fw/s4M6C1zW6Jz0f2bW9Z7a8+z5o5y5p5t5a5t5f5d5e5f5g5h5i5j5k5l5m5n5o5p5q5r5s5t5u5v5w5x5y5z==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      /* Paleta de colores moderna y vibrante */
      --primary-color: #4A90E2; /* Azul profundo para elementos principales, llamadas a la acción */
      --secondary-color: #50B86F; /* Verde vibrante para éxitos, resaltados */
      --accent-color: #FFC107; /* Amarillo brillante para acentos, advertencias */
      --text-dark: #2C3E50; /* Gris oscuro para texto primario */
      --text-light: #607D8B; /* Gris más claro para texto secundario */
      --bg-light: #F8F9FA; /* Blanco roto para fondos generales */
      --bg-white: #FFFFFF; /* Blanco puro para tarjetas, modales */
      --border-color: #E0E0E0; /* Gris claro para bordes */

      /* Sombras */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);

      /* Espaciado */
      --spacing-unit: 1rem; /* 16px */
      --border-radius-sm: 8px;
      --border-radius-md: 16px;
    }

    /* Reseteo básico y propiedades generales */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      line-height: 1.8;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden; /* Evitar scroll horizontal */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Estilo de la barra de desplazamiento (Scrollbar) */
    body::-webkit-scrollbar {
      width: 10px;
    }
    body::-webkit-scrollbar-track {
      background: var(--bg-light);
    }
    body::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 10px;
      border: 2px solid var(--bg-light);
    }
    body::-webkit-scrollbar-thumb:hover {
      background-color: var(--secondary-color);
    }

    /* Sección 1: Barra Superior Delgada */
    .top-bar {
        background: var(--text-dark);
        color: white;
        padding: 8px 20px;
        font-size: 0.85em;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        position: sticky; /* Make sticky */
        top: 0; /* Stick to top */
        z-index: 1000; /* Ensure it's above other content */
    }
    .top-bar .left-links a,
    .top-bar .right-links a,
    .top-bar .right-links button {
        color: white;
        text-decoration: none;
        margin-right: 15px;
        transition: color 0.2s ease;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 0.9em;
        padding: 5px 0;
    }
    .top-bar .right-links a:last-child,
    .top-bar .right-links button:last-child {
      margin-right: 0;
    }
    .top-bar .left-links, .top-bar .right-links {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .top-bar button#access-button,
    .top-bar button#logout-top-bar-button { /* Apply styles to both */
      background: var(--primary-color);
      padding: 8px 15px;
      border-radius: var(--border-radius-sm);
      font-weight: 600;
      box-shadow: var(--shadow-sm);
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .top-bar button#access-button:hover,
    .top-bar button#logout-top-bar-button:hover { /* Apply hover to both */
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    /* Sección 2: Cabecera Principal */
    header {
      background: var(--bg-white);
      padding: 15px 20px;
      box-shadow: var(--shadow-sm);
      position: sticky; /* Make sticky */
      top: 40px; /* Stick below the top-bar */
      z-index: 999;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    header .logo-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    header .logo-group img {
      height: 50px;
      width: auto;
      border-radius: 50%;
      box-shadow: var(--shadow-sm);
    }
    header h1 {
      font-size: 2em;
      margin: 0;
      font-weight: 700;
      color: var(--text-dark);
    }

    header .main-nav-links {
        display: flex;
        align-items: center;
        gap: 25px;
        flex-grow: 1;
        justify-content: flex-start;
        margin-left: 30px;
    }
    header .main-nav-links a {
        color: var(--text-dark);
        text-decoration: none;
        font-weight: 500;
        font-size: 1em;
        padding: 8px 12px;
        border-radius: var(--border-radius-sm);
        transition: all 0.3s ease;
    }
    header .main-nav-links a:hover {
        background: rgba(74, 144, 226, 0.1);
        color: var(--primary-color);
    }

    .search-bar {
        display: flex;
        align-items: center;
        background: var(--bg-light);
        border-radius: var(--border-radius-sm);
        padding: 5px 10px;
        border: 1px solid var(--border-color);
        width: 250px;
        transition: all 0.3s ease;
    }
    .search-bar:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }
    .search-bar input {
        border: none;
        background: none;
        outline: none;
        padding: 8px;
        font-size: 0.95em;
        width: calc(100% - 30px); /* Adjust for icon width */
        color: var(--text-dark);
    }
    .search-bar button {
        background: none;
        border: none;
        color: var(--text-light);
        cursor: pointer;
        font-size: 1.1em;
        padding: 5px;
    }
    .search-bar button:hover {
        color: var(--primary-color);
    }

    .hamburger-menu {
        font-size: 1.8em;
        cursor: pointer;
        color: var(--text-dark);
        padding: 5px 10px;
        border-radius: var(--border-radius-sm);
        transition: background 0.2s ease, color 0.2s ease;
        display: block; /* Hidden by default, shown on mobile */
    }
    .hamburger-menu:hover {
        background: var(--bg-light);
        color: var(--primary-color);
    }
    /* Menú lateral (oculto por defecto) */
    .sidebar-menu {
        position: fixed;
        top: 0;
        right: -300px; /* Oculto a la derecha */
        width: 280px;
        height: 100%;
        background-color: var(--text-dark); /* Color oscuro para el menú */
        box-shadow: -5px 0 15px rgba(0,0,0,0.3);
        z-index: 1000;
        transition: right 0.3s ease-in-out;
        padding-top: 60px; /* Espacio para el botón de cerrar */
        display: flex;
        flex-direction: column;
    }
    .sidebar-menu.active {
        right: 0; /* Visible */
    }
    .sidebar-menu .close-sidebar {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: white;
        font-size: 2em;
        cursor: pointer;
    }
    .sidebar-menu a {
        padding: 15px 20px;
        color: white;
        text-decoration: none;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        transition: background-color 0.2s ease;
    }
    .sidebar-menu a:hover {
        background-color: var(--primary-color);
    }
    .sidebar-menu a:last-child {
        border-bottom: none;
    }


    /* Sección 3: Presentación Visual e Interactiva */
    .visual-presentation-section {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start; /* Align items to start for smaller height */
        gap: calc(var(--spacing-unit) * 1.5); /* Slightly smaller gap */
        padding: calc(var(--spacing-unit) * 2.5) var(--spacing-unit); /* Smaller padding */
        max-width: 1280px;
        margin: calc(var(--spacing-unit) * 3) auto;
        background: var(--bg-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
    }
    .visual-presentation-section .left-content {
        flex: 1;
        min-width: 280px; /* Smaller min-width */
        max-width: 450px; /* Smaller max-width */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding-right: var(--spacing-unit); /* Add some padding to the right */
    }
    .visual-presentation-section .right-content {
      flex: 1.5; /* Give more space to the right content (image) */
      min-width: 320px;
      max-width: 650px; /* Wider max-width for the image */
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .image-carousel {
        width: 100%;
        max-width: 400px; /* Smaller carousel */
        height: 250px; /* Smaller carousel height */
        position: relative;
        overflow: hidden;
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-unit);
    }
    .carousel-images {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.5s ease-in-out;
    }
    .carousel-images img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        flex-shrink: 0;
    }
    .carousel-nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
        z-index: 10;
        border-radius: 50%;
        font-size: 1.2em;
    }
    .carousel-nav-btn.prev { left: 10px; }
    .carousel-nav-btn.next { right: 10px; }

    .curiosities-section {
      background: var(--bg-light);
      border-radius: var(--border-radius-sm);
      padding: calc(var(--spacing-unit) * 1);
      margin-top: calc(var(--spacing-unit) * 1.5);
      box-shadow: var(--shadow-sm);
      width: 100%;
      text-align: center;
    }
    .curiosities-section h3 {
      font-size: 1.2em;
      color: var(--primary-color);
      margin-bottom: 0.5em;
      font-weight: 600;
    }
    .curiosities-section p {
      font-size: 0.9em;
      color: var(--text-dark);
      margin-bottom: 0;
      text-align: center; /* Center text */
    }

    .static-image-container {
        position: relative;
        width: 100%;
        height: 400px; /* Made taller to cover more space */
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }
    .static-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .blog-promo {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(74, 144, 226, 0.8); /* Primary color with transparency */
        color: white;
        padding: 20px;
        text-align: center;
        border-bottom-left-radius: var(--border-radius-md);
        border-bottom-right-radius: var(--border-radius-md);
    }
    .blog-promo h3 {
        color: white;
        margin-bottom: 10px;
        font-size: 1.5em;
    }
    .blog-promo p {
        color: rgba(255,255,255,0.9);
        font-size: 0.95em;
        margin-bottom: 15px;
    }
    .blog-promo button {
        background: var(--secondary-color);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .blog-promo button:hover {
        background: var(--text-dark);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }


    /* Sección 4: Temarios, Funcionamiento y Materias */
    .subjects-section {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: calc(var(--spacing-unit) * 2);
        padding: calc(var(--spacing-unit) * 4) var(--spacing-unit);
        max-width: 1280px;
        margin: calc(var(--spacing-unit) * 3) auto;
        background: var(--bg-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
    }
    .subjects-section .left-content,
    .subjects-section .right-content {
        flex: 1;
        min-width: 300px;
        max-width: 550px;
    }
    .subjects-section .left-content h2,
    .subjects-section .right-content h2 {
      text-align: left;
      font-size: 2em;
      margin-bottom: var(--spacing-unit);
    }
    .subjects-section .left-content h2::after,
    .subjects-section .right-content h2::after {
      margin-left: 0;
    }
    .subjects-section .left-content p {
      text-align: justify; /* Justify text for detailed explanation */
      margin-bottom: var(--spacing-unit);
    }
    .subjects-section .learning-methods span {
      display: inline-block;
      background: var(--bg-light);
      padding: 8px 15px;
      border-radius: 20px;
      margin: 5px;
      font-size: 0.9em;
      font-weight: 500;
      color: var(--text-dark);
      border: 1px solid var(--border-color);
    }

    .subject-menu {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .subject-menu .subject-category {
      margin-bottom: 15px;
      background: var(--bg-light);
      border-radius: var(--border-radius-sm);
      padding: 15px;
      box-shadow: var(--shadow-sm);
    }
    .subject-menu .subject-category h3 {
      font-size: 1.4em;
      color: var(--primary-color);
      margin-bottom: 10px;
      text-align: left;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 5px;
      cursor: pointer; /* Make subject titles clickable */
      transition: color 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .subject-menu .subject-category h3:hover {
      color: var(--secondary-color);
    }
    .subject-menu .subject-category h3 .icon {
      font-size: 0.8em; /* Adjust icon size */
      transition: transform 0.3s ease;
    }
    .subject-menu .subject-category h3.expanded .icon {
      transform: rotate(90deg); /* Rotate icon when expanded */
    }

    .subject-topics-list {
      display: none; /* Hidden by default */
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border-color);
    }
    .subject-topics-list.active {
      display: flex; /* Show when active */
    }

    .subject-topics-list button {
      display: block;
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--secondary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      text-align: left;
    }
    .subject-topics-list button:last-child {
      margin-bottom: 0;
    }
    .subject-topics-list button:hover {
      background: var(--text-dark);
      transform: translateX(3px);
      box-shadow: var(--shadow-md);
    }


    /* Sección 5: Opiniones y Contacto */
    .reviews-contact-section {
        padding: calc(var(--spacing-unit) * 1.5) var(--spacing-unit); /* Made smaller */
        max-width: 1280px;
        margin: calc(var(--spacing-unit) * 3) auto;
        background: var(--bg-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
    }
    .reviews-contact-section h2 {
      text-align: center;
      color: var(--text-dark);
      margin-bottom: calc(var(--spacing-unit) * 1); /* Slightly smaller margin */
      font-size: 2.2em; /* Slightly smaller font */
      font-weight: 700;
    }
    .reviews-contact-section h2::after {
      background: var(--accent-color);
    }

    .testimonials-carousel {
        width: 90%;
        max-width: 800px; /* Slightly smaller */
        margin: 0 auto calc(var(--spacing-unit) * 1.5); /* Smaller margin bottom */
        position: relative;
        overflow: hidden;
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
    }
    .testimonials-slides {
        display: flex;
        transition: transform 0.5s ease-in-out;
    }
    .testimonial-slide {
        min-width: 100%;
        box-sizing: border-box;
        padding: calc(var(--spacing-unit) * 1); /* Smaller padding */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        background: var(--bg-light);
        border-radius: var(--border-radius-md);
    }
    .testimonial-slide img {
        width: 70px; /* Smaller image */
        height: 70px; /* Smaller image */
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: var(--spacing-unit) * 0.8;
        border: 3px solid var(--primary-color);
        box-shadow: var(--shadow-sm);
    }
    .testimonial-slide video {
        width: 100%;
        max-width: 250px; /* Smaller video */
        height: auto;
        border-radius: var(--border-radius-sm);
        margin-bottom: var(--spacing-unit) * 0.8;
    }
    .testimonial-slide h3 {
        font-size: 1.2em; /* Smaller font */
        color: var(--text-dark);
        margin-bottom: 6px;
    }
    .testimonial-slide p {
        font-style: italic;
        color: var(--text-light);
        line-height: 1.5;
        font-size: 0.9em; /* Smaller font */
        margin-bottom: 8px; /* Smaller margin */
    }
    .testimonial-carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      padding: 6px; /* Smaller buttons */
      cursor: pointer;
      z-index: 10;
      border-radius: 50%;
      font-size: 1em;
    }
    .testimonial-carousel-nav.prev { left: 8px; }
    .testimonial-carousel-nav.next { right: 8px; }

    .footer-content {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around; /* Distribute content */
      align-items: flex-start;
      padding-top: calc(var(--spacing-unit) * 1); /* Smaller padding top */
      border-top: 1px solid var(--border-color);
    }
    .footer-section {
      flex: 0 0 30%; /* Less flexible, more fixed width */
      min-width: 180px; /* Even smaller min-width for sections */
      margin: var(--spacing-unit) * 0.8;
      text-align: left;
    }
    .footer-section h3 {
      font-size: 1em; /* Smaller font */
      color: var(--text-dark);
      margin-bottom: var(--spacing-unit) * 0.8;
      text-align: left;
    }
    .footer-section p, .footer-section a {
      font-size: 0.85em; /* Smaller font */
      color: var(--text-light);
      text-decoration: none;
      display: block;
      margin-bottom: 3px;
    }
    .footer-section a:hover {
      color: var(--primary-color);
      text-decoration: underline;
    }
    .footer-section .social-icons a {
      font-size: 1.1em; /* Smaller icons */
      margin-right: 8px;
      color: var(--text-dark);
    }
    .footer-section .social-icons a:hover {
      color: var(--primary-color);
    }
    .payment-logos {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    .payment-logos img {
      height: 20px !important; /* Made smaller with !important to override other styles */
      filter: grayscale(80%) brightness(120%); /* Adjust filter for better visibility */
      opacity: 0.9;
      transition: opacity 0.2s ease;
      width: auto; /* Ensure aspect ratio */
    }
    .payment-logos img:hover {
      opacity: 1;
      filter: grayscale(0%) brightness(100%);
    }

    .footer-bottom {
      width: 100%;
      text-align: center;
      margin-top: calc(var(--spacing-unit) * 1);
      padding-top: var(--spacing-unit) * 0.8;
      border-top: 1px solid var(--border-color);
      color: var(--text-light);
      font-size: 0.75em; /* Smaller font */
    }


    /* Estilos generales de sección (reusados) */
    .section {
      padding: calc(var(--spacing-unit) * 4) var(--spacing-unit);
      max-width: 1280px;
      margin: calc(var(--spacing-unit) * 3) auto;
      background: var(--bg-white);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    .section:first-of-type {
      margin-top: calc(var(--spacing-unit) * 4);
    }
    .section h2, .section h3 {
      text-align: center;
      color: var(--text-dark);
      margin-bottom: calc(var(--spacing-unit) * 2);
      font-size: 3em;
      font-weight: 700;
      position: relative;
    }
    .section h2::after, .section h3::after {
      content: '';
      display: block;
      width: 80px;
      height: 4px;
      background: var(--primary-color);
      margin: calc(var(--spacing-unit) * 1) auto 0;
      border-radius: 2px;
    }
    .section p {
      font-size: 1.05em;
      margin-bottom: 1.5em;
      color: var(--text-dark);
      text-align: justify;
    }
    .section ul {
      list-style: none;
      padding-left: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: var(--spacing-unit);
      margin-top: var(--spacing-unit);
    }
    .section ul li {
      background: var(--bg-light);
      padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-sm);
      font-size: 1em;
      color: var(--text-dark);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: calc(var(--spacing-unit) * 0.5);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-left: 5px solid var(--primary-color);
    }
    .section ul li:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: var(--secondary-color);
    }
    .section ul li img { /* Para iconos dentro de listas de beneficios */
      height: 32px;
      width: 32px;
      /* Ajustar color del icono SVG si es necesario */
      filter: invert(0.2) sepia(1) saturate(5) hue-rotate(200deg);
    }
    .section img { /* Imágenes generales en secciones */
      display: block;
      margin: calc(var(--spacing-unit) * 2) auto;
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      max-width: 100%;
      height: auto;
    }
    .section .text-center {
      text-align: center;
    }

    /* Tarjetas (Cards) */
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: calc(var(--spacing-unit) * 2);
      margin-top: calc(var(--spacing-unit) * 2);
    }
    .card {
      background: var(--bg-white);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      padding: calc(var(--spacing-unit) * 1.5);
      width: 350px; /* Ancho fijo para las tarjetas de funcionalidades */
      text-align: center;
      transition: all 0.3s ease-in-out;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 280px; /* Altura mínima para consistencia */
      border: 1px solid var(--border-color);
    }
    .card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }
    .card img {
      width: 80px;
      height: 80px;
      margin-bottom: var(--spacing-unit);
      transition: transform 0.3s ease;
      filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1));
    }
    .card:hover img {
      transform: scale(1.1);
    }
    .card h3 {
      font-size: 1.6em;
      color: var(--text-dark);
      margin-bottom: 12px;
      font-weight: 600;
    }
    .card p {
      font-size: 1em;
      color: var(--text-light);
      line-height: 1.6;
      flex-grow: 1; /* Para que el párrafo ocupe el espacio disponible */
    }
    .clickable-card {
      cursor: pointer;
    }
    .card-overlay { /* Efecto al pasar el ratón por encima de tarjetas clickeables */
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(74, 144, 226, 0.9); /* Superposición con primary-color */
      color: var(--bg-white);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.4s ease;
      font-weight: 600;
      font-size: 1.4em;
      border-radius: var(--border-radius-md);
      padding: var(--spacing-unit);
      text-align: center;
    }
    .clickable-card:hover .card-overlay {
      opacity: 1;
    }

    /* Estilos específicos de la lista de temas (Topic List) */
    .topic-list {
      margin-top: calc(var(--spacing-unit) * 2);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Columnas responsivas */
      gap: calc(var(--spacing-unit) * 1.5);
    }
    .topic-list h2 {
      grid-column: 1 / -1; /* Título abarca todas las columnas */
      font-size: 2.2em;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: var(--spacing-unit);
      text-align: center;
    }
    .topic-item {
      background: var(--bg-white);
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-sm);
      padding: calc(var(--spacing-unit) * 1);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      transition: all 0.3s ease;
      cursor: pointer;
      border-left: 5px solid var(--primary-color); /* Borde decorativo */
    }
    .topic-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: var(--secondary-color);
    }
    .topic-item .topic-title {
      font-size: 1.3em;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 8px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .topic-item .level-badge {
      background: var(--secondary-color);
      color: white;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.8em;
      font-weight: 500;
      margin-left: 10px;
      white-space: nowrap;
      box-shadow: var(--shadow-sm);
    }
    .topic-item .progress-indicator {
      font-size: 0.85em;
      color: var(--text-light);
      font-weight: 400;
      margin-left: auto;
    }
    .topic-item .topic-description {
      font-size: 0.95em;
      color: var(--text-light);
      line-height: 1.4;
      text-align: left;
    }

    /* Estilos del cuestionario, reseña, lección y blog (ya presentes) */
    #quiz-container { display: none; }
    #lesson-content-display { display: none; }
    #blog-page { display: none; }
    /* ... (mantener estilos existentes para estos) */

    /* Otros estilos (personalizados, modales, etc.) - Asegurar que se mantienen relevantes */
    /* Caja de Mensajes Personalizada (Custom Message Box) */
    #custom-message {
      position: fixed;
      top: var(--spacing-unit);
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--primary-color); /* Color por defecto */
      color: white;
      padding: 15px 30px;
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-md);
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      font-weight: 500;
      font-size: 1em;
    }
    #custom-message.show {
      opacity: 1;
    }

    /* Superposición Modal (Modal Overlay) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Fondo oscuro semitransparente */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1500;
      opacity: 0;
      pointer-events: none; /* No interactuable cuando está oculto */
      transition: opacity 0.4s ease-in-out;
    }
    .modal-overlay.active {
      opacity: 1;
      pointer-events: all; /* Interactuable cuando está activo */
    }

    /* Formulario de Autenticación (dentro del modal) */
    #auth-container {
      background: var(--bg-white);
      max-width: 450px;
      padding: calc(var(--spacing-unit) * 2);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: relative;
      border: 1px solid var(--border-color);
      display: flex; /* Flexbox for internal layout */
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #auth-container h2 {
      color: var(--text-dark);
      margin-bottom: var(--spacing-unit) * 1.2;
      font-size: 2em;
      font-weight: 600;
    }
    #auth-container form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%; /* Take full width of container */
    }
    #auth-container input[type="email"], #auth-container input[type="password"] {
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-sm);
      font-size: 1em;
      color: var(--text-dark);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    #auth-container input[type="email"]:focus, #auth-container input[type="password"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2);
      outline: none;
    }
    #auth-container button {
      background: var(--primary-color);
      color: white;
      padding: 14px 25px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-top: 15px;
      box-shadow: var(--shadow-sm);
    }
    #auth-container button:hover {
      background: var(--text-dark);
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    /* New styles for the direct options below login */
    #auth-container .alternative-options {
        margin-top: 20px;
        border-top: 1px solid var(--border-color);
        padding-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    #auth-container .alternative-options button,
    #auth-container .alternative-options .link-button {
        background: none;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 12px 20px;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        text-align: center;
        text-decoration: none; /* For link-button */
        display: block; /* For link-button */
    }
    #auth-container .alternative-options button:hover,
    #auth-container .alternative-options .link-button:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }
    #auth-container .alternative-options p {
        font-size: 0.9em;
        color: var(--text-light);
        margin-bottom: 5px;
    }


    .close-button { /* Botón de cerrar modal */
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 1.8em;
      color: var(--text-light);
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .close-button:hover {
      color: var(--text-dark);
    }

    /* Clases de utilidad */
    .hidden {
      display: none !important;
    }
    .text-center {
      text-align: center;
    }

    /* Estilos para el botón del chatbot */
    #chatbot-fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 2em;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      box-shadow: var(--shadow-lg);
      transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
      z-index: 1000;
    }

    #chatbot-fab:hover {
      background-color: var(--secondary-color);
      transform: scale(1.1);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
    }


    /* Ajustes responsivos */
    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        text-align: center;
        position: static; /* Remove sticky on mobile for simplicity if space is tight */
      }
      header {
        flex-direction: column;
        align-items: center;
        text-align: center;
        top: 0; /* Adjust for mobile */
        position: static; /* Remove sticky on mobile for simplicity if space is tight */
      }
      header .main-nav-links {
        display: none; /* Hide main nav links on smaller screens */
        margin-left: 0;
        justify-content: center;
      }
      .search-bar {
        width: 100%;
        max-width: 350px;
      }
      .hamburger-menu {
        display: block; /* Show hamburger on mobile */
      }
      .hero h1 {
        font-size: 2.5em;
      }
      .hero p {
        font-size: 1.2em;
      }
      .section h2, .section h3 {
        font-size: 2em;
      }
      .cards, #reviews-container {
        flex-direction: column; /* Apilar tarjetas en pantallas pequeñas */
        align-items: center;
      }
      .card, .testimonial-card, .review-card, #quiz-container, #review-submit-area .review-form, .contact-form, #lesson-content-display {
        width: 90%; /* Ancho más generoso */
        max-width: 450px;
        margin-left: auto;
        margin-right: auto;
      }
      .visual-presentation-section, .subjects-section, .reviews-contact-section .footer-content {
        flex-direction: column;
        align-items: center;
      }
      .visual-presentation-section .left-content,
      .visual-presentation-section .right-content,
      .subjects-section .left-content,
      .subjects-section .right-content,
      .footer-section {
        min-width: unset;
        width: 100%;
        max-width: 550px; /* Constrain individual content blocks */
      }
      .subject-menu button {
        text-align: center; /* Center buttons on mobile */
      }
      .testimonials-carousel {
        width: 100%; /* Take full width on smaller screens */
      }
      .testimonials-slides {
        flex-wrap: wrap; /* Allow testimonials to wrap if content is too wide */
        justify-content: center;
      }
      .testimonial-slide {
        min-width: 80%; /* Adjust width for stacked view */
        margin-bottom: var(--spacing-unit); /* Add margin between stacked slides */
      }
    }
    @media (max-width: 480px) {
      header h1 {
        font-size: 1.4em;
      }
      header .tagline {
        font-size: 0.75em;
      }
      nav a, nav button {
        padding: calc(var(--spacing-unit) * 0.5) calc(var(--spacing-unit) * 0.8);
        font-size: 0.85em;
      }
      .hero h1 {
        font-size: 2em;
      }
      .hero p {
        font-size: 1em;
      }
      .hero .hero-buttons button,
      .hero .hero-buttons a {
        font-size: 0.9em;
        padding: calc(var(--spacing-unit) * 0.7) calc(var(--spacing-unit) * 1.4);
      }
      .section {
        padding: calc(var(--spacing-unit) * 2);
      }
      .section h2, .section h3 {
        font-size: 1.8em;
      }
      .sidebar-menu {
        width: 100%; /* Take full width on very small screens */
        right: -100%;
      }
      .sidebar-menu.active {
        right: 0;
      }
      .top-bar .left-links, .top-bar .right-links {
        justify-content: center;
        width: 100%;
      }
    }

    /* Estilos del cuestionario */
    #quiz-container {
        background: var(--bg-white);
        max-width: 700px;
        margin: calc(var(--spacing-unit) * 2) auto;
        padding: calc(var(--spacing-unit) * 2);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
        display: none; /* Hidden by default */
    }

    #quiz-container h2 {
        color: var(--text-dark);
        margin-bottom: calc(var(--spacing-unit) * 1.5);
        font-size: 2.5em;
        font-weight: 700;
        text-align: center;
    }

    #quiz-questions-area {
        margin-bottom: calc(var(--spacing-unit) * 1.5);
    }

    #question-text {
        font-size: 1.2em;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: var(--spacing-unit);
        text-align: center;
        min-height: 50px; /* Ensure space for question text */
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }

    #options button {
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }

    #options button:hover {
        background-color: var(--secondary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    #options button.selected {
        background-color: var(--secondary-color);
        box-shadow: var(--shadow-md);
        transform: scale(1.02);
    }

    #submit-quiz {
        background-color: var(--primary-color); /* Changed from accent-blue to primary-color */
        color: white;
        padding: 15px 25px;
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        width: 80%;
        max-width: 300px;
        margin: calc(var(--spacing-unit) * 2) auto 0;
        box-shadow: var(--shadow-md);
    }

    #submit-quiz:hover {
        background-color: var(--text-dark);
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    #result-message, #tdah-warning, #study-advice {
        text-align: center;
        margin-top: calc(var(--spacing-unit) * 1.5);
        padding: var(--spacing-unit);
        border-radius: var(--border-radius-sm);
        font-size: 1.05em;
        line-height: 1.5;
        color: var(--text-dark);
        box-shadow: var(--shadow-sm);
    }

    #result-message {
        background-color: #e6f7ff; /* Light blue */
        border-left: 5px solid var(--primary-color);
    }

    #tdah-warning {
        background-color: #fffacd; /* Light yellow */
        border-left: 5px solid var(--accent-color);
    }

    #study-advice {
        background-color: #e6ffe6; /* Light green */
        border-left: 5px solid var(--secondary-color);
    }

    /* New element for quiz results on homepage */
    #quiz-results-display-area {
        margin-top: calc(var(--spacing-unit) * 2);
        padding: calc(var(--spacing-unit) * 2);
        background: var(--bg-white);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-md);
        text-align: center;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
        display: none; /* Hidden by default */
    }
    #quiz-results-display-area h3 {
        font-size: 1.8em;
        color: var(--text-dark);
        margin-bottom: calc(var(--spacing-unit) * 1.5);
    }
    #quiz-results-display-area .result-card {
        margin-bottom: var(--spacing-unit);
        padding: var(--spacing-unit);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
    }


    .back-button {
      background: none;
      border: none;
      color: var(--text-dark);
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: var(--border-radius-sm);
      transition: all 0.2s ease;
      margin-bottom: calc(var(--spacing-unit) * 1.5);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .back-button:hover {
      background: rgba(74, 144, 226, 0.1);
      transform: translateX(-5px);
    }

    /* Progress bar styles for subject pages */
    .progress-bar-container {
      width: 100%;
      background-color: var(--border-color);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      margin-top: calc(var(--spacing-unit) * 1.5);
      margin-bottom: calc(var(--spacing-unit) * 1.5);
      height: 30px;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-bar-fill {
      height: 100%;
      background-color: var(--secondary-color);
      width: 0%;
      border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
      transition: width 0.7s ease-in-out;
    }
    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 30px;
      color: white;
      font-weight: 600;
      font-size: 0.95em;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Personalized intro on subject pages */
    .personalized-intro {
        background: var(--bg-light);
        padding: calc(var(--spacing-unit) * 1.5);
        border-radius: var(--border-radius-sm);
        margin-bottom: calc(var(--spacing-unit) * 2);
        border-left: 5px solid var(--primary-color);
        font-size: 1em;
        line-height: 1.6;
        color: var(--text-dark);
        box-shadow: var(--shadow-sm);
    }

    /* Lesson content display styles */
    #lesson-content-display {
      background: var(--bg-white);
      max-width: 900px;
      margin: calc(var(--spacing-unit) * 2) auto;
      padding: calc(var(--spacing-unit) * 2);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      min-height: 500px;
      border: 1px solid var(--border-color);
    }
    #lesson-content-display h2 {
      text-align: center;
      color: var(--text-dark);
      margin-bottom: calc(var(--spacing-unit) * 1.5);
      font-size: 2.8em;
      font-weight: 700;
      position: relative;
    }
    #lesson-content-display h2::after {
      content: '';
      display: block;
      width: 70px;
      height: 3px;
      background: var(--secondary-color);
      margin: calc(var(--spacing-unit) * 0.8) auto 0;
      border-radius: 2px;
    }
    #lesson-material h3 {
        color: var(--text-dark);
        font-size: 1.6em;
        margin-top: calc(var(--spacing-unit) * 1.5);
        margin-bottom: calc(var(--spacing-unit) * 0.8);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 5px;
    }
    #lesson-material p {
        font-size: 1.0em;
        margin-bottom: var(--spacing-unit);
        color: var(--text-dark);
        text-align: justify;
    }
    #lesson-material video,
    #lesson-material audio,
    #lesson-material img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: var(--spacing-unit) auto;
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
    }
    #lesson-material textarea {
        width: 100%;
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-family: 'Poppins', sans-serif;
        font-size: 1em;
        min-height: 120px;
        margin-top: var(--spacing-unit);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
        resize: vertical;
    }
    #lesson-material .interactive-game-placeholder {
        background-color: #e0f7fa;
        border: 2px dashed var(--primary-color); /* Changed from accent-blue to primary-color */
        padding: calc(var(--spacing-unit) * 2);
        text-align: center;
        font-style: italic;
        color: var(--text-light);
        border-radius: var(--border-radius-sm);
        margin: calc(var(--spacing-unit) * 1.5) 0;
        font-size: 1.1em;
        font-weight: 500;
        box-shadow: var(--shadow-sm);
    }
    .lesson-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: calc(var(--spacing-unit) * 2);
        justify-content: center;
    }
    .lesson-actions button {
        background: var(--primary-color);
        color: white;
        padding: 12px 22px;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: background 0.3s ease, transform 0.2s ease;
        box-shadow: var(--shadow-sm);
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .lesson-actions button:hover {
        background: var(--text-dark);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }
    .gemini-output {
        margin-top: calc(var(--spacing-unit) * 1.5);
        padding: var(--spacing-unit);
        background: var(--bg-light);
        border-radius: var(--border-radius-sm);
        border-left: 5px solid var(--secondary-color); /* Changed from accent-green to secondary-color */
        box-shadow: var(--shadow-sm);
        color: var(--text-dark);
        font-size: 0.95em;
        line-height: 1.6;
        text-align: left;
    }
    .gemini-output h4 {
        color: var(--primary-color);
        font-size: 1.2em;
        margin-top: 0;
        margin-bottom: 10px;
        font-weight: 600;
    }
    /* New styles for dynamic quiz on lesson page */
    #lesson-quiz-area {
        margin-top: calc(var(--spacing-unit) * 2);
        padding: calc(var(--spacing-unit) * 1.5);
        background: var(--bg-light);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        display: none; /* Hidden by default */
    }
    #lesson-quiz-area .question-text {
        font-size: 1.1em;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: var(--spacing-unit);
    }
    #lesson-quiz-area .options button {
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 0.95em;
        transition: all 0.3s ease;
    }
    #lesson-quiz-area .options button:hover {
        background-color: var(--secondary-color);
    }
    #lesson-quiz-area .options button.selected {
        background-color: var(--secondary-color);
    }
    #lesson-quiz-area .options button.correct {
        background-color: var(--secondary-color);
        box-shadow: 0 0 0 2px var(--secondary-color);
    }
    #lesson-quiz-area .options button.incorrect {
        background-color: #e74c3c;
        box-shadow: 0 0 0 2px #e74c3c;
    }
    #lesson-quiz-area .quiz-submit-btn {
        background: var(--primary-color);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s ease;
        margin-top: var(--spacing-unit);
        width: 100%;
    }
    #lesson-quiz-area .quiz-submit-btn:hover {
        background: var(--text-dark);
    }
    #lesson-quiz-area .quiz-feedback {
        margin-top: var(--spacing-unit);
        font-size: 1em;
        color: var(--text-dark);
        font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Custom Message Box -->
  <div id="custom-message" class="hidden"></div>

  <!-- Authentication Modal -->
  <div id="auth-modal-overlay" class="modal-overlay">
    <div id="auth-container">
      <button class="close-button" id="close-auth-modal" aria-label="Cerrar modal"><i class="fas fa-times"></i></button>
      
      <!-- Unified Login Form (default view) -->
      <div id="login-form">
        <h2>Iniciar Sesión</h2>
        <form id="login-email-form" aria-labelledby="login-heading">
          <input type="email" id="login-email" placeholder="Correo Electrónico" required autocomplete="email" aria-label="Correo electrónico" />
          <input type="password" id="login-password" placeholder="Contraseña" required autocomplete="current-password" aria-label="Contraseña" />
          <button type="submit">Iniciar Sesión</button>
        </form>
        <p class="toggle-form-link" role="button" tabindex="0" data-form-target="recover">¿Olvidaste tu contraseña?</p>
        
        <div class="alternative-options">
            <p>¿No tienes cuenta o prefieres explorar?</p>
            <button id="show-register-form">Registrarse</button>
            <button id="start-guest-mode">Continuar como Invitado</button>
        </div>
      </div>

      <!-- Register Form (hidden by default, shown by button click) -->
      <div id="register-form" class="hidden">
        <h2>Registrarse</h2>
        <form id="register-email-form" aria-labelledby="register-heading">
          <input type="email" id="register-email" placeholder="Correo Electrónico" required autocomplete="email" aria-label="Correo electrónico" />
          <input type="password" id="register-password" placeholder="Contraseña" required autocomplete="new-password" aria-label="Contraseña" />
          <button type="submit">Registrarse</button>
        </form>
        <p class="toggle-form-link" role="button" tabindex="0" data-form-target="login">¿Ya tienes cuenta? Inicia Sesión</p>
      </div>

      <!-- Recover Password Form (hidden by default, shown by link click) -->
      <div id="recover-password-form" class="hidden">
          <h2>Recuperar Contraseña</h2>
          <form id="recover-email-form" aria-labelledby="recover-heading">
              <p>Introduce tu correo electrónico para recibir un enlace de restablecimiento.</p>
              <input type="email" id="recover-email" placeholder="Correo Electrónico" required autocomplete="email" aria-label="Correo electrónico de recuperación" />
              <button type="submit">Enviar Enlace</button>
          </form>
          <p class="toggle-form-link" role="button" tabindex="0" data-form-target="login">Volver al Inicio de Sesión</p>
      </div>
    </div>
  </div>

  <!-- Main Content (Home Page sections) -->
  <main id="main-content">
    <!-- Sección 1: Barra Superior Delgada (Navegación Rápida) -->
    <div class="top-bar">
      <div class="left-links">
        <a href="#">Estudiantes</a>
        <a href="#">Profesionales</a>
        <a href="#">Futuros estudiantes</a>
        <a href="#">Preguntas más comunes</a>
      </div>
      <div class="right-links">
        <a href="#reviews-and-contact" data-subsection="contacto-section">Contacto, Reclamaciones y Sugerencias</a>
        <a href="#">Ayuda</a>
        <button id="access-button">Acceso Personalizado</button>
        <button id="logout-top-bar-button" class="hidden">Cerrar Sesión</button>
      </div>
    </div>

    <!-- Sección 2: Cabecera Principal -->
    <header>
      <div class="logo-group">
        <img src="https://placehold.co/60/4A90E2/FFFFFF?text=MG" alt="Logo de MultiGenio" />
        <h1>MultiGenio</h1>
      </div>
      <div class="main-nav-links">
        <a href="#home-sections" data-subsection="visual-presentation">¿Qué es esta página?</a>
        <a href="#cursos">¿Cómo inscribirte?</a>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Buscar..." aria-label="Barra de búsqueda" />
        <button type="button" aria-label="Buscar"><i class="fas fa-search"></i></button>
      </div>
      <div class="hamburger-menu" id="hamburger-menu-icon">
        <i class="fas fa-bars"></i>
      </div>
    </header>

    <!-- Menú lateral (Hamburguesa) -->
    <div class="sidebar-menu" id="sidebar-menu">
      <button class="close-sidebar" id="close-sidebar-menu">&times;</button>
      <div id="user-display-name" style="color: white; padding: 15px 20px; font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.1);"></div>
      <a href="#" class="nav-link" data-target-section="quiz-page">Cuestionario de Estilo de Aprendizaje</a>
      <a href="#" class="nav-link" data-target-section="home-sections" data-subsection="quiz-results-display-area">Resultados del Test</a>
      <a href="#" class="nav-link" data-target-section="cursos" data-subsection="avances-cursos">Avances de Cursos</a>
      <a href="#" class="nav-link" data-target-section="blog-page">Descubre el Blog</a>
      <button id="logout-button" style="background: none; border: none; color: white; padding: 15px 20px; text-align: left; font-size: 1em; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1);">Cerrar Sesión</button>
    </div>


    <!-- Contenedor principal de secciones de la Home Page -->
    <div id="home-sections">
      <!-- Sección 3: Presentación Visual e Interactiva -->
      <section id="visual-presentation" class="visual-presentation-section">
        <div class="left-content">
          <h2>Explora la interfaz de MultiGenio</h2>
          <div class="image-carousel" id="visual-carousel">
            <div class="carousel-images">
              <img src="https://placehold.co/500x300/A0D9F3/FFFFFF?text=Interfaz+del+Curso" alt="Interfaz de un curso de MultiGenio">
              <img src="https://placehold.co/500x300/C8E6C9/2C3E50?text=Pantalla+Interactiva" alt="Pantalla interactiva de MultiGenio">
              <img src="https://placehold.co/500x300/FFDDC1/2C3E50?text=Ejemplo+de+Temario" alt="Ejemplo de temario en MultiGenio">
            </div>
            <button class="carousel-nav-btn prev" aria-label="Imagen anterior"><i class="fas fa-chevron-left"></i></button>
            <button class="carousel-nav-btn next" aria-label="Siguiente imagen"><i class="fas fa-chevron-right"></i></button>
          </div>
          <p>Navega por nuestra interfaz intuitiva y descubre la riqueza de contenidos.</p>
          <div class="curiosities-section">
            <h3>¿Sabías que...?</h3>
            <p id="daily-curiosity">Cargando una curiosidad...</p>
          </div>
        </div>
        <div class="right-content">
          <div class="static-image-container">
            <img src="https://placehold.co/650x400/4A90E2/FFFFFF?text=Tecnología+Educativa" alt="Ilustración de tecnología educativa y aprendizaje personalizado">
            <div class="blog-promo">
              <h3>Descubre nuestro Blog</h3>
              <p>Mantente al día con las últimas tendencias en educación, IA y consejos de estudio.</p>
              <button id="discover-blog-button" class="nav-link" data-target-section="blog-page">Ir al Blog <i class="fas fa-arrow-right"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- Sección para mostrar los resultados del test de estilo de aprendizaje -->
      <section id="quiz-results-display-area" class="section">
        <h3>Resultados de tu Test de Aprendizaje</h3>
        <div id="quiz-results-content">
          <div id="result-message" class="result-card"></div>
          <div id="tdah-warning" class="result-card"></div>
          <div id="study-advice" class="result-card"></div>
        </div>
      </section>

      <!-- Sección 4: Temarios, Funcionamiento y Materias -->
      <section id="subjects-and-ai" class="subjects-section">
        <div class="left-content">
          <h2>IA Educativa y Métodos de Aprendizaje</h2>
          <p>En **MultiGenio**, transformamos la educación a través de la **Inteligencia Artificial**. Nuestra plataforma va más allá de los contenidos estándar, utilizando algoritmos avanzados para entender cómo aprendes mejor. Desde el primer momento, nuestro sistema de IA evalúa tus habilidades y preferencias para diseñar un camino educativo único, adaptado a tu ritmo y estilo.</p>
          <p>Nuestra IA no solo ofrece respuestas; genera explicaciones, ejercicios y recursos personalizados en tiempo real. Si un concepto es complejo, la IA puede presentártelo de múltiples formas hasta que lo domines, ya sea con diagramas, ejemplos prácticos o explicaciones verbales detalladas. Es como tener un tutor personal disponible 24/7.</p>
          <h3>Estilos de Aprendizaje Personalizados:</h3>
          <p>La clave de nuestra metodología reside en la detección y adaptación a los diferentes estilos de aprendizaje:</p>
          <div class="learning-methods">
            <span>Visual <i class="fas fa-eye"></i>: Aprendes mejor viendo gráficos, videos, diagramas y mapas mentales.</span>
            <span>Auditivo <i class="fas fa-volume-up"></i>: Prefieres escuchar conferencias, debates y explicaciones verbales.</span>
            <span>Lectura/Escritura <i class="fas fa-book"></i>: Asimilas la información leyendo textos, tomando apuntes detallados y escribiendo resúmenes.</span>
            <span>Kinestésico <i class="fas fa-running"></i>: Necesitas interactuar, experimentar y moverte para comprender y retener el conocimiento.</span>
          </div>
          <p style="margin-top: 15px;">**¡Tu viaje de aprendizaje comienza con un test!** Este test inicial nos permite identificar tu estilo predominante y si tienes alguna tendencia que requiera apoyo adicional (como el TDAH), para que la IA personalice aún más tu experiencia educativa.</p>
        </div>
        <div class="right-content">
          <h2>Explora por Materia</h2>
          <p>Selecciona una asignatura para acceder a sus temarios y comenzar tu aprendizaje adaptado.</p>
          <div class="subject-menu">
            <div class="subject-category">
              <h3 class="subject-toggle-header" data-subject-id="matematicas">Matemáticas <i class="fas fa-chevron-right icon"></i></h3>
              <div class="subject-topics-list" id="temario-matematicas">
                <button class="topic-selection-button" data-topic-id="operaciones-basicas" data-subject="matematicas">Operaciones Básicas</button>
                <button class="topic-selection-button" data-topic-id="fracciones" data-subject="matematicas">Fracciones y Decimales</button>
                <button class="topic-selection-button" data-topic-id="porcentajes" data-subject="matematicas">Porcentajes</button>
                <button class="topic-selection-button" data-topic-id="ecuaciones-primer-grado" data-subject="matematicas">Ecuaciones de Primer Grado</button>
                <button class="topic-selection-button" data-topic-id="sistemas-ecuaciones" data-subject="matematicas">Sistemas de Ecuaciones</button>
                <button class="topic-selection-button" data-topic-id="geometria-basica" data-subject="matematicas">Geometría Básica</button>
              </div>
            </div>
            <div class="subject-category">
              <h3 class="subject-toggle-header" data-subject-id="ingles">Inglés <i class="fas fa-chevron-right icon"></i></h3>
              <div class="subject-topics-list" id="temario-ingles">
                <button class="topic-selection-button" data-topic-id="basic-vocabulary" data-subject="ingles">Basic Vocabulary</button>
                <button class="topic-selection-button" data-topic-id="present-simple" data-subject="ingles">Present Simple & Continuous</button>
                <button class="topic-selection-button" data-topic-id="past-simple" data-subject="ingles">Past Simple & Past Continuous</button>
                <button class="topic-selection-button" data-topic-id="future-tenses" data-subject="ingles">Future Tenses</button>
                <button class="topic-selection-button" data-topic-id="conditionals" data-subject="ingles">Conditionals</button>
                <button class="topic-selection-button" data-topic-id="listening-speaking" data-subject="ingles">Listening & Speaking</button>
              </div>
            </div>
            <div class="subject-category">
              <h3 class="subject-toggle-header" data-subject-id="lengua">Lengua <i class="fas fa-chevron-right icon"></i></h3>
              <div class="subject-topics-list" id="temario-lengua">
                <button class="topic-selection-button" data-topic-id="ortografia-basica" data-subject="lengua">Ortografía Básica</button>
                <button class="topic-selection-button" data-topic-id="morfologia" data-subject="lengua">Morfología</button>
                <button class="topic-selection-button" data-topic-id="sintaxis-oracion-simple" data-subject="lengua">Sintaxis - Oración Simple</button>
                <button class="topic-selection-button" data-topic-id="sintaxis-oracion-compuesta" data-subject="lengua">Sintaxis - Oración Compuesta</button>
                <button class="topic-selection-button" data-topic-id="literatura-espanola" data-subject="lengua">Literatura Española</button>
                <button class="topic-selection-button" data-topic-id="expresion-escrita" data-subject="lengua">Expresión Escrita</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Sección 5: Opiniones y Contacto -->
      <section id="reviews-and-contact" class="reviews-contact-section">
        <h2>Opiniones de Expertos y Usuarios</h2>
        <div class="testimonials-carousel" id="testimonials-carousel">
          <div class="testimonials-slides">
            <div class="testimonial-slide">
              <img src="https://randomuser.me/api/portraits/men/60.jpg" alt="Dr. Javier Pérez">
              <h3>Dr. Javier Pérez, Pedagogo</h3>
              <p>"La adaptabilidad de MultiGenio es revolucionaria. Permite un aprendizaje verdaderamente inclusivo y eficaz para todo tipo de estudiantes."</p>
            </div>
            <div class="testimonial-slide">
              <video width="300" height="180" controls poster="https://placehold.co/300x180/E0F7FA/2C3E50?text=Video+Testimonio+1">
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                Tu navegador no soporta el tag de video.
              </video>
              <h3>María Fernández, Estudiante</h3>
              <p>"Antes me costaba muchísimo. Ahora, con MultiGenio, siento que el estudio es más fácil y divertido. ¡Mi rendimiento ha mejorado mucho!"</p>
            </div>
            <div class="testimonial-slide">
              <img src="https://randomuser.me/api/portraits/women/70.jpg" alt="Elena Navarro">
              <h3>Elena Navarro, Docente Innovadora</h3>
              <p>"Recomiendo MultiGenio a mis alumnos. La personalización del contenido por IA es una herramienta poderosa que los mantiene motivados."</p>
            </div>
          </div>
          <button class="testimonial-carousel-nav prev" aria-label="Testimonio anterior"><i class="fas fa-chevron-left"></i></button>
          <button class="testimonial-carousel-nav next" aria-label="Siguiente testimonio"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div id="reviews-section" class="section" style="box-shadow: none; margin: 0 auto; padding: 0;">
          <h2>Deja tu Reseña</h2>
          <div id="reviews-container">
            <!-- Las reseñas se cargarán aquí dinámicamente desde Firestore -->
          </div>
          <div id="review-submit-area">
            <p class="review-submit-info">¿Tienes una experiencia que compartir? ¡Déjanos tu reseña!</p>
            <form id="review-form" class="review-form hidden">
              <label for="review-text">Tu Reseña:</label>
              <textarea id="review-text" placeholder="Escribe aquí tu opinión sobre MultiGenio..." required aria-label="Escribe tu reseña"></textarea>
              <label>Tu Puntuación:</label>
              <div class="rating-stars" id="rating-stars">
                <button type="button" data-rating="1" aria-label="1 estrella">★</button>
                <button type="button" data-rating="2" aria-label="2 estrellas">★</button>
                <button type="button" data-rating="3" aria-label="3 estrellas">★</button>
                <button type="button" data-rating="4" aria-label="4 estrellas">★</button>
                <button type="button" data-rating="5" aria-label="5 estrellas">★</button>
              </div>
              <button type="submit">Enviar Reseña</button>
            </form>
            <button id="toggle-review-form-button">Escribir una reseña</button>
          </div>
        </div>

        <div class="footer-content">
          <div class="footer-section" id="contacto-section">
            <h3>Contacto</h3>
            <p>Email: info@multigenio.com</p>
            <p>Teléfono: +34 123 456 789</p>
            <p>Dirección: Calle del Saber, 1, Madrid, España</p>
            <!-- No se requiere un formulario de contacto separado si la info es suficiente -->
          </div>
          <div class="footer-section">
            <h3>Información Legal</h3>
            <a href="#">Política de Privacidad</a>
            <a href="#">Términos de Uso</a>
            <a href="#">Aviso Legal</a>
          </div>
          <div class="footer-section">
            <h3>Síguenos</h3>
            <div class="social-icons">
              <a href="https://facebook.com" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
              <a href="https://twitter.com" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
              <a href="https://instagram.com" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
              <a href="https://linkedin.com" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
            <h3>Métodos de Pago</h3>
            <div class="payment-logos">
              <img src="https://upload.wikimedia.org/wikipedia/commons/4/47/Visa-logo.svg" alt="Logo de Visa" />
              <img src="https://upload.wikimedia.org/wikipedia/commons/b/b7/MasterCard_Logo.svg" alt="Logo de Mastercard" />
              <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/PayPal_logo.png" alt="Logo de PayPal" />
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p class="copyright">&copy; 2025 MultiGenio. Todos los derechos reservados.</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Sección del Cuestionario (ahora una "página" separada) -->
  <section id="quiz-page" class="hidden section">
      <button class="back-button" id="back-from-quiz"><i class="fas fa-arrow-left"></i> Volver al Inicio</button>
      <div id="quiz-container">
          <h2>Test de Estilo de Aprendizaje</h2>
          <div id="quiz-questions-area"> <!-- Wrapper for dynamic quiz content -->
              <div id="question-text" class="question"></div>
              <div id="options" class="options"></div>
          </div>
          <button id="submit-quiz" class="hidden">Enviar Respuestas</button>
          <div id="result-message-quiz-page" class="hidden"></div>
          <div id="tdah-warning-quiz-page" class="hidden"></div>
          <div id="study-advice-quiz-page" class="hidden"></div>
      </div>
  </section>

  <!-- Sección de Cursos y Temas (ahora una "página" separada) -->
  <section id="cursos" class="hidden section">
    <h2>Explora nuestros <span style="color: var(--secondary-color);">Cursos y Temas</span></h2>
    <p class="text-center">Encuentra el conocimiento que buscas y comienza tu aventura de aprendizaje hoy.</p>
    <div class="topic-list" id="avances-cursos">
      <!-- Los topics se cargarán y mostrarán aquí. Los temarios completos se generarán al seleccionar un topic. -->
      <!-- Matemáticas Topics -->
      <div class="topic-item" data-topic-id="operaciones-basicas" data-subject="matematicas">
        <div class="topic-title">
          Matemáticas: Operaciones Básicas
          <span class="level-badge">Principiante</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Fundamentos de la aritmética.</div>
      </div>
      <div class="topic-item" data-topic-id="fracciones" data-subject="matematicas">
        <div class="topic-title">
          Matemáticas: Fracciones y Decimales
          <span class="level-badge">6º Primaria</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Conceptos, operaciones y equivalencias. Con ejemplos visuales.</div>
      </div>
      <div class="topic-item" data-topic-id="porcentajes" data-subject="matematicas">
        <div class="topic-title">
          Matemáticas: Porcentajes
          <span class="level-badge">1º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Cálculo de porcentajes, aumentos y descuentos.</div>
      </div>
      <div class="topic-item" data-topic-id="ecuaciones-primer-grado" data-subject="matematicas">
        <div class="topic-title">
          Matemáticas: Ecuaciones de Primer Grado
          <span class="level-badge">2º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Resolución paso a paso con métodos visuales.</div>
      </div>
      <div class="topic-item" data-topic-id="sistemas-ecuaciones" data-subject="matematicas">
        <div class="topic-title">
          Matemáticas: Sistemas de Ecuaciones
          <span class="level-badge">3º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Métodos de sustitución, igualación y reducción.</div>
      </div>
      <div class="topic-item" data-topic-id="geometria-basica" data-subject="matematicas">
        <div class="topic-title">
          Matemáticas: Geometría Básica
          <span class="level-badge">1º-2º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Conceptos fundamentales de figuras y cuerpos geométricos.</div>
      </div>

      <!-- Inglés Topics -->
      <div class="topic-item" data-topic-id="basic-vocabulary" data-subject="ingles">
        <div class="topic-title">
          Inglés: Basic Vocabulary
          <span class="level-badge">A1</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Numbers, colors, family, daily routines. Con apoyo visual.</div>
      </div>
      <div class="topic-item" data-topic-id="present-simple" data-subject="ingles">
        <div class="topic-title">
          Inglés: Present Simple & Continuous
          <span class="level-badge">A1-A2</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Tiempos verbales básicos con ejemplos prácticos.</div>
      </div>
      <div class="topic-item" data-topic-id="past-simple" data-subject="ingles">
        <div class="topic-title">
          Inglés: Past Simple & Past Continuous
          <span class="level-badge">A2</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Narración en pasado, verbos regulares e irregulares.</div>
      </div>
      <div class="topic-item" data-topic-id="future-tenses" data-subject="ingles">
        <div class="topic-title">
          Inglés: Future Tenses
          <span class="level-badge">A2-B1</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Will, going to, present continuous for future.</div>
      </div>
      <div class="topic-item" data-topic-id="conditionals" data-subject="ingles">
        <div class="topic-title">
          Inglés: Conditionals
          <span class="level-badge">B1</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">First, second and third conditional sentences.</div>
      </div>
      <div class="topic-item" data-topic-id="listening-speaking" data-subject="ingles">
        <div class="topic-title">
          Inglés: Listening & Speaking
          <span class="level-badge">A1-B1</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Mejora tus habilidades auditivas y de expresión oral.</div>
      </div>

      <!-- Lengua Topics -->
      <div class="topic-item" data-topic-id="ortografia-basica" data-subject="lengua">
        <div class="topic-title">
          Lengua: Ortografía Básica
          <span class="level-badge">Primaria</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Acentuación, uso de b/v, g/j, h. Con ejercicios prácticos.</div>
      </div>
      <div class="topic-item" data-topic-id="morfologia" data-subject="lengua">
        <div class="topic-title">
          Lengua: Morfología
          <span class="level-badge">1º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Categorías gramaticales: sustantivos, adjetivos, verbos, etc.</div>
      </div>
      <div class="topic-item" data-topic-id="sintaxis-oracion-simple" data-subject="lengua">
        <div class="topic-title">
          Lengua: Sintaxis - Oración Simple
          <span class="level-badge">2º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Sujeto, predicado y complementos básicos.</div>
      </div>
      <div class="topic-item" data-topic-id="sintaxis-oracion-compuesta" data-subject="lengua">
        <div class="topic-title">
          Lengua: Sintaxis - Oración Compuesta
          <span class="level-badge">3º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Oraciones coordinadas y subordinadas.</div>
      </div>
      <div class="topic-item" data-topic-id="literatura-espanola" data-subject="lengua">
        <div class="topic-title">
          Lengua: Literatura Española
          <span class="level-badge">2º-3º ESO</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Géneros literarios, métrica y autores principales.</div>
      </div>
      <div class="topic-item" data-topic-id="expresion-escrita" data-subject="lengua">
        <div class="topic-title">
          Lengua: Expresión Escrita
          <span class="level-badge">Todos</span>
          <span class="progress-indicator">Progreso: 0%</span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: 0%;"></div>
          <span class="progress-text">0% Completado</span>
        </div>
        <div class="topic-description">Desarrolla tus habilidades para redactar textos claros y efectivos.</div>
      </div>
    </div>
  </section>

  <!-- Sección de Visualización del Contenido de la Lección (ahora una "página" separada) -->
  <section id="lesson-content-display" class="hidden section">
    <button class="back-button" id="back-to-topics"><i class="fas fa-arrow-left"></i> Volver a Cursos</button>
    <h2 id="lesson-title"></h2>
    <div id="lesson-material">
      <!-- El contenido de la lección se cargará aquí dinámicamente -->
    </div>
    <div class="lesson-actions">
      <button id="ask-gemini-lesson">Preguntar a la IA <i class="fas fa-robot"></i></button>
      <button id="generate-topic-test">Generar Test de Este Tema <i class="fas fa-clipboard-question"></i></button>
      <button id="complete-lesson">Marcar como Completado <i class="fas fa-check"></i></button>
    </div>
    <div id="gemini-output-lesson" class="gemini-output hidden"></div>
    <div id="lesson-quiz-area" class="hidden">
      <h3>Test del Tema</h3>
      <div id="current-lesson-question"></div>
      <div id="current-lesson-options" class="options"></div>
      <button id="submit-lesson-quiz" class="quiz-submit-btn">Comprobar Respuesta</button>
      <div id="lesson-quiz-feedback" class="quiz-feedback hidden"></div>
      <button id="next-lesson-quiz-question" class="quiz-submit-btn hidden">Siguiente Pregunta</button>
      <button id="restart-lesson-quiz" class="quiz-submit-btn hidden">Reiniciar Test</button>
    </div>
  </section>

  <!-- Sección del Blog (ahora una "página" separada) -->
  <section id="blog-page" class="hidden section">
    <button class="back-button" id="back-from-blog"><i class="fas fa-arrow-left"></i> Volver al Inicio</button>
    <h2>Nuestro <span style="color: var(--primary-color);">Blog de Aprendizaje</span></h2>
    <p class="text-center">Mantente al día con los últimos consejos, trucos y novedades sobre educación y tecnología.</p>
    <div id="blog-actions" class="blog-actions">
      <button id="generate-blog-ideas">Generar Ideas de Blog (IA) <i class="fas fa-magic"></i></button>
    </div>
    <div id="blog-ideas-output" class="hidden">
      <h4>Ideas generadas por IA:</h4>
      <ul id="generated-ideas-list">
        <!-- Las ideas del blog se generarán aquí -->
      </ul>
    </div>
    <!-- Placeholder para artículos diarios (conceptual, la generación de contenido en vivo y persistente es compleja y requiere backend) -->
    <div id="daily-articles-section" class="section" style="box-shadow: none; margin-top: 40px; padding-top: 0; border-top: 1px solid var(--border-color);">
        <h3>Artículos Diarios Recientes</h3>
        <p class="text-center" style="font-style: italic; color: var(--text-light);">Aquí aparecerán los artículos diarios generados por nuestra IA, basados en las últimas investigaciones y noticias educativas. ¡Vuelve pronto para nuevas lecturas!</p>
        <div class="cards">
            <!-- Ejemplos de artículos dinámicos (estáticos por ahora, pero representativos) -->
            <div class="card">
                <img src="https://placehold.co/150x100/A2E3D0/2C3E50?text=IA+en+Educación" alt="Imagen de Inteligencia Artificial en Educación" />
                <h3>El Futuro del Aprendizaje con IA Adaptativa</h3>
                <p>Descubre cómo la inteligencia artificial está personalizando la educación y adaptándose a cada estudiante.</p>
                <a href="#" class="btn-read-more" style="color: var(--primary-color); text-decoration: none; font-weight: 600; margin-top: auto;">Leer más →</a>
            </div>
            <div class="card">
                <img src="https://placehold.co/150x100/FFD966/2C3E50?text=Noticias+Educativas" alt="Imagen de Noticias Educativas" />
                <h3>Noticias: Avances en Métodos de Estudio y Neurociencia</h3>
                <p>Exploramos los últimos descubrimientos en cómo funciona el cerebro y las técnicas de estudio más efectivas.</p>
                <a href="#" class="btn-read-more" style="color: var(--primary-color); text-decoration: none; font-weight: 600; margin-top: auto;">Leer más →</a>
            </div>
        </div>
    </div>
    <!-- Existing blog cards can stay or be loaded dynamically as well -->
    <div class="cards" style="margin-top: 40px;">
        <div class="card">
          <img src="https://placehold.co/150x100/ecf0f1/2c3e50?text=Artículo+1" alt="Imagen de un blog con la etiqueta Artículo 1" />
          <h3>5 Estrategias para Mejorar la Concentración</h3>
          <p>Descubre técnicas probadas para potenciar tu enfoque y productividad en el estudio diario.</p>
          <a href="#" class="btn-read-more" style="color: var(--primary-color); text-decoration: none; font-weight: 600; margin-top: auto;">Leer más →</a>
        </div>
        <div class="card">
          <img src="https://placehold.co/150x100/ecf0f1/2c3e50?text=Artículo+2" alt="Imagen de un blog con la etiqueta Artículo 2" />
          <h3>El Poder del Aprendizaje Adaptativo</h3>
          <p>Explora cómo la IA puede transformar tu experiencia educativa y ajustarse a tus necesidades únicas.</p>
          <a href="#" class="btn-read-more" style="color: var(--primary-color); text-decoration: none; font-weight: 600; margin-top: auto;">Leer más →</a>
        </div>
        <div class="card">
          <img src="https://placehold.co/150x100/ecf0f1/2c3e50?text=Artículo+3" alt="Imagen de un blog con la etiqueta Artículo 3" />
          <h3>Matemáticas Divertidas: Juegos para Aprender</h3>
          <p>Conoce los mejores juegos y actividades que hacen que aprender matemáticas sea una aventura.</p>
          <a href="#" class="btn-read-more" style="color: var(--primary-color); text-decoration: none; font-weight: 600; margin-top: auto;">Leer más →</a>
        </div>
      </div>
  </section>

  <!-- Botón flotante del chatbot -->
  <button id="chatbot-fab" aria-label="Abrir Chatbot">
    <i class="fas fa-comments"></i>
  </button>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken, sendPasswordResetEmail, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Default Firebase configuration (replace with your actual Firebase project config if not in Canvas)
    const defaultFirebaseConfig = {
      apiKey: "AIzaSyDklyhhZOV3c2KbbrvAZOpoUitPBWgRBOQ", // <<--- REEMPLAZA CON TU CLAVE API DE FIREBASE
      authDomain: "multigenio-39890.firebaseapp.com",
      projectId: "multigenio-39890",
      storageBucket: "multigenio-39890.firebasestorage.app",
      messagingSenderId: "881137429405",
      appId: "1:881137429405:web:9f061138bdf43b00dd5d74",
      measurementId: "G-9SQX18GVH6"
    };

    // Usa la configuración proporcionada por el entorno si está disponible, de lo contrario, usa la por defecto.
    // 'firebaseConfig' se declara aquí con 'let' porque su valor va a cambiar.
    let firebaseConfig;
    let app = null;
    let analytics = null;
    let auth = null;
    let db = null;

    // Elementos del DOM (declarados con 'let' para asignación posterior)
    let authModalOverlay, closeAuthModal, accessButton, logoutTopBarButton, hamburgerMenuIcon, sidebarMenu, closeSidebarMenu;
    let loginFormDiv, registerFormDiv, recoverPasswordFormDiv, showRegisterFormButton, startGuestModeButton;
    let loginEmailInput, loginPasswordInput, registerEmailInput, registerPasswordInput, recoverEmailInput;
    let userDisplayName, customMessage;
    let visualCarousel, carouselImagesContainer, prevCarouselBtn, nextCarouselBtn;
    let dailyCuriosityElement, discoverBlogButton;
    let subjectToggleHeaders, topicSelectionButtons;
    let quizPage, quizContainer, questionText, optionsDiv, submitQuizButton;
    let resultMessageQuizPage, tdahWarningQuizPage, studyAdviceQuizPage, quizResultsDisplayArea;
    let resultMessage, tdahWarning, studyAdvice, backFromQuizButton;
    let reviewForm, reviewTextarea, ratingStarsContainer, reviewsContainer, toggleReviewFormButton;
    let lessonContentDisplay, lessonMaterialDiv, lessonTitleElement, backToTopicsButton, askGeminiLessonButton;
    let completeLessonButton, geminiOutputLessonDiv, generateTopicTestButton, lessonQuizArea;
    let currentLessonQuestion, currentLessonOptions, submitLessonQuizButton, lessonQuizFeedback;
    let nextLessonQuizQuestionButton, restartLessonQuizButton;
    let blogPage, blogIdeasOutput, generateBlogIdeasButton, generatedIdeasList, backFromBlogButton;
    let mainContent, homeSections, cursosSection, reviewsAndContactSection, chatbotFab;
    let testimonialsSlidesContainer, prevTestimonialBtn, nextTestimonialBtn;
    let searchBarInput, searchBarButton;
    let subjectsAndAISec; // ¡Importante: declararla aquí también!

    // Global variables for carousels
    let currentCarouselIndex = 0;
    let totalCarouselImages = 0; // Will be set after DOM load
    let currentTestimonialIndex = 0;
    let totalTestimonials = 0; // Will be set after DOM load

    // Estado global de la aplicación
    let selectedRating = 0; // For review form
    let currentUser = null; // Objeto de usuario de Firebase
    let currentQuizIndex = 0; // For learning style quiz
    let userAnswers = {}; // Stores answers to quiz
    let topicsData = {}; // Progreso del usuario en temas

    let userLearningStyle = 'visual'; // Default for unauthenticated/new users
    let userTDAHStatus = 'no'; // Default
    let userQuizCompleted = false; // Track if the quiz has been completed by the authenticated user
    let currentLessonContent = ''; // To store the fetched lesson content for AI features
    let currentLessonQuizData = []; // Store dynamically generated quiz questions
    let currentLessonQuizQuestionIndex = 0;
    let selectedLessonQuizAnswer = null;

    // Configuración de la API de Gemini
    const GEMINI_API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
    const GEMINI_API_KEY = "AIzaSyBGKJQINcUZKVxCw8NI43bVmPsDqGVBsB0"; // <<--- VERIFICA QUE ESTA SEA TU CLAVE API DE GEMINI REAL

    // Quiz Data (for learning style test) - (Mantengo tu estructura de datos)
    const quizData = [
      {
        question: "Cuando aprendo algo nuevo, prefiero verlo representado visualmente (diagramas, gráficos, videos).",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'visual' },
        tdahOptionIndex: -1
      },
      {
        question: "Recuerdo mejor la información si la escucho (lecturas en voz alta, debates, grabaciones).",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'auditivo' },
        tdahOptionIndex: -1
      },
      {
        question: "Disfruto tomando apuntes detallados y leyendo textos para comprender un tema.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'lectura-escritura' },
        tdahOptionIndex: -1
      },
      {
        question: "Necesito manipular objetos o realizar actividades prácticas para asimilar el conocimiento.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'kinestesico' },
        tdahOptionIndex: -1
      },
      {
        question: "Las imágenes y los colores me ayudan significativamente a organizar y recordar la información.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'visual' },
        tdahOptionIndex: -1
      },
      {
        question: "Cuando estudio, me beneficia escuchar explicaciones o podcasts sobre el tema.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'auditivo' },
        tdahOptionIndex: -1
      },
      {
        question: "Prefiero resumir la información en mis propias palabras o crear listas para memorizar.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: { 4: 'lectura-escritura' },
        tdahOptionIndex: -1
      },
      {
        question: "Me siento más cómodo aprendiendo a través de la experimentación o el movimiento físico.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: {},
        tdahOptionIndex: [3, 4]
      },
      {
        question: "Me distraigo fácilmente con estímulos externos cuando intento concentrarme.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: {},
        tdahOptionIndex: [3, 4]
      },
      {
        question: "A menudo me cuesta terminar tareas que requieren un esfuerzo mental sostenido.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: {},
        tdahOptionIndex: [3, 4]
      },
      {
        question: "Me cuesta organizar mis tareas o actividades.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: {},
        tdahOptionIndex: [3, 4]
      },
      {
        question: "Con frecuencia olvido citas o lo que iba a decir a mitad de una conversación.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: {},
        tdahOptionIndex: [3, 4]
      },
      {
        question: "Me resulta difícil esperar mi turno en conversaciones o actividades grupales.",
        options: ["Totalmente en desacuerdo", "En desacuerdo", "Neutral", "De acuerdo", "Totalmente de acuerdo"],
        learningStyleMapping: {},
        tdahOptionIndex: [3, 4]
      }
    ];

    // Full temarios data structure - (Mantengo tu estructura de datos)
    const fullTemarios = {
        matematicas: [
            { id: "operaciones-basicas", name: "Operaciones Básicas", level: "Primaria", description: "Suma, resta, multiplicación y división. Problemas prácticos del día a día." },
            { id: "fracciones", name: "Fracciones y Decimales", level: "6º Primaria", description: "Conceptos, operaciones y equivalencias. Con ejemplos visuales." },
            { id: "porcentajes", name: "Porcentajes", level: "1º ESO", description: "Cálculo de porcentajes, aumentos y descuentos." },
            { id: "ecuaciones-primer-grado", name: "Ecuaciones de Primer Grado", level: "2º ESO", description: "Resolución paso a paso con métodos visuales." },
            { id: "sistemas-ecuaciones", name: "Sistemas de Ecuaciones", level: "3º ESO", description: "Métodos de sustitución, igualación y reducción." },
            { id: "geometria-basica", name: "Geometría Básica", level: "1º-2º ESO", description: "Conceptos fundamentales de figuras y cuerpos geométricos." }
        ],
        ingles: [
            { id: "basic-vocabulary", name: "Basic Vocabulary", level: "A1", description: "Numbers, colors, family, daily routines. Con apoyo visual." },
            { id: "present-simple", name: "Present Simple & Continuous", level: "A1-A2", description: "Tiempos verbales básicos con ejemplos prácticos." },
            { id: "past-simple", name: "Past Simple & Past Continuous", level: "A2", description: "Narración en pasado, verbos regulares e irregulares." },
            { id: "future-tenses", name: "Future Tenses", level: "A2-B1", description: "Will, going to, present continuous for future." },
            { id: "conditionals", name: "Conditionals", level: "B1", description: "First, second and third conditional sentences." },
            { id: "listening-speaking", name: "Listening & Speaking", level: "A1-B1", description: "Mejora tus habilidades auditivas y de expresión oral." }
        ],
        lengua: [
            { id: "ortografia-basica", name: "Ortografía Básica", level: "Primaria", description: "Acentuación, uso de b/v, g/j, h. Con ejercicios prácticos." },
            { id: "morfologia", name: "Morfología", level: "1º ESO", description: "Categorías gramaticales: sustantivos, adjetivos, verbos, etc." },
            { id: "sintaxis-oracion-simple", name: "Sintaxis - Oración Simple", level: "2º ESO", description: "Sujeto, predicado y complementos básicos." },
            { id: "sintaxis-oracion-compuesta", name: "Sintaxis - Oración Compuesta", level: "3º ESO", description: "Oraciones coordinadas y subordinadas." },
            { id: "literatura-espanola", name: "Literatura Española", level: "2º-3º ESO", description: "Géneros literarios, métrica y autores principales." },
            { id: "expresion-escrita", name: "Expresión Escrita", level: "Todos", description: "Desarrolla tus habilidades para redactar textos claros y efectivos." }
        ]
    };

    // --- Curiosidades Diarias ---
    const dailyCuriosities = [
        "¿Sabías que el cerebro humano pesa alrededor de 1.4 kg y contiene aproximadamente 86 mil millones de neuronas?",
        "Aprender un nuevo idioma puede mejorar tus habilidades cognitivas y de resolución de problemas.",
        "La técnica de estudio 'Pomodoro' implica trabajar en bloques de 25 minutos seguidos de descansos cortos.",
        "Dormir lo suficiente es crucial para la consolidación de la memoria y el aprendizaje efectivo.",
        "El aprendizaje kinestésico se beneficia de la actividad física y la manipulación de objetos.",
        "La lectura en voz alta puede mejorar la retención de información para estudiantes auditivos.",
        "Los mapas mentales son una herramienta visual excelente para organizar ideas y conceptos.",
        "El ejercicio regular no solo es bueno para el cuerpo, sino que también mejora la función cerebral y el aprendizaje.",
        "La neuroplasticidad es la capacidad del cerebro para cambiar y adaptarse a lo largo de la vida, ¡siempre puedes aprender algo nuevo!",
        "La retroalimentación instantánea es una de las ventajas clave de la IA en la educación personalizada."
    ];

    let currentCuriosityIndex = 0;
    let dailyCuriosityInterval; // Para controlar el intervalo


    /**
     * Asigna los elementos del DOM a las variables correspondientes
     * y adjunta todos los event listeners.
     * Esta función debe llamarse una vez que el DOM esté completamente cargado.
     */
    function assignDOMElementsAndAttachListeners() {
        // Asignación de elementos del DOM
        authModalOverlay = document.getElementById('auth-modal-overlay');
        closeAuthModal = document.getElementById('close-auth-modal');
        accessButton = document.getElementById('access-button');
        logoutTopBarButton = document.getElementById('logout-top-bar-button');
        hamburgerMenuIcon = document.getElementById('hamburger-menu-icon');
        sidebarMenu = document.getElementById('sidebar-menu');
        closeSidebarMenu = document.getElementById('close-sidebar-menu');
        loginFormDiv = document.getElementById('login-form');
        registerFormDiv = document.getElementById('register-form');
        recoverPasswordFormDiv = document.getElementById('recover-password-form');
        showRegisterFormButton = document.getElementById('show-register-form');
        startGuestModeButton = document.getElementById('start-guest-mode');
        loginEmailInput = document.getElementById('login-email');
        loginPasswordInput = document.getElementById('login-password');
        registerEmailInput = document.getElementById('register-email');
        registerPasswordInput = document.getElementById('register-password');
        recoverEmailInput = document.getElementById('recover-email');
        userDisplayName = document.getElementById('user-display-name');
        customMessage = document.getElementById('custom-message');
        visualCarousel = document.getElementById('visual-carousel');
        carouselImagesContainer = visualCarousel ? visualCarousel.querySelector('.carousel-images') : null;
        prevCarouselBtn = visualCarousel ? visualCarousel.querySelector('.carousel-nav-btn.prev') : null;
        nextCarouselBtn = visualCarousel ? visualCarousel.querySelector('.carousel-nav-btn.next') : null;
        dailyCuriosityElement = document.getElementById('daily-curiosity');
        discoverBlogButton = document.getElementById('discover-blog-button');
        subjectToggleHeaders = document.querySelectorAll('.subject-toggle-header');
        topicSelectionButtons = document.querySelectorAll('.subject-topics-list .topic-selection-button');
        quizPage = document.getElementById('quiz-page');
        quizContainer = document.getElementById('quiz-container');
        questionText = document.getElementById('question-text');
        optionsDiv = document.getElementById('options');
        submitQuizButton = document.getElementById('submit-quiz');
        resultMessageQuizPage = document.getElementById('result-message-quiz-page');
        tdahWarningQuizPage = document.getElementById('tdah-warning-quiz-page');
        studyAdviceQuizPage = document.getElementById('study-advice-quiz-page');
        quizResultsDisplayArea = document.getElementById('quiz-results-display-area');
        resultMessage = document.getElementById('result-message');
        tdahWarning = document.getElementById('tdah-warning');
        studyAdvice = document.getElementById('study-advice');
        backFromQuizButton = document.getElementById('back-from-quiz');
        reviewForm = document.getElementById('review-form');
        reviewTextarea = document.getElementById('review-text');
        ratingStarsContainer = document.getElementById('rating-stars');
        reviewsContainer = document.getElementById('reviews-container');
        toggleReviewFormButton = document.getElementById('toggle-review-form-button');
        lessonContentDisplay = document.getElementById('lesson-content-display');
        lessonMaterialDiv = document.getElementById('lesson-material');
        lessonTitleElement = document.getElementById('lesson-title');
        backToTopicsButton = document.getElementById('back-to-topics');
        askGeminiLessonButton = document.getElementById('ask-gemini-lesson');
        completeLessonButton = document.getElementById('complete-lesson');
        geminiOutputLessonDiv = document.getElementById('gemini-output-lesson');
        generateTopicTestButton = document.getElementById('generate-topic-test');
        lessonQuizArea = document.getElementById('lesson-quiz-area');
        currentLessonQuestion = document.getElementById('current-lesson-question');
        currentLessonOptions = document.getElementById('current-lesson-options');
        submitLessonQuizButton = document.getElementById('submit-lesson-quiz');
        lessonQuizFeedback = document.getElementById('lesson-quiz-feedback');
        nextLessonQuizQuestionButton = document.getElementById('next-lesson-quiz-question');
        restartLessonQuizButton = document.getElementById('restart-lesson-quiz');
        blogPage = document.getElementById('blog-page');
        blogIdeasOutput = document.getElementById('blog-ideas-output');
        generateBlogIdeasButton = document.getElementById('generate-blog-ideas');
        generatedIdeasList = document.getElementById('generated-ideas-list');
        backFromBlogButton = document.getElementById('back-from-blog');
        mainContent = document.getElementById('main-content');
        homeSections = document.getElementById('home-sections');
        cursosSection = document.getElementById('cursos');
        reviewsAndContactSection = document.getElementById('reviews-and-contact');
        chatbotFab = document.getElementById('chatbot-fab');
        testimonialsSlidesContainer = document.querySelector('.testimonials-slides');
        prevTestimonialBtn = document.querySelector('.testimonial-carousel-nav.prev');
        nextTestimonialBtn = document.querySelector('.testimonial-carousel-nav.next');
        searchBarInput = document.querySelector('.search-bar input');
        searchBarButton = document.querySelector('.search-bar button');
        subjectsAndAISec = document.getElementById('subjects-and-ai'); // ¡Asegúrate de que esta línea esté aquí!

        // Asignar totales para carruseles después de que los elementos estén disponibles
        if (carouselImagesContainer) totalCarouselImages = carouselImagesContainer.children.length;
        if (testimonialsSlidesContainer) totalTestimonials = testimonialsSlidesContainer.children.length;

        // --- Adjuntar Event Listeners (MOVIDOS AQUÍ DESDE EL SEGUNDO SCRIPT) ---
        if (accessButton) accessButton.addEventListener('click', () => toggleModal(true, 'login'));
        if (closeAuthModal) closeAuthModal.addEventListener('click', () => toggleModal(false));

        const logoutButton = document.getElementById('logout-button'); // Sidebar logout button
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                if (!auth) {
                    showMessage("Servicio de autenticación no disponible.", 'error');
                    return;
                }
                try {
                    await signOut(auth);
                    showMessage("Sesión cerrada correctamente.", 'success');
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    showMessage("Error al cerrar sesión.", 'error');
                }
            });
        }
        if (logoutTopBarButton) {
            logoutTopBarButton.addEventListener('click', async () => {
                if (!auth) {
                    showMessage("Servicio de autenticación no disponible.", 'error');
                    return;
                }
                try {
                    await signOut(auth);
                    showMessage("Sesión cerrada correctamente.", 'success');
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    showMessage("Error al cerrar sesión.", 'error');
                }
            });
        }

        if (showRegisterFormButton) {
            showRegisterFormButton.addEventListener('click', () => {
                toggleModal(true, 'register');
            });
        }

        document.querySelectorAll('#login-form .toggle-form-link').forEach(link => {
            link.addEventListener('click', (e) => {
                const targetForm = e.target.dataset.formTarget;
                toggleModal(true, targetForm);
            });
        });

        document.querySelectorAll('#register-form .toggle-form-link, #recover-password-form .toggle-form-link').forEach(link => {
            link.addEventListener('click', () => {
                toggleModal(true, 'login');
            });
        });

        if (document.getElementById('register-email-form')) {
            document.getElementById('register-email-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth || !registerEmailInput || !registerPasswordInput) {
                    showMessage("Servicio de autenticación o campos de registro no disponibles.", 'error');
                    return;
                }
                const email = registerEmailInput.value;
                const password = registerPasswordInput.value;

                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessage("Registro exitoso. ¡Bienvenido!", 'success');
                } catch (error) {
                    console.error("Error de registro:", error);
                    let errorMessage = "Error al registrarse. Por favor, inténtalo de nuevo.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "Este correo electrónico ya está en uso.";
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = "La contraseña debe tener al menos 6 caracteres.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Formato de correo electrónico inválido.";
                    }
                    showMessage(errorMessage, 'error');
                }
            });
        }

        if (document.getElementById('login-email-form')) {
            document.getElementById('login-email-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth || !loginEmailInput || !loginPasswordInput) {
                    showMessage("Servicio de autenticación o campos de inicio de sesión no disponibles.", 'error');
                    return;
                }
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage("Inicio de sesión exitoso. ¡Bienvenido de nuevo!", 'success');
                } catch (error) {
                    console.error("Error de inicio de sesión:", error);
                    let errorMessage = "Error al iniciar sesión. Por favor, inténtalo de nuevo.";
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = "Contraseña incorrecta. Intenta de nuevo.";
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = "No se encontró una cuenta con ese correo electrónico.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Formato de correo electrónico inválido.";
                    }
                    showMessage(errorMessage, 'error');
                }
            });
        }

        if (document.getElementById('recover-email-form')) {
            document.getElementById('recover-email-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!auth || !recoverEmailInput) {
                    showMessage("Servicio de autenticación o campo de correo electrónico no disponible.", 'error');
                    return;
                }
                const email = recoverEmailInput.value;
                try {
                    await sendPasswordResetEmail(auth, email);
                    showMessage("Enlace de restablecimiento enviado a tu correo electrónico.", 'success', 5000);
                    toggleModal(false);
                } catch (error) {
                    console.error("Error al enviar enlace de restablecimiento:", error);
                    showMessage(`Error: ${error.message}`, 'error');
                }
            });
        }

        if (startGuestModeButton) {
            startGuestModeButton.addEventListener('click', async () => {
                if (!auth) {
                    showMessage("Servicio de autenticación no disponible.", 'error');
                    return;
                }
                try {
                    await signInAnonymously(auth);
                    showMessage("Has iniciado en modo invitado. Tu progreso no se guardará.", 'info', 5000);
                    toggleModal(false);
                } catch (error) {
                    console.error("Error al iniciar sesión anónimamente:", error);
                    showMessage("Error al iniciar en modo invitado. Intenta de nuevo.", 'error');
                }
            });
        }

        if (backFromQuizButton) {
            backFromQuizButton.addEventListener('click', () => {
                showSection('home-sections');
            });
        }

        if (backFromBlogButton) {
            backFromBlogButton.addEventListener('click', () => {
                showSection('home-sections');
            });
        }


        if (submitQuizButton) {
            submitQuizButton.addEventListener('click', async () => {
                const learningStyleScores = { visual: 0, auditivo: 0, 'lectura-escritura': 0, kinestesico: 0 };
                let tdahIndicationCount = 0;

                quizData.forEach((question, index) => {
                    const selectedOption = userAnswers[index];
                    if (selectedOption !== undefined) {
                        const style = question.learningStyleMapping[selectedOption];
                        if (style) {
                            learningStyleScores[style]++;
                        }
                        if (Array.isArray(question.tdahOptionIndex) && question.tdahOptionIndex.includes(selectedOption)) {
                            tdahIndicationCount++;
                        }
                    }
                });

                let primaryLearningStyle = 'visual';
                let maxScore = -1;
                for (const style in learningStyleScores) {
                    if (learningStyleScores[style] > maxScore) {
                        maxScore = learningStyleScores[style];
                        primaryLearningStyle = style;
                    }
                }
                userLearningStyle = primaryLearningStyle;

                userTDAHStatus = tdahIndicationCount >= 2 ? 'tdah' : 'no';

                if (quizContainer) quizContainer.classList.add('hidden');

                userQuizCompleted = true; // Mark quiz as completed

                updateQuizResultDisplay();

                if (currentUser && !currentUser.isAnonymous && db) {
                    await saveUserPreferences();
                    showMessage("Resultado del test guardado.", 'success');
                } else if (!currentUser || currentUser.isAnonymous) {
                    showMessage("Tu resultado no se guardará en modo invitado. Inicia sesión para guardar.", 'info');
                } else {
                    showMessage("Error: Firebase no inicializado. No se pudo guardar el resultado.", 'error');
                }
                showSection('home-sections', 'quiz-results-display-area');
            });
        }

        if (ratingStarsContainer) {
            ratingStarsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    selectedRating = parseInt(e.target.dataset.rating);
                    document.querySelectorAll('#rating-stars button').forEach(button => {
                        button.classList.remove('selected');
                    });
                    for (let i = 1; i <= selectedRating; i++) {
                        const starButton = document.querySelector(`#rating-stars button[data-rating="${i}"]`);
                        if (starButton) starButton.classList.add('selected');
                    }
                }
            });
        }

        if (reviewForm) {
            reviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || currentUser.isAnonymous) {
                    showMessage("Debes iniciar sesión para enviar una reseña.", 'error');
                    toggleModal(true);
                    return;
                }
                if (selectedRating === 0) {
                    showMessage("Por favor, selecciona una puntuación.", 'error');
                    return;
                }
                if (!db) {
                    showMessage("Error: Firebase no inicializado. No se pudo enviar la reseña.", 'error');
                    return;
                }
                if (!reviewTextarea || !ratingStarsContainer) {
                    showMessage("Error: Elementos del formulario de reseña no encontrados.", 'error');
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);
                    await setDoc(doc(reviewsCollectionRef), { // Use setDoc with a new auto-generated ID
                        userId: currentUser.uid,
                        userName: currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : "Usuario Anónimo"),
                        reviewText: reviewTextarea.value,
                        rating: selectedRating,
                        timestamp: serverTimestamp()
                    });
                    showMessage("Reseña enviada con éxito. ¡Gracias!", 'success');
                    reviewTextarea.value = '';
                    selectedRating = 0;
                    document.querySelectorAll('#rating-stars button').forEach(button => {
                        button.classList.remove('selected');
                    });
                    reviewForm.classList.add('hidden');
                    if (toggleReviewFormButton) toggleReviewFormButton.textContent = 'Escribir una reseña';
                } catch (error) {
                    console.error("Error al añadir documento: ", error);
                    showMessage("Error al enviar reseña.", 'error');
                }
            });
        }

        if (toggleReviewFormButton) {
            toggleReviewFormButton.addEventListener('click', () => {
                if (reviewForm) {
                    reviewForm.classList.toggle('hidden');
                    if (reviewForm.classList.contains('hidden')) {
                        toggleReviewFormButton.textContent = 'Escribir una reseña';
                    } else {
                        toggleReviewFormButton.textContent = 'Ocultar formulario';
                    }
                }
            });
        }

        if (subjectToggleHeaders) {
            subjectToggleHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    if (!currentUser || currentUser.isAnonymous) {
                        showMessage("Inicia sesión para ver los temarios.", 'info');
                        toggleModal(true);
                        return;
                    }
                    if (!userQuizCompleted) {
                        showMessage("Por favor, completa primero el Cuestionario de Estilo de Aprendizaje para desbloquear los temarios.", 'info');
                        showSection('quiz-page');
                        return;
                    }

                    const subjectId = header.dataset.subjectId;
                    const topicsList = document.getElementById(`temario-${subjectId}`);
                    const icon = header.querySelector('.icon');

                    if (topicsList && icon) {
                        topicsList.classList.toggle('active');
                        header.classList.toggle('expanded');
                    }
                });
            });
        }

        if (topicSelectionButtons) {
            topicSelectionButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const topicId = button.dataset.topicId;
                    const subject = button.dataset.subject;

                    if (!currentUser || currentUser.isAnonymous || !userQuizCompleted) {
                        showMessage("Debes iniciar sesión y completar el cuestionario para acceder a las lecciones.", 'error');
                        toggleModal(true);
                        return;
                    }

                    const selectedTopicDetails = fullTemarios[subject].find(t => t.id === topicId);
                    if (!selectedTopicDetails) {
                        showMessage("Error: Información del tema no encontrada.", 'error');
                        return;
                    }

                    showSection('lesson-content-display');
                    if (document.querySelector('main')) document.querySelector('main').scrollIntoView({ behavior: 'smooth' });

                    if (lessonTitleElement) lessonTitleElement.textContent = `Lección: ${selectedTopicDetails.name} (${selectedTopicDetails.level})`;
                    if (lessonMaterialDiv) {
                        lessonMaterialDiv.innerHTML = `
                            <p class="text-center" style="margin-top: 20px;">Generando contenido adaptado a tu estilo de aprendizaje...</p>
                            <div style="display: flex; justify-content: center; align-items: center; height: 100px;">
                                <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-color);"></i>
                            </div>
                        `;
                    } else {
                        console.error("Elemento 'lessonMaterialDiv' no encontrado.");
                        showMessage("Error: No se puede mostrar el contenido de la lección.", 'error');
                        return;
                    }

                    const prompt = `Genera un contenido de lección detallado, CONCISO y EXTENSO sobre el tema específico "${selectedTopicDetails.name}" de la materia "${subject}" (nivel: ${selectedTopicDetails.level}) para un estudiante con estilo de aprendizaje "${userLearningStyle}".
                                    Incluye:
                                    - Varias subsecciones con encabezados (<h3>).
                                    - Párrafos explicativos claros.
                                    - Una imagen de placehold.co con un alt descriptivo (Ej: <img src="https://placehold.co/600x400/4A90E2/FFFFFF?text=Diagrama+de+${selectedTopicDetails.name.replace(/ /g, '+')}" alt="Diagrama de ${selectedTopicDetails.name}">).
                                    - Un video de ejemplo (Ej: <video width="100%" controls src="https://www.w3schools.com/html/mov_bbb.mp4" poster="https://placehold.co/600x337/50B86F/FFFFFF?text=Video+Explicativo+de+${selectedTopicDetails.name.replace(/ /g, '+')}" aria-label="Video explicativo sobre ${selectedTopicDetails.name}"></video>).
                                    - Un audio de ejemplo (Ej: <audio controls src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" aria-label="Audio explicativo sobre ${selectedTopicDetails.name}"></audio>).
                                    - Un campo de texto (<textarea>) para que el usuario tome notas o haga un resumen.
                                    - Un placeholder para un "juego interactivo" (div con clase 'interactive-game-placeholder').
                                    Asegúrate de que el contenido sea preciso, educativo y adaptado al nivel de dificultad especificado.
                                    El contenido debe ser en español.
                                    `;

                    try {
                        const response = await fetch(`${GEMINI_API_BASE_URL}?key=${GEMINI_API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                        });
                        const data = await response.json();

                        if (data.candidates && data.candidates.length > 0 &&
                            data.candidates[0].content && data.candidates[0].content.parts &&
                            Array.isArray(data.candidates[0].content.parts) &&
                            data.candidates[0].content.parts.length > 0) {
                            const generatedHtml = data.candidates[0].content.parts[0].text;
                            if (lessonMaterialDiv) lessonMaterialDiv.innerHTML = generatedHtml.replace(/```html\n?|\n?```/g, '');
                            currentLessonContent = lessonMaterialDiv ? lessonMaterialDiv.textContent : '';
                        } else {
                            console.error("Estructura de respuesta de Gemini inesperada:", data);
                            if (lessonMaterialDiv) lessonMaterialDiv.innerHTML = `<p class="text-center" style="color: red;">Error: La IA no pudo generar el contenido de la lección.</p>`;
                            showMessage("Error al generar el contenido de la lección.", 'error');
                        }

                        if (completeLessonButton) {
                            completeLessonButton.onclick = () => {
                                const currentProgress = topicsData[topicId] || 0;
                                const newProgress = Math.min(100, currentProgress + 25);
                                updateProgress(topicId, newProgress);
                                showMessage(`Progreso de ${selectedTopicDetails.name} actualizado al ${newProgress}%`, 'success');
                            };
                        }

                        if (askGeminiLessonButton) {
                            askGeminiLessonButton.onclick = async () => {
                                const lessonTextarea = lessonMaterialDiv ? lessonMaterialDiv.querySelector('textarea') : null;
                                if (!lessonTextarea) {
                                    console.error("TextArea de lección no encontrado.");
                                    showMessage("Error: El campo de texto para la IA no está disponible.", 'error');
                                    return;
                                }
                                const geminiInput = lessonTextarea.value;

                                if (!geminiOutputLessonDiv) {
                                    console.error("Elemento 'gemini-output-lesson' no encontrado.");
                                    showMessage("Error: No se puede mostrar la respuesta de la IA.", 'error');
                                    return;
                                }

                                if (geminiInput.trim() === "") {
                                    showMessage("Por favor, escribe algo para que la IA te ayude.", 'error');
                                    return;
                                }

                                geminiOutputLessonDiv.classList.remove('hidden');
                                geminiOutputLessonDiv.innerHTML = `<h4>Respuesta de la IA:</h4><p>Cargando respuesta...</p>`;

                                const geminiPrompt = `Basado en el siguiente texto de lección: "${currentLessonContent}", proporciona una respuesta útil a la pregunta del usuario: "${geminiInput}"`;

                                try {
                                    const geminiResponse = await fetch(`${GEMINI_API_BASE_URL}?key=${GEMINI_API_KEY}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: geminiPrompt }] }] })
                                    });
                                    const geminiData = await geminiResponse.json();

                                    if (geminiData.candidates && geminiData.candidates.length > 0 &&
                                        geminiData.candidates[0].content && geminiData.candidates[0].content.parts &&
                                        Array.isArray(geminiData.candidates[0].content.parts) &&
                                        geminiData.candidates[0].content.parts.length > 0) {
                                        const geminiAnswer = geminiData.candidates[0].content.parts[0].text;
                                        geminiOutputLessonDiv.innerHTML = `<h4>Respuesta de la IA:</h4><p>${geminiAnswer}</p>`;
                                    } else {
                                        console.error("Estructura de respuesta de Gemini inesperada para la pregunta:", geminiData);
                                        geminiOutputLessonDiv.innerHTML = `<h4>Respuesta de la IA:</h4><p>Error al obtener la respuesta de la IA. Por favor, inténtalo de nuevo.</p>`;
                                    }
                                } catch (error) {
                                    console.error("Error al llamar a Gemini para la pregunta:", error);
                                    geminiOutputLessonDiv.innerHTML = `<h4>Respuesta de la IA:</h4><p>Error al obtener la respuesta de la IA. Por favor, inténtalo de nuevo.</p>`;
                                }
                            };
                        }

                        if (generateTopicTestButton) {
                          generateTopicTestButton.onclick = async () => {
                              if (!currentUser || currentUser.isAnonymous) {
                                  showMessage("Debes iniciar sesión para generar un test.", 'error');
                                  toggleModal(true);
                                  return;
                              }
                              if (!currentLessonContent) {
                                  showMessage("Por favor, espera a que la lección se cargue completamente antes de generar un test.", 'error');
                                  return;
                              }
                              if (!lessonQuizArea || !currentLessonQuestion || !currentLessonOptions || !submitLessonQuizButton) {
                                console.error("Elementos del test de lección no encontrados.");
                                showMessage("Error: No se puede generar el test de la lección.", 'error');
                                return;
                              }

                              lessonQuizArea.classList.remove('hidden');
                              currentLessonQuestion.innerHTML = `<p>Generando test... <i class="fas fa-spinner fa-spin"></i></p>`;
                              currentLessonOptions.innerHTML = '';
                              submitLessonQuizButton.classList.add('hidden');
                              nextLessonQuizQuestionButton.classList.add('hidden');
                              restartLessonQuizButton.classList.add('hidden');
                              lessonQuizFeedback.classList.add('hidden');

                              const testPrompt = `Basado en el siguiente contenido de lección sobre "${selectedTopicDetails.name}" de ${subject} (nivel: ${selectedTopicDetails.level}):
                              ${currentLessonContent.substring(0, 2000)}

                              Genera un test de 5 preguntas de opción múltiple. Cada pregunta debe tener 4 opciones (A, B, C, D) y solo una respuesta correcta. Incluye un nivel de dificultad variado (fácil, medio, difícil).
                              Formato de salida JSON:
                              [
                                {
                                  "question": "Texto de la pregunta?",
                                  "options": ["Opción A", "Opción B", "Opción C", "Opción D"],
                                  "correctAnswerIndex": 0,
                                  "difficulty": "fácil/medio/difícil"
                                }
                                // ... 4 preguntas más
                              ]`;

                              try {
                                  const testResponse = await fetch(`${GEMINI_API_BASE_URL}?key=${GEMINI_API_KEY}`, {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: testPrompt }] }],
                                          generationConfig: {
                                              responseMimeType: "application/json",
                                              responseSchema: {
                                                  type: "ARRAY",
                                                  items: {
                                                      type: "OBJECT",
                                                      properties: {
                                                          "question": { "type": "STRING" },
                                                          "options": {
                                                              "type": "ARRAY",
                                                              "items": { "type": "STRING" }
                                                          },
                                                          "correctAnswerIndex": { "type": "NUMBER" },
                                                          "difficulty": { "type": "STRING" }
                                                      },
                                                      "required": ["question", "options", "correctAnswerIndex", "difficulty"]
                                                  }
                                              }
                                          }
                                      })
                                  });
                                  const testData = await testResponse.json();

                                  if (testData.candidates && testData.candidates.length > 0 &&
                                      testData.candidates[0].content && testData.candidates[0].content.parts &&
                                      testData.candidates[0].content.parts.length > 0) {

                                      const jsonString = testData.candidates[0].content.parts[0].text;
                                      try {
                                          currentLessonQuizData = JSON.parse(jsonString);
                                          if (currentLessonQuizData.length > 0) {
                                              currentLessonQuizQuestionIndex = 0;
                                              displayLessonQuizQuestion();
                                              submitLessonQuizButton.classList.remove('hidden');
                                              showMessage("Test generado con éxito.", 'success');
                                          } else {
                                              showMessage("La IA no pudo generar preguntas para el test.", 'error');
                                              lessonQuizArea.classList.add('hidden');
                                          }
                                      } catch (jsonError) {
                                          console.error("Error parsing generated quiz JSON:", jsonError, jsonString);
                                          showMessage("Error al procesar el test generado. Formato inesperado.", 'error');
                                          lessonQuizArea.classList.add('hidden');
                                      }
                                  } else {
                                      console.error("Estructura de respuesta de Gemini inesperada para el test:", testData);
                                      showMessage("Error al generar el test. No se recibió una respuesta válida.", 'error');
                                      lessonQuizArea.classList.add('hidden');
                                  }

                              } catch (error) {
                                  console.error("Error al llamar a Gemini para el test:", error);
                                  showMessage("Error de conexión al generar el test. Inténtalo de nuevo.", 'error');
                                  lessonQuizArea.classList.add('hidden');
                              }
                          };
                        }

                    } catch (error) {
                        console.error("Error al generar el contenido de la lección:", error);
                        if (lessonMaterialDiv) lessonMaterialDiv.innerHTML = `<p class="text-center" style="color: red;">Error al cargar el contenido de la lección. Por favor, inténtalo de nuevo.</p>`;
                        showMessage("Error al cargar el contenido de la lección.", 'error');
                    }
                });
            });
        }

        if (submitLessonQuizButton) {
            submitLessonQuizButton.addEventListener('click', () => {
                if (selectedLessonQuizAnswer === null) {
                    showMessage("Por favor, selecciona una opción.", 'info');
                    return;
                }

                const currentQ = currentLessonQuizData[currentLessonQuizQuestionIndex];
                const isCorrect = (selectedLessonQuizAnswer === currentQ.correctAnswerIndex);

                currentLessonOptions.querySelectorAll('button').forEach((btn, idx) => {
                    if (idx === currentQ.correctAnswerIndex) {
                        btn.classList.add('correct');
                    } else if (idx === selectedLessonQuizAnswer && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                    btn.disabled = true; // Disable buttons after answering
                });

                if (isCorrect) {
                    lessonQuizFeedback.textContent = "¡Correcto! ✅";
                    lessonQuizFeedback.style.color = 'var(--secondary-color)';
                } else {
                    lessonQuizFeedback.textContent = `Incorrecto. La respuesta correcta era: ${currentQ.options[currentQ.correctAnswerIndex]}.`;
                    lessonQuizFeedback.style.color = '#e74c3c';
                }
                lessonQuizFeedback.classList.remove('hidden');
                submitLessonQuizButton.classList.add('hidden');

                if (currentLessonQuizQuestionIndex < currentLessonQuizData.length - 1) {
                    nextLessonQuizQuestionButton.classList.remove('hidden');
                } else {
                    restartLessonQuizButton.classList.remove('hidden');
                }
            });
        }

        if (nextLessonQuizQuestionButton) {
            nextLessonQuizQuestionButton.addEventListener('click', () => {
                currentLessonQuizQuestionIndex++;
                selectedLessonQuizAnswer = null;
                lessonQuizFeedback.classList.add('hidden');
                displayLessonQuizQuestion();
            });
        }

        if (restartLessonQuizButton) {
            restartLessonQuizButton.addEventListener('click', () => {
                currentLessonQuizQuestionIndex = 0;
                selectedLessonQuizAnswer = null;
                lessonQuizFeedback.classList.add('hidden');
                displayLessonQuizQuestion();
            });
        }

        if (backToTopicsButton) {
            backToTopicsButton.addEventListener('click', () => {
                showSection('cursos');
                lessonQuizArea.classList.add('hidden');
                geminiOutputLessonDiv.classList.add('hidden');
            });
        }

        if (generateBlogIdeasButton) {
            generateBlogIdeasButton.addEventListener('click', async () => {
                if (!currentUser || currentUser.isAnonymous) {
                    showMessage("Debes iniciar sesión para generar ideas de blog.", 'error');
                    toggleModal(true);
                    return;
                }
                if (!blogIdeasOutput || !generatedIdeasList) {
                    console.error("Elementos del blog no encontrados.");
                    showMessage("Error: No se pueden generar ideas de blog.", 'error');
                    return;
                }

                blogIdeasOutput.classList.remove('hidden');
                generatedIdeasList.innerHTML = `<li><i class="fas fa-spinner fa-spin"></i> Generando ideas...</li>`;

                const prompt = `Genera 5 ideas de artículos para un blog educativo centrado en el aprendizaje, matemáticas, lengua, inglés, y herramientas para estudiantes con TDAH, IA en educación, y noticias interesantes en los diferentes campos trabajados en la pagina. Para cada idea, incluye un título y una breve descripción. Formatea la respuesta como una lista numerada en español.`;

                try {
                    const response = await fetch(`${GEMINI_API_BASE_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();

                    if (data.candidates && data.candidates.length > 0 &&
                        data.candidates[0].content && data.candidates[0].content.parts &&
                        Array.isArray(data.candidates[0].content.parts) &&
                        data.candidates[0].content.parts.length > 0) {
                        const generatedText = data.candidates[0].content.parts[0].text;
                        const ideasArray = generatedText.split('\n').filter(line => line.trim().length > 0);
                        let htmlIdeas = '';
                        ideasArray.forEach(idea => {
                            htmlIdeas += `<li>${idea.replace(/^\d+\.\s*/, '')}</li>`;
                        });
                        generatedIdeasList.innerHTML = htmlIdeas;
                        showMessage('Ideas de blog generadas.', 'success');
                    } else {
                        console.error("Estructura de respuesta de Gemini inesperada para ideas de blog:", data);
                        generatedIdeasList.innerHTML = `<li>Error al generar ideas. Por favor, inténtalo de nuevo.</li>`;
                        showMessage("Error al generar ideas de blog.", 'error');
                    }
                } catch (error) {
                    console.error("Error al generar ideas de blog:", error);
                    generatedIdeasList.innerHTML = `<li>Error al generar ideas. Por favor, inténtalo de nuevo.</li>`;
                    showMessage("Error al generar ideas de blog.", 'error');
                }
            });
        }


        document.querySelectorAll('.nav-link, #discover-blog-button').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const targetSectionId = this.dataset.targetSection;
                const subsectionId = this.dataset.subsection;
                showSection(targetSectionId, subsectionId);
                if (sidebarMenu && sidebarMenu.classList.contains('active')) {
                  sidebarMenu.classList.remove('active');
                }
            });
        });

        if (hamburgerMenuIcon) {
          hamburgerMenuIcon.addEventListener('click', () => {
            if (sidebarMenu) sidebarMenu.classList.add('active');
          });
        }
        if (closeSidebarMenu) {
          closeSidebarMenu.addEventListener('click', () => {
            if (sidebarMenu) sidebarMenu.classList.remove('active');
          });
        }
        document.addEventListener('click', (e) => {
          if (sidebarMenu && hamburgerMenuIcon && !sidebarMenu.contains(e.target) && !hamburgerMenuIcon.contains(e.target) && sidebarMenu.classList.contains('active')) {
            sidebarMenu.classList.remove('active');
          }
        });

        if (searchBarButton) {
          searchBarButton.addEventListener('click', () => {
            if (searchBarInput && searchBarInput.value.trim() !== '') {
              showMessage(`Buscando: "${searchBarInput.value.trim()}"`, 'info');
            } else {
              showMessage('Por favor, introduce un término de búsqueda.', 'info');
            }
          });
        }

        // Auto-play para el carrusel visual
        if (visualCarousel && totalCarouselImages > 1) { // Añadida comprobación de visualCarousel
          setInterval(() => {
            if (carouselImagesContainer) {
              if (currentCarouselIndex < totalCarouselImages - 1) {
                  currentCarouselIndex++;
              } else {
                  currentCarouselIndex = 0;
              }
              updateCarousel();
            }
          }, 5000);
        }

        // Auto-play para el carrusel de testimonios
        if (testimonialsSlidesContainer && totalTestimonials > 1) { // Añadida comprobación de testimonialsSlidesContainer
          setInterval(() => {
            if (testimonialsSlidesContainer) {
              if (currentTestimonialIndex < totalTestimonials - 1) {
                  currentTestimonialIndex++;
              } else {
                  currentTestimonialIndex = 0;
              }
              updateTestimonialsCarousel();
            }
          }, 7000);
        }

        if (chatbotFab) {
            chatbotFab.addEventListener('click', () => {
                loadChatbaseScript();
                showMessage("Cargando chatbot...", 'info');
            });
        }

        // Lógica de autenticación del segundo script (movida aquí)
        // Ya tienes un onAuthStateChanged en el ámbito superior, este es redundante y será eliminado.
        // auth.onAuthStateChanged((user) => { if (user) mostrarContenidoAutenticado(user); else ocultarContenidoAutenticado(); });

        // Ya tienes addEventListeners en esta función, los siguientes son redundantes.
        // loginForm.addEventListener("submit", async (e) => { ... });
        // logoutBtn.addEventListener("click", async () => { ... });
        // accessBtn.addEventListener("click", () => authModal.classList.add("active"));
        // closeModalBtn.addEventListener("click", () => authModal.classList.remove("active"));
        // document.getElementById("hamburger-menu-icon")?.addEventListener("click", () => { ... });
        // document.getElementById("close-sidebar-menu")?.addEventListener("click", () => { ... });
    }


    /**
     * Comprueba que todos los elementos DOM críticos estén disponibles.
     * @returns {boolean} - True si todos los elementos críticos existen, false de lo contrario.
     */
    function checkRequiredElements() {
        const criticalElements = [
            authModalOverlay, closeAuthModal, accessButton, logoutTopBarButton, hamburgerMenuIcon, sidebarMenu, closeSidebarMenu,
            loginFormDiv, registerFormDiv, recoverPasswordFormDiv, showRegisterFormButton, startGuestModeButton,
            loginEmailInput, loginPasswordInput, registerEmailInput, registerPasswordInput, recoverEmailInput,
            userDisplayName, customMessage, visualCarousel, dailyCuriosityElement, discoverBlogButton,
            quizPage, quizContainer, questionText, optionsDiv, submitQuizButton,
            quizResultsDisplayArea, resultMessage, tdahWarning, studyAdvice, backFromQuizButton,
            reviewForm, reviewTextarea, ratingStarsContainer, reviewsContainer, toggleReviewFormButton,
            lessonContentDisplay, lessonMaterialDiv, lessonTitleElement, backToTopicsButton, askGeminiLessonButton,
            completeLessonButton, geminiOutputLessonDiv, generateTopicTestButton, lessonQuizArea,
            currentLessonQuestion, currentLessonOptions, submitLessonQuizButton, lessonQuizFeedback,
            nextLessonQuizQuestionButton, restartLessonQuizButton, blogPage, blogIdeasOutput, generateBlogIdeasButton,
            generatedIdeasList, backFromBlogButton,
            mainContent, homeSections, cursosSection, reviewsAndContactSection, chatbotFab,
            testimonialsSlidesContainer, prevTestimonialBtn, nextTestimonialBtn, searchBarInput, searchBarButton,
            subjectsAndAISec // Incluir la variable aquí
        ];

        let allPresent = true;
        criticalElements.forEach((el, index) => {
            // Check for null or undefined. For NodeLists, check if they are not empty.
            // Para subjectToggleHeaders y topicSelectionButtons, son NodeLists, no elementos singulares.
            // No deben ser null, pero el?.length === 0 indica que no tienen elementos.
            if (el === null || typeof el === 'undefined' || (NodeList.prototype.isPrototypeOf(el) && el.length === 0)) {
                // Mejorar el log para identificar qué elemento falta
                console.error(`DEBUG ERROR: Elemento DOM crítico faltante o vacío: ${el ? el.id || el.className || el : 'undefined/null'}. Índice: ${index}.`);
                allPresent = false;
            }
        });
        return allPresent;
    }


    /**
     * Muestra un mensaje personalizado en la parte superior de la pantalla.
     * @param {string} message - El texto del mensaje.
     * @param {string} type - Tipo de mensaje ('info', 'success', 'error').
     * @param {number} duration - Duración en milisegundos que el mensaje estará visible.
     */
    function showMessage(message, type = 'info', duration = 3000) {
      if (!customMessage) {
          console.error("Elemento 'custom-message' no encontrado. No se puede mostrar el mensaje.");
          return;
      }
      customMessage.textContent = message;
      customMessage.className = 'show'; // Resetear clases
      if (type === 'error') {
        customMessage.style.backgroundColor = '#e74c3c'; // Rojo
      } else if (type === 'success') {
        customMessage.style.backgroundColor = 'var(--secondary-color)'; // Verde
      } else {
        customMessage.style.backgroundColor = 'var(--primary-color)'; // Azul
      }
      setTimeout(() => {
        customMessage.className = 'hidden';
      }, duration);
    }

    /**
     * Alterna la visibilidad del modal de autenticación.
     * @param {boolean} show - Verdadero para mostrar, falso para ocultar.
     * @param {string} formType - Tipo de formulario a mostrar ('login', 'register', 'recover').
     */
    function toggleModal(show, formType = 'login') {
      if (!authModalOverlay || !loginFormDiv || !registerFormDiv || !recoverPasswordFormDiv) {
          console.error("Elementos del modal de autenticación no encontrados.");
          return;
      }
      if (show) {
        authModalOverlay.classList.add('active');
        loginFormDiv.classList.add('hidden');
        registerFormDiv.classList.add('hidden');
        recoverPasswordFormDiv.classList.add('hidden');

        if (formType === 'register') {
            registerFormDiv.classList.remove('hidden');
            if (registerEmailInput) registerEmailInput.focus();
        } else if (formType === 'recover') {
            recoverPasswordFormDiv.classList.remove('hidden');
            if (recoverEmailInput) recoverEmailInput.focus();
        } else {
            loginFormDiv.classList.remove('hidden');
            if (loginEmailInput) loginEmailInput.focus();
        }
      } else {
        authModalOverlay.classList.remove('active');
      }
    }

    /**
     * Muestra el contenido autenticado del usuario (ej: nombre de usuario, habilita secciones).
     * Mover la lógica aquí es clave para que se ejecute DESPUÉS de que los elementos DOM estén asignados.
     * @param {Object} user - Objeto de usuario de Firebase.
     */
    function mostrarContenidoAutenticado(user) {
        // Asegurarse de que los elementos existan antes de manipularlos
        if (quizContainer) quizContainer.classList.remove("hidden");
        if (quizResultsDisplayArea) quizResultsDisplayArea.classList.remove("hidden"); // Asegúrate de que esta variable sea el elemento correcto
        if (blogPage) blogPage.classList.remove("hidden");
        if (lessonContentDisplay) lessonContentDisplay.classList.remove("hidden"); // Asegúrate de que esta variable sea el elemento correcto

        if (logoutTopBarButton) logoutTopBarButton.classList.remove("hidden");
        if (accessButton) accessButton.classList.add("hidden");

        if (userDisplayName) {
            userDisplayName.textContent = user.email || (user.isAnonymous ? "Usuario Anónimo" : "Usuario");
        }
        if (hamburgerMenuIcon) hamburgerMenuIcon.style.display = "block";
    }

    /**
     * Oculta el contenido y vuelve al estado de no autenticado.
     * Mover la lógica aquí es clave para que se ejecute DESPUÉS de que los elementos DOM estén asignados.
     */
    function ocultarContenidoAutenticado() {
        if (quizContainer) quizContainer.classList.add("hidden");
        if (quizResultsDisplayArea) quizResultsDisplayArea.classList.add("hidden");
        if (blogPage) blogPage.classList.add("hidden");
        if (lessonContentDisplay) lessonContentDisplay.classList.add("hidden");

        if (logoutTopBarButton) logoutTopBarButton.classList.add("hidden");
        if (accessButton) accessButton.classList.remove("hidden");

        if (userDisplayName) userDisplayName.textContent = "";
        if (hamburgerMenuIcon) hamburgerMenuIcon.style.display = "none";
    }


   /**
     * Función principal para controlar la visualización de las secciones.
     * Oculta todas las secciones principales y muestra solo la deseada.
     * @param {string} sectionIdToShow - El ID de la sección a mostrar ('home-sections', 'quiz-page', 'cursos', 'lesson-content-display', 'blog-page').
     * @param {string} [subsectionIdToScroll] - Opcional. ID de una subsección dentro de home-sections o de otra página a la que hacer scroll.
     */
    function showSection(sectionIdToShow, subsectionIdToScroll = null) {
        const allMainPages = [homeSections, quizPage, cursosSection, lessonContentDisplay, blogPage];

        allMainPages.forEach(page => {
            if (page) {
                page.classList.add('hidden');
            }
        });

        const targetPage = document.getElementById(sectionIdToShow);
        if (targetPage) {
            targetPage.classList.remove('hidden');

            // NUEVO: Llama a displayQuizQuestion() solo cuando accedes a la página del quiz
            if (sectionIdToShow === 'quiz-page') {
                // Reinicia el quiz si el usuario no lo ha completado o es un invitado
                if (!userQuizCompleted || currentUser.isAnonymous) {
                    currentQuizIndex = 0; // Reinicia el índice de preguntas
                    userAnswers = {}; // Borra respuestas anteriores si vuelve a empezar
                    // Asegúrate de que el contenedor del quiz y las preguntas estén visibles
                    if (quizContainer) quizContainer.classList.remove('hidden');
                    if (quizResultsDisplayArea) quizResultsDisplayArea.classList.add('hidden'); // Oculta resultados anteriores
                }
                displayQuizQuestion(); // Muestra la pregunta (o redirige si ya está completo)
            } else if (sectionIdToShow === 'home-sections') {
                if (document.getElementById('visual-presentation')) document.getElementById('visual-presentation').classList.remove('hidden');
                if (subjectsAndAISec) subjectsAndAISec.classList.remove('hidden');
                if (reviewsAndContactSection) reviewsAndContactSection.classList.remove('hidden');

                // Asegura que los resultados del quiz se muestren si el usuario está logueado y el quiz completado
                // y que el quizContainer (formulario de preguntas) se oculte
                if (quizResultsDisplayArea) {
                    quizResultsDisplayArea.classList.toggle('hidden', !(currentUser && userQuizCompleted && !currentUser.isAnonymous));
                }
                if (quizContainer) quizContainer.classList.add('hidden'); // Oculta el contenedor del quiz si estás en home-sections

                if (subsectionIdToScroll) {
                    const subTargetElement = document.getElementById(subsectionIdToScroll);
                    if (subTargetElement) {
                        setTimeout(() => {
                            subTargetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 50);
                    }
                } else {
                  targetPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                targetPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }   
        }
    }


    /**
     * Actualiza la visibilidad de los elementos de navegación y botones según el estado de autenticación.
     */
    function updateNavigationVisibility() {
      const isLoggedIn = currentUser !== null && !currentUser.isAnonymous; // Is logged in (non-anonymous)
      const isAnyUserLoggedIn = currentUser !== null; // Is any user logged in (anonymous or non-anonymous)

      // Top bar access/logout buttons
      if (accessButton) accessButton.classList.toggle('hidden', isLoggedIn);
      if (logoutTopBarButton) logoutTopBarButton.classList.toggle('hidden', !isLoggedIn);

      if (userDisplayName) {
        userDisplayName.classList.toggle('hidden', !isAnyUserLoggedIn);
        if (isAnyUserLoggedIn) {
          if (isLoggedIn) {
            userDisplayName.textContent = `Hola, ${currentUser.displayName || (currentUser.email ? currentUser.email.split('@')[0] : 'Usuario')}`;
          } else {
            userDisplayName.textContent = "Usuario Anónimo";
          }
        }
      }
      // Sidebar logout button
      const logoutButtonSidebar = document.getElementById('logout-button');
      if (logoutButtonSidebar) logoutButtonSidebar.classList.toggle('hidden', !isAnyUserLoggedIn);

      document.querySelectorAll('#sidebar-menu a').forEach(link => {
        const targetSection = link.dataset.targetSection;
        const subsectionId = link.dataset.subsection;
        let shouldBeDisabled = false;

        if (targetSection === 'quiz-page') {
            shouldBeDisabled = !isAnyUserLoggedIn;
        } else if (targetSection === 'home-sections' && subsectionId === 'quiz-results-display-area') {
            shouldBeDisabled = !(isLoggedIn && userQuizCompleted);
        } else if (targetSection === 'cursos' && subsectionId === 'avances-cursos') {
            shouldBeDisabled = !(isLoggedIn && userQuizCompleted);
        } else if (targetSection === 'blog-page') {
            shouldBeDisabled = false;
        }

        if (shouldBeDisabled) {
            link.classList.add('disabled');
            link.style.pointerEvents = 'none';
            link.style.opacity = '0.6';
        } else {
            link.classList.remove('disabled');
            link.style.pointerEvents = 'auto';
            link.style.opacity = '1';
        }
      });

      if (discoverBlogButton) {
        discoverBlogButton.style.pointerEvents = 'auto';
        discoverBlogButton.style.opacity = '1';
      }

      if (toggleReviewFormButton) {
        toggleReviewFormButton.style.pointerEvents = isLoggedIn ? 'auto' : 'none';
        toggleReviewFormButton.style.opacity = isLoggedIn ? '1' : '0.6';
      }
      if (generateBlogIdeasButton) {
        generateBlogIdeasButton.style.pointerEvents = isLoggedIn ? 'auto' : 'none';
        generateBlogIdeasButton.style.opacity = isLoggedIn ? '1' : '0.6';
      }
      if (!isLoggedIn && blogIdeasOutput) {
        blogIdeasOutput.classList.add('hidden');
      }

      document.querySelectorAll('.subject-topics-list').forEach(list => {
          list.classList.remove('active');
      });
      document.querySelectorAll('.subject-toggle-header').forEach(header => {
          header.classList.remove('expanded');
          // CAMBIO: Los títulos de las asignaturas ahora son clickeables solo si el usuario está logueado
          if (isLoggedIn) {
              header.style.pointerEvents = 'auto';
              header.style.opacity = '1';
          } else {
              header.style.pointerEvents = 'none';
              header.style.opacity = '0.6';
          }
      });
    }

    // --- Funcionalidad del Cuestionario (Modificada) ---
   function displayQuizQuestion() {
      console.log("DEBUG: Entrando en displayQuizQuestion. userQuizCompleted:", userQuizCompleted, "currentUser:", currentUser); // DEBUG

      if (!currentUser) {
          showMessage("Error: No se pudo obtener el estado del usuario. Intenta recargar la página.", 'error');
          return;
      }

      // CAMBIO IMPORTANTE: Solo redirige a resultados si el quiz ya está completado
      // Y si NO estamos en la primera pregunta (para evitar bucle si se llama al inicio)
      if (currentUser && !currentUser.isAnonymous && userQuizCompleted) {
          showMessage('Ya has completado el cuestionario de estilo de aprendizaje. Puedes revisar tus resultados o explorar otras funciones.', 'info', 4000);
          updateQuizResultDisplay();
          showSection('home-sections', 'quiz-results-display-area'); // Redirige a resultados
          return;
      }

      if (!quizContainer || !questionText || !optionsDiv || !submitQuizButton) {
        console.error("Elementos del cuestionario no encontrados.");
        showMessage("Error: No se pudo cargar el cuestionario. Faltan elementos clave.", 'error');
        return;
      }

      // Asegúrate de que el quizContainer sea visible cuando se llama esta función
      quizContainer.classList.remove('hidden');
      if (resultMessageQuizPage) resultMessageQuizPage.classList.add('hidden');
      if (tdahWarningQuizPage) tdahWarningQuizPage.classList.add('hidden');
      if (studyAdviceQuizPage) studyAdviceQuizPage.classList.add('hidden');

      if (submitQuizButton) submitQuizButton.classList.add('hidden');

      if (currentQuizIndex >= quizData.length) {
        questionText.textContent = `¡Has completado el test! Haz clic en 'Enviar Respuestas' para ver tu resultado.`;
        optionsDiv.innerHTML = '';
        submitQuizButton.classList.remove('hidden');
        return;
      }

      const currentQ = quizData[currentQuizIndex];
      questionText.textContent = currentQ.question;
      optionsDiv.innerHTML = '';

      currentQ.options.forEach((option, index) => {
        const btn = document.createElement('button');
        btn.textContent = option;
        btn.dataset.index = index;
        btn.addEventListener('click', (e) => selectAnswer(e.target.dataset.index));
        btn.setAttribute('aria-label', option);
        optionsDiv.appendChild(btn);
      });

      if (userAnswers[currentQuizIndex] !== undefined) {
          const selectedBtn = optionsDiv.querySelector(`button[data-index="${userAnswers[currentQuizIndex]}"]`);
          if (selectedBtn) selectedBtn.classList.add('selected');
      }
    }

    function selectAnswer(optionIndex) {
      if (!optionsDiv) return;
      userAnswers[currentQuizIndex] = parseInt(optionIndex);

      optionsDiv.querySelectorAll('button').forEach((button, index) => {
        if (index === parseInt(optionIndex)) {
            button.classList.add('selected');
        } else {
            button.classList.remove('selected');
        }
      });

      setTimeout(() => {
          currentQuizIndex++;
          displayQuizQuestion();
      }, 300);
    }

    function updateQuizResultDisplay() {
      const styleNames = {
          visual: "Visual",
          auditivo: "Auditivo",
          'lectura-escritura': "Lectura/Escritura",
          kinestesico: "Kinestésico"
      };

      if (!resultMessage || !tdahWarning || !studyAdvice || !quizResultsDisplayArea ||
          !resultMessageQuizPage || !tdahWarningQuizPage || !studyAdviceQuizPage) {
        console.warn("Elementos de visualización de resultados del quiz no encontrados. Saltando la actualización.");
        return;
      }

      if (currentUser && !currentUser.isAnonymous && userQuizCompleted) {
          resultMessage.textContent = `🎯 Tu estilo de aprendizaje principal: ${styleNames[userLearningStyle]}.`;
          resultMessage.className = 'result-card';
          resultMessage.style.backgroundColor = '#e6f7ff';
          resultMessage.style.borderLeft = '5px solid var(--primary-color)';

          const adviceByStyle = {
              visual: "Te recomendamos usar esquemas, mapas conceptuales, videos y colores para organizar tus ideas. Aprovecha imágenes y gráficos para estudiar de forma efectiva.",
              auditivo: "Aprenderás mejor con grabaciones, podcasts, explicaciones en voz alta y repitiendo la información oralmente. Considera escuchar tus apuntes.",
              'lectura-escritura': "Tu fortaleza es procesar información a través de la lectura de textos, la toma de notas detalladas y la escritura de resúmenes. Organiza tus ideas por escrito.",
              kinestesico: "Para ti, es ideal aprender haciendo. Prefieres actividades prácticas, experimentos y el movimiento físico durante el estudio para asimilar el conocimiento."
          };
          studyAdvice.textContent = `Consejo de estudio para tu estilo: ${adviceByStyle[userLearningStyle] || "No se encontró un consejo específico para tu estilo de aprendizaje."}`;
          studyAdvice.className = 'result-card';
          studyAdvice.style.backgroundColor = '#e6ffe6';
          studyAdvice.style.borderLeft = '5px solid var(--secondary-color)';

          resultMessage.classList.remove('hidden');
          studyAdvice.classList.remove('hidden');

          if (userTDAHStatus === 'tdah') {
              tdahWarning.textContent = `⚠️ Ten en cuenta: Se han detectado indicadores de TDAH. Te recomendamos buscar apoyo profesional y considerar estrategias de estudio especializadas.`;
              tdahWarning.classList.remove('hidden');
              tdahWarning.className = 'result-card';
              tdahWarning.style.backgroundColor = '#fffacd';
              tdahWarning.style.borderLeft = '5px solid var(--accent-color)';
          } else {
              tdahWarning.classList.add('hidden');
          }

          quizResultsDisplayArea.classList.remove('hidden');

          resultMessageQuizPage.textContent = resultMessage.textContent;
          resultMessageQuizPage.className = resultMessage.className;
          resultMessageQuizPage.style.backgroundColor = resultMessage.style.backgroundColor;
          resultMessageQuizPage.style.borderLeft = resultMessage.style.borderLeft;
          resultMessageQuizPage.classList.remove('hidden');

          tdahWarningQuizPage.textContent = tdahWarning.textContent;
          tdahWarningQuizPage.className = tdahWarning.className;
          tdahWarningQuizPage.style.backgroundColor = tdahWarning.style.backgroundColor;
          tdahWarningQuizPage.style.borderLeft = tdahWarning.style.borderLeft;
          if (userTDAHStatus === 'tdah') { tdahWarningQuizPage.classList.remove('hidden'); } else { tdahWarningQuizPage.classList.add('hidden'); }

          studyAdviceQuizPage.textContent = studyAdvice.textContent;
          studyAdviceQuizPage.className = studyAdvice.className;
          studyAdviceQuizPage.style.backgroundColor = studyAdvice.style.backgroundColor;
          studyAdviceQuizPage.style.borderLeft = studyAdvice.style.borderLeft;
          studyAdviceQuizPage.classList.remove('hidden');

      } else {
          resultMessage.classList.add('hidden');
          tdahWarning.classList.add('hidden');
          studyAdvice.classList.add('hidden');
          quizResultsDisplayArea.classList.add('hidden');

          resultMessageQuizPage.classList.add('hidden');
          tdahWarningQuizPage.classList.add('hidden');
          studyAdviceQuizPage.classList.add('hidden');
      }

      if (quizContainer && quizPage.classList.contains('hidden') && userQuizCompleted) {
          quizContainer.classList.add('hidden');
      }
      if (submitQuizButton) submitQuizButton.classList.add('hidden');
      if (userQuizCompleted) {
          if (questionText) questionText.textContent = '';
          if (optionsDiv) optionsDiv.innerHTML = '';
      }
    }


    // --- Sistema de Reseñas ---
    function updateReviewFormVisibility() {
      if (reviewForm && toggleReviewFormButton) {
        if (currentUser && !currentUser.isAnonymous) {
          toggleReviewFormButton.classList.remove('hidden');
        } else {
          reviewForm.classList.add('hidden');
          toggleReviewFormButton.classList.add('hidden');
        }
      }
    }

    async function loadReviews() {
      if (!db || !reviewsContainer) {
        console.warn("Firestore o contenedor de reseñas no inicializado. No se pueden cargar las reseñas.");
        if (reviewsContainer) reviewsContainer.innerHTML = '<p class="text-center" style="color: var(--text-light);">No se pueden cargar las reseñas. Firebase no está configurado.</p>';
        return;
      }
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);

      onSnapshot(query(reviewsCollectionRef, orderBy("timestamp", "desc")), (snapshot) => {
        if (reviewsContainer) reviewsContainer.innerHTML = '';
        if (snapshot.empty) {
          if (reviewsContainer) reviewsContainer.innerHTML = '<p class="text-center" style="color: var(--text-light);">Aún no hay reseñas. ¡Sé el primero en dejar una!</p>';
          return;
        }
        snapshot.forEach((doc) => {
          const review = doc.data();
          const reviewCard = document.createElement('div');
          reviewCard.classList.add('review-card');
          let starsHtml = '';
          for (let i = 0; i < review.rating; i++) {
            starsHtml += '★';
          }
          reviewCard.innerHTML = `
            <p class="reviewer-name">${review.userName}</p>
            <p class="review-text">"${review.reviewText}"</p>
            <div class="review-rating">${starsHtml}</div>
          `;
          if (reviewsContainer) reviewsContainer.appendChild(reviewCard);
        });
      }, (error) => {
        console.error("Error cargando reseñas: ", error);
        if (reviewsContainer) reviewsContainer.innerHTML = '<p class="text-center" style="color: var(--text-light);">Error al cargar las reseñas.</p>';
      });
    }

    // --- Seguimiento de Progreso (Firestore) ---
    async function saveUserPreferences() {
        if (!currentUser || currentUser.isAnonymous || !db) {
            console.error("No user ID or Firestore not initialized to save preferences. User is not authenticated or is anonymous.");
            showMessage("Por favor, inicia sesión para guardar tus preferencias.", 'error', 3000);
            return;
        }
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userPreferencesRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/preferences`, "quizResult");
        try {
            await setDoc(userPreferencesRef, {
                learningStyle: userLearningStyle,
                tdahStatus: userTDAHStatus,
                quizCompleted: true,
                lastUpdated: serverTimestamp()
            }, { merge: true });
            userQuizCompleted = true;
            console.log("User preferences saved to Firestore.");
            updateNavigationVisibility();
        }
        catch (e) {
            console.error("Error saving user preferences: ", e);
            showMessage("Error al guardar tus preferencias.", 'error', 3000);
        }
    }

    async function loadUserPreferences(uid) {
        if (!db) {
            console.warn("Firestore no inicializado. No se pueden cargar las preferencias del usuario.");
            return;
        }
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userPreferencesRef = doc(db, `artifacts/${appId}/users/${uid}/preferences`, "quizResult");
        try {
            const userSnap = await getDoc(userPreferencesRef);
            if (userSnap.exists()) {
                const data = userSnap.data();
                userLearningStyle = data.learningStyle || 'visual';
                userTDAHStatus = data.tdahStatus || 'no';
                userQuizCompleted = data.quizCompleted || false;
                console.log("User preferences loaded from Firestore:", data);
            } else {
                console.log("No user preferences found in Firestore. User is new or quiz not completed.");
                userQuizCompleted = false;
                userLearningStyle = 'visual';
                userTDAHStatus = 'no';
            }
        } catch (e) {
            console.error("Error loading user preferences: ", e);
            showMessage("Error al cargar tus preferencias.", 'error', 3000);
        }
    }

    async function loadProgressAndDisplay() {
      if (currentUser && !currentUser.isAnonymous && db) {
        const userId = currentUser.uid;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        try {
          const progressCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/progress`);
          const querySnapshot = await getDocs(progressCollectionRef);
          topicsData = {};
          querySnapshot.forEach((doc) => {
              topicsData[doc.id] = doc.data().percentage;
          });
          updateAllProgressBars();
        } catch (error) {
          console.error("Error cargando datos de progreso:", error);
          topicsData = {};
          updateAllProgressBars();
        }
      } else {
        topicsData = {};
        updateAllProgressBars();
      }
    }

    async function updateProgress(topicId, progressPercentage) {
      if (currentUser && !currentUser.isAnonymous && db) {
        const userId = currentUser.uid;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        topicsData[topicId] = progressPercentage;
        const progressDocRef = doc(db, `artifacts/${appId}/users/${userId}/progress`, topicId);
        try {
          await setDoc(progressDocRef, { percentage: progressPercentage, lastUpdated: serverTimestamp() }, { merge: true });
          updateAllProgressBars();
        } catch (error) {
          console.error("Error actualizando progreso:", error);
          showMessage("Error al guardar tu progreso.", 'error');
        }
      } else {
        showMessage("Debes iniciar sesión para guardar tu progreso.", 'error');
      }
    }

    function updateAllProgressBars() {
      const allTopicItems = document.querySelectorAll('.topic-item');
      allTopicItems.forEach(item => {
        const topicId = item.dataset.topicId;
        const progress = topicsData[topicId] || 0;
        const progressBarFill = item.querySelector('.progress-bar-fill');
        const progressIndicator = item.querySelector('.progress-indicator');
        const progressText = item.querySelector('.progress-text');

        if (progressBarFill && progressIndicator && progressText) {
          progressBarFill.style.width = `${progress}%`;
          progressIndicator.textContent = `Progreso: ${progress}%`;
          progressText.textContent = `${progress}% Completado`;
        }
      });
    }

    // Lesson-based Quiz Functions
    function displayLessonQuizQuestion() {
        if (!currentLessonQuizData || currentLessonQuizData.length === 0) {
            if (lessonQuizArea) lessonQuizArea.classList.add('hidden');
            return;
        }

        const question = currentLessonQuizData[currentLessonQuizQuestionIndex];
        if (!question) {
            if (currentLessonQuestion) currentLessonQuestion.textContent = "¡Test completado!";
            if (currentLessonOptions) currentLessonOptions.innerHTML = '';
            if (submitLessonQuizButton) submitLessonQuizButton.classList.add('hidden');
            if (nextLessonQuizQuestionButton) nextLessonQuizQuestionButton.classList.add('hidden');
            if (lessonQuizFeedback) lessonQuizFeedback.classList.add('hidden');
            if (restartLessonQuizButton) restartLessonQuizButton.classList.remove('hidden');
            return;
        }

        if (currentLessonQuestion) currentLessonQuestion.textContent = question.question;
        if (currentLessonOptions) currentLessonOptions.innerHTML = '';
        selectedLessonQuizAnswer = null;
        if (lessonQuizFeedback) lessonQuizFeedback.classList.add('hidden');
        if (submitLessonQuizButton) submitLessonQuizButton.classList.remove('hidden');
        if (nextLessonQuizQuestionButton) nextLessonQuizQuestionButton.classList.add('hidden');
        if (restartLessonQuizButton) restartLessonQuizButton.classList.add('hidden');

        question.options.forEach((option, index) => {
            const btn = document.createElement('button');
            btn.textContent = option;
            btn.dataset.index = index;
            btn.addEventListener('click', () => {
                if (currentLessonOptions) {
                    currentLessonOptions.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
                }
                btn.classList.add('selected');
                selectedLessonQuizAnswer = index;
            });
            if (currentLessonOptions) currentLessonOptions.appendChild(btn);
        });
    }

    // --- Carrusel de Imágenes (Sección 3) ---
    function updateCarousel() {
      if (carouselImagesContainer) {
        carouselImagesContainer.style.transform = `translateX(${-currentCarouselIndex * 100}%)`;
      }
    }

    // --- Carrusel de Testimonios (Sección 5) ---
    function updateTestimonialsCarousel() {
      if (testimonialsSlidesContainer) {
        testimonialsSlidesContainer.style.transform = `translateX(${-currentTestimonialIndex * 100}%)`;
      }
    }

    function updateDailyCuriosity() {
        if (dailyCuriosityElement) {
            dailyCuriosityElement.textContent = dailyCuriosities[currentCuriosityIndex];
            currentCuriosityIndex = (currentCuriosityIndex + 1) % dailyCuriosities.length;
        }
    }

    // Chatbot Integration
    window.chatbaseConfig = {
      chatbotId: "frw3UKvg6MK3c9Zw-bZAu"
    };

    function loadChatbaseScript() {
      if (document.querySelector('script[src="https://www.chatbase.co/embed.min.js"]')) {
          console.log("Chatbase script already loaded.");
          return;
      }
      const script = document.createElement('script');
      script.src = "https://www.chatbase.co/embed.min.js";
      script.defer = true;
      script.onload = () => console.log("Chatbase script loaded.");
      script.onerror = () => console.error("Error loading Chatbase script.");
      document.body.appendChild(script);
    }

    // --- Inicialización al Cargar la Ventana ---
    window.onload = async function() {
        try {
            // Default Firebase configuration (your project's config)
            const defaultFirebaseConfig = {
              apiKey: "AIzaSyDklyhhZOV3c2KbbrvAZOpoUitPBWgRBOQ", // <<--- REEMPLAZA CON TU CLAVE API DE FIREBASE
              authDomain: "multigenio-39890.firebaseapp.com",
              projectId: "multigenio-39890",
              storageBucket: "multigenio-39890.firebasestorage.app",
              messagingSenderId: "881137429405",
              appId: "1:881137429405:web:9f061138bdf43b00dd5d74",
              measurementId: "G-9SQX18GVH6"
            };

            let firebaseConfigToUse; // Variable para la configuración final

            // Decide qué configuración de Firebase usar
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    firebaseConfigToUse = JSON.parse(__firebase_config);
                    console.log("DEBUG: Usando configuración de Firebase del entorno Canvas.");
                } catch (e) {
                    console.error("ERROR DEBUG: Falló el parseo de __firebase_config, usando la configuración por defecto.", e);
                    firebaseConfigToUse = defaultFirebaseConfig;
                }
            } else {
                firebaseConfigToUse = defaultFirebaseConfig;
                console.warn("DEBUG: Firebase config (__firebase_config) no encontrada o vacía. Usando configuración por defecto.");
            }

            // Inicializar servicios de Firebase
            try {
                if (firebaseConfigToUse.apiKey && firebaseConfigToUse.projectId) {
                    app = initializeApp(firebaseConfigToUse); // Asignación a la variable global 'app'
                    analytics = getAnalytics(app); // Asignación a la variable global 'analytics'
                    auth = getAuth(app); // Asignación a la variable global 'auth'
                    db = getFirestore(app); // Asignación a la variable global 'db'
                    console.log("DEBUG: Firebase inicializado correctamente.");
                } else {
                    console.error("DEBUG: La configuración de Firebase está incompleta o es inválida. Saltando la inicialización de Firebase.");
                    showMessage("Configuración de Firebase faltante o inválida. Las funciones de guardado no estarán disponibles.", 'error', 10000);
                }
            } catch (e) {
                console.error("DEBUG: Error al inicializar Firebase:", e);
                showMessage("Error grave al inicializar Firebase. Consulta la consola para más detalles.", 'error', 10000);
                app = null; analytics = null; auth = null; db = null; // Asegurar que estén null si falla
            }


            // Ahora que Firebase está inicializado, asignamos los elementos DOM y adjuntamos los listeners
            assignDOMElementsAndAttachListeners();

            // Luego, verifica si los elementos críticos están presentes
            const elementsReady = checkRequiredElements();
            if (!elementsReady) {
                console.error("DEBUG ERROR: Faltan elementos DOM críticos. La inicialización puede ser incompleta. Algunas funcionalidades no estarán disponibles.");
                showMessage("Error crítico al cargar la aplicación. Algunos elementos no están disponibles.", 'error', 10000);
            }

            // Establecer persistencia para Firebase Auth
            if (auth) {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    console.log("DEBUG: Persistencia de Firebase establecida a LOCAL.");
                } catch (error) {
                    console.error("DEBUG: Error al establecer la persistencia:", error);
                }

                // Listener del estado de autenticación (ahora que auth está disponible y persistencia seteada)
                onAuthStateChanged(auth, async (user) => {
                    currentUser = user;
                    if (user) {
                        console.log("DEBUG: Usuario autenticado en onAuthStateChanged:", user.uid, user.email || "Anónimo");
                        if (!user.isAnonymous && db) { // Solo carga preferencias para usuarios no anónimos
                            await loadUserPreferences(user.uid);
                        }
                        toggleModal(false);
                    } else {
                        console.log("DEBUG: No hay usuario autenticado en onAuthStateChanged.");
                        userLearningStyle = 'visual'; // Reset defaults on logout
                        userTDAHStatus = 'no';
                        userQuizCompleted = false;
                        topicsData = {};
                        currentQuizIndex = 0;
                        userAnswers = {};
                        if (quizResultsDisplayArea) quizResultsDisplayArea.classList.add('hidden');
                    }
                    // Estas actualizaciones deben ocurrir después de que el estado del usuario y las preferencias se carguen/restablezcan
                    updateNavigationVisibility();
                    updateReviewFormVisibility();
                    updateQuizResultDisplay();
                    loadProgressAndDisplay();
                });

                // Intento de inicio de sesión inicial (anónimo o con token personalizado)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("DEBUG: Sesión iniciada con token personalizado del entorno Canvas.");
                    } catch (error) {
                        console.error("DEBUG: Error al iniciar sesión con token personalizado de Canvas, intentando anónimo:", error);
                        await signInAnonymously(auth);
                        console.log("DEBUG: Sesión iniciada anónimamente como respaldo.");
                    }
                } else {
                    // Si no hay token inicial, intenta iniciar sesión anónimamente.
                    // Esto solo se hará si onAuthStateChanged no detecta ya una sesión persistente.
                    // await signInAnonymously(auth); // Descomentar si quieres forzar inicio anónimo siempre al cargar sin token
                    // console.log("DEBUG: Sesión iniciada anónimamente (no se encontró token personalizado inicial).");
                }
            } else {
                console.warn("DEBUG: Firebase Auth no inicializado. La autenticación será limitada o no disponible.");
                currentUser = { uid: 'guest', isAnonymous: true, email: null, displayName: 'Invitado' };
                updateNavigationVisibility();
            }

            if (db) {
                loadReviews();
            } else {
                console.warn("DEBUG: Firestore no inicializado. Saltando la carga de reseñas.");
            }

            showSection('home-sections');

            if (visualCarousel) updateCarousel();
            if (testimonialsSlidesContainer) updateTestimonialsCarousel();

            updateDailyCuriosity();
            dailyCuriosityInterval = setInterval(updateDailyCuriosity, 10000);

        } catch (onloadError) {
            console.error("ERROR CRÍTICO: Error no capturado durante window.onload:", onloadError);
            showMessage("Ha ocurrido un error inesperado al cargar la página. Por favor, inténtalo de nuevo o contacta con soporte.", 'error', 10000);
            if (document.body) {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: #e74c3c; font-size: 1.5em; background-color: #fcecec; border: 1px solid #e74c3c; border-radius: 8px; margin: 20px;">Error crítico al cargar la aplicación. Por favor, recarga la página.</div>';
            }
        }
    };
  </script>
</body>
</html>
